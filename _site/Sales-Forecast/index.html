<footer id="attribution" style="float:right; color:#999; background:#fff;">
Created by Thibault Dody, 05/10/2019.
</footer>

<h1 id="predict-future-sales">Predict Future Sales</h1>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/header.png" style="height=288px;" />
</figure>

<p>Final project for “How to win a data science competition” Coursera course</p>

<h1>Table of Contents<span class="tocSkip"></span></h1>
<div class="toc"><ul class="toc-item"><li><span><a href="#Introduction" data-toc-modified-id="Introduction-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>Introduction</a></span><ul class="toc-item"><li><span><a href="#Data-Structure" data-toc-modified-id="Data-Structure-1.1"><span class="toc-item-num">1.1&nbsp;&nbsp;</span>Data Structure</a></span></li><li><span><a href="#Objective" data-toc-modified-id="Objective-1.2"><span class="toc-item-num">1.2&nbsp;&nbsp;</span>Objective</a></span></li></ul></li><li><span><a href="#Load-Libraries-and-Dataset" data-toc-modified-id="Load-Libraries-and-Dataset-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>Load Libraries and Dataset</a></span><ul class="toc-item"><li><span><a href="#Sales-Dataset" data-toc-modified-id="Sales-Dataset-2.1"><span class="toc-item-num">2.1&nbsp;&nbsp;</span>Sales Dataset</a></span></li><li><span><a href="#Item-Dataset" data-toc-modified-id="Item-Dataset-2.2"><span class="toc-item-num">2.2&nbsp;&nbsp;</span>Item Dataset</a></span></li><li><span><a href="#Item-Categories-Dataset" data-toc-modified-id="Item-Categories-Dataset-2.3"><span class="toc-item-num">2.3&nbsp;&nbsp;</span>Item Categories Dataset</a></span></li><li><span><a href="#Shop-Dataset" data-toc-modified-id="Shop-Dataset-2.4"><span class="toc-item-num">2.4&nbsp;&nbsp;</span>Shop Dataset</a></span></li></ul></li><li><span><a href="#Database-schema" data-toc-modified-id="Database-schema-3"><span class="toc-item-num">3&nbsp;&nbsp;</span>Database schema</a></span></li><li><span><a href="#Verification-and-Probing" data-toc-modified-id="Verification-and-Probing-4"><span class="toc-item-num">4&nbsp;&nbsp;</span>Verification and Probing</a></span></li><li><span><a href="#Exploratory-Data-Analysis-(EDA)" data-toc-modified-id="Exploratory-Data-Analysis-(EDA)-5"><span class="toc-item-num">5&nbsp;&nbsp;</span>Exploratory Data Analysis (EDA)</a></span><ul class="toc-item"><li><span><a href="#Data-Types" data-toc-modified-id="Data-Types-5.1"><span class="toc-item-num">5.1&nbsp;&nbsp;</span>Data Types</a></span></li><li><span><a href="#EDA-Numerical-Features" data-toc-modified-id="EDA-Numerical-Features-5.2"><span class="toc-item-num">5.2&nbsp;&nbsp;</span>EDA Numerical Features</a></span></li><li><span><a href="#EDA-Categorical-Features" data-toc-modified-id="EDA-Categorical-Features-5.3"><span class="toc-item-num">5.3&nbsp;&nbsp;</span>EDA Categorical Features</a></span></li><li><span><a href="#Monthly-Data" data-toc-modified-id="Monthly-Data-5.4"><span class="toc-item-num">5.4&nbsp;&nbsp;</span>Monthly Data</a></span></li></ul></li><li><span><a href="#Feature-Engineering" data-toc-modified-id="Feature-Engineering-6"><span class="toc-item-num">6&nbsp;&nbsp;</span>Feature Engineering</a></span><ul class="toc-item"><li><span><a href="#Downcast" data-toc-modified-id="Downcast-6.1"><span class="toc-item-num">6.1&nbsp;&nbsp;</span>Downcast</a></span></li><li><span><a href="#New-Features-and-Encoding" data-toc-modified-id="New-Features-and-Encoding-6.2"><span class="toc-item-num">6.2&nbsp;&nbsp;</span>New Features and Encoding</a></span></li><li><span><a href="#Lags" data-toc-modified-id="Lags-6.3"><span class="toc-item-num">6.3&nbsp;&nbsp;</span>Lags</a></span></li></ul></li><li><span><a href="#Train-/-Test-Split" data-toc-modified-id="Train-/-Test-Split-7"><span class="toc-item-num">7&nbsp;&nbsp;</span>Train / Test Split</a></span><ul class="toc-item"><li><span><a href="#Purge-Features" data-toc-modified-id="Purge-Features-7.1"><span class="toc-item-num">7.1&nbsp;&nbsp;</span>Purge Features</a></span></li><li><span><a href="#Make-Splits" data-toc-modified-id="Make-Splits-7.2"><span class="toc-item-num">7.2&nbsp;&nbsp;</span>Make Splits</a></span></li><li><span><a href="#Validate-Split-Strategy" data-toc-modified-id="Validate-Split-Strategy-7.3"><span class="toc-item-num">7.3&nbsp;&nbsp;</span>Validate Split Strategy</a></span></li></ul></li><li><span><a href="#Models" data-toc-modified-id="Models-8"><span class="toc-item-num">8&nbsp;&nbsp;</span>Models</a></span><ul class="toc-item"><li><span><a href="#Feature-Importance" data-toc-modified-id="Feature-Importance-8.1"><span class="toc-item-num">8.1&nbsp;&nbsp;</span>Feature Importance</a></span></li><li><span><a href="#Target-Distribution" data-toc-modified-id="Target-Distribution-8.2"><span class="toc-item-num">8.2&nbsp;&nbsp;</span>Target Distribution</a></span></li><li><span><a href="#First-Level-Models" data-toc-modified-id="First-Level-Models-8.3"><span class="toc-item-num">8.3&nbsp;&nbsp;</span>First Level Models</a></span><ul class="toc-item"><li><span><a href="#Scaling-and-Encoding" data-toc-modified-id="Scaling-and-Encoding-8.3.1"><span class="toc-item-num">8.3.1&nbsp;&nbsp;</span>Scaling and Encoding</a></span></li><li><span><a href="#Simple-Model-Selection" data-toc-modified-id="Simple-Model-Selection-8.3.2"><span class="toc-item-num">8.3.2&nbsp;&nbsp;</span>Simple Model Selection</a></span></li><li><span><a href="#Ridge-Regression" data-toc-modified-id="Ridge-Regression-8.3.3"><span class="toc-item-num">8.3.3&nbsp;&nbsp;</span>Ridge Regression</a></span></li><li><span><a href="#Lasso" data-toc-modified-id="Lasso-8.3.4"><span class="toc-item-num">8.3.4&nbsp;&nbsp;</span>Lasso</a></span></li><li><span><a href="#Bayesian-Ridge" data-toc-modified-id="Bayesian-Ridge-8.3.5"><span class="toc-item-num">8.3.5&nbsp;&nbsp;</span>Bayesian Ridge</a></span></li><li><span><a href="#Random-Forest" data-toc-modified-id="Random-Forest-8.3.6"><span class="toc-item-num">8.3.6&nbsp;&nbsp;</span>Random Forest</a></span></li><li><span><a href="#LightGBM" data-toc-modified-id="LightGBM-8.3.7"><span class="toc-item-num">8.3.7&nbsp;&nbsp;</span>LightGBM</a></span></li><li><span><a href="#XGBoost" data-toc-modified-id="XGBoost-8.3.8"><span class="toc-item-num">8.3.8&nbsp;&nbsp;</span>XGBoost</a></span></li><li><span><a href="#Final-Models" data-toc-modified-id="Final-Models-8.3.9"><span class="toc-item-num">8.3.9&nbsp;&nbsp;</span>Final Models</a></span></li></ul></li><li><span><a href="#Meta-Model" data-toc-modified-id="Meta-Model-8.4"><span class="toc-item-num">8.4&nbsp;&nbsp;</span>Meta Model</a></span><ul class="toc-item"><li><span><a href="#Meta-Model-without-Existing-Features" data-toc-modified-id="Meta-Model-without-Existing-Features-8.4.1"><span class="toc-item-num">8.4.1&nbsp;&nbsp;</span>Meta Model without Existing Features</a></span></li><li><span><a href="#Meta-Model-with-Existing-Features" data-toc-modified-id="Meta-Model-with-Existing-Features-8.4.2"><span class="toc-item-num">8.4.2&nbsp;&nbsp;</span>Meta Model with Existing Features</a></span></li></ul></li><li><span><a href="#Submission-and-Conclusion" data-toc-modified-id="Submission-and-Conclusion-8.5"><span class="toc-item-num">8.5&nbsp;&nbsp;</span>Submission and Conclusion</a></span></li></ul></li></ul></div>

<hr />
<p><a id="Section_1"></a></p>
<h2 id="introduction">Introduction</h2>

<p>This challenge serves as final project for the “How to win a data science competition” Coursera course.</p>

<p>In this competition you will work with a challenging time-series dataset consisting of daily sales data, kindly provided by one of the largest Russian software firms - 1C Company.</p>

<p>We are asking you to predict total sales for every product and store in the next month. By solving this competition you will be able to apply and enhance your data science skills.</p>

<p>The full project description and dataset can be found <a href="https://www.kaggle.com/c/competitive-data-science-predict-future-sales">here</a>.</p>

<hr />
<p><a id="Section_2"></a></p>
<h1 id="data-and-competition">Data and Competition</h1>

<p><a id="Section_21"></a></p>
<h3 id="data-structure">Data Structure</h3>

<p>We are provided with daily historical sales data. The task is to <strong>forecast the total amount of products sold in every shop for the test set</strong>. Note that the list of shops and products slightly changes every month. Creating a robust model that can handle such situations is part of the challenge.</p>

<p><strong>File descriptions</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">sales_train.csv</code> - the training set. Daily historical data from January 2013 to October 2015.</li>
  <li><code class="language-plaintext highlighter-rouge">test.csv</code> - the test set. You need to forecast the sales for these shops and products for November 2015.</li>
  <li><code class="language-plaintext highlighter-rouge">sample_submission.csv</code> - a sample submission file in the correct format.</li>
  <li><code class="language-plaintext highlighter-rouge">items.csv - supplemental</code> information about the items/products.</li>
  <li><code class="language-plaintext highlighter-rouge">item_categories.csv</code>  - supplemental information about the items categories.</li>
  <li><code class="language-plaintext highlighter-rouge">shops.csv</code>- supplemental information about the shops.</li>
</ul>

<p><strong>Data fields</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">ID</code> - an Id that represents a (Shop, Item) tuple within the test set</li>
  <li><code class="language-plaintext highlighter-rouge">shop_id</code> - unique identifier of a shop</li>
  <li><code class="language-plaintext highlighter-rouge">item_id</code> - unique identifier of a product</li>
  <li><code class="language-plaintext highlighter-rouge">item_category_id</code> - unique identifier of item category</li>
  <li><code class="language-plaintext highlighter-rouge">item_cnt_day</code> - number of products sold. You are predicting a monthly amount of this measure</li>
  <li><code class="language-plaintext highlighter-rouge">item_price</code> - current price of an item</li>
  <li><code class="language-plaintext highlighter-rouge">date - date</code> in format dd/mm/yyyy</li>
  <li><code class="language-plaintext highlighter-rouge">date_block_num</code> - a consecutive month number, used for convenience. January 2013 is 0, February 2013 is 1,…, October 2015 is 33</li>
  <li><code class="language-plaintext highlighter-rouge">item_name</code> - name of item</li>
  <li><code class="language-plaintext highlighter-rouge">shop_name</code> - name of shop</li>
  <li><code class="language-plaintext highlighter-rouge">item_category_name</code> - name of item category</li>
</ul>

<h3 id="objective">Objective</h3>

<p>The goal of this competition is to predict the total amount of products sold in every shop for the test set. The list of shops and products changes each month. Submissions are evaluated by root mean squared error (RMSE). True target values are clipped into [0,20] range.</p>

<hr />
<p><a id="Section_3"></a></p>
<h2 id="load-libraries-and-dataset">Load Libraries and Dataset</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="sh">'</span><span class="s">ggplot</span><span class="sh">'</span><span class="p">)</span>

<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span>
<span class="kn">from</span> <span class="n">ipywidgets</span> <span class="kn">import</span> <span class="n">IntProgress</span>

<span class="kn">import</span> <span class="n">pickle</span>
<span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span> <span class="n">gc</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">LabelEncoder</span>

<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="n">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">SelectFromModel</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="n">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">ElasticNet</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">,</span> <span class="n">RidgeCV</span><span class="p">,</span> <span class="n">LassoCV</span><span class="p">,</span> <span class="n">ElasticNetCV</span><span class="p">,</span> <span class="n">BayesianRidge</span><span class="p">,</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="n">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span><span class="p">,</span> <span class="n">ExtraTreeClassifier</span>
<span class="kn">from</span> <span class="n">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVR</span>
<span class="kn">from</span> <span class="n">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span><span class="p">,</span>  <span class="n">GradientBoostingRegressor</span><span class="p">,</span> <span class="n">ExtraTreesRegressor</span>
<span class="kn">from</span> <span class="n">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">ShuffleSplit</span>
<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">RobustScaler</span>
<span class="kn">from</span> <span class="n">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="kn">from</span> <span class="n">lightgbm</span> <span class="kn">import</span> <span class="n">LGBMRegressor</span>
<span class="kn">import</span> <span class="n">lightgbm</span> <span class="k">as</span> <span class="n">lgb</span>
<span class="kn">import</span> <span class="n">xgboost</span> <span class="k">as</span> <span class="n">xgb</span>
<span class="kn">from</span> <span class="n">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div></div>

<p>We load each csv file in an independent Padas DataFrame.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sales_train</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./competitive-data-science-predict-future-sales/sales_train.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">])</span>
<span class="n">sales_test</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./competitive-data-science-predict-future-sales/test.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">sample_submission</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./competitive-data-science-predict-future-sales/sample_submission.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./competitive-data-science-predict-future-sales/items.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">item_categories</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./competitive-data-science-predict-future-sales/item_categories.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">shops</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./competitive-data-science-predict-future-sales/shops.csv</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sample_submission</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>item_cnt_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>0.5</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>0.5</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>0.5</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let’s explore the datasets by first looking at:</p>
<ol>
  <li>The dataset shapes</li>
  <li>The dataset columns</li>
  <li>The data info</li>
</ol>

<p><a id="Section_31"></a></p>
<h3 id="sales-dataset">Sales Dataset</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Sales Train</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sales_train</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sales Train
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2013-02-01</td>
      <td>0</td>
      <td>59</td>
      <td>22154</td>
      <td>999.00</td>
      <td>1.0</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2013-03-01</td>
      <td>0</td>
      <td>25</td>
      <td>2552</td>
      <td>899.00</td>
      <td>1.0</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2013-05-01</td>
      <td>0</td>
      <td>25</td>
      <td>2552</td>
      <td>899.00</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <td>3</td>
      <td>2013-06-01</td>
      <td>0</td>
      <td>25</td>
      <td>2554</td>
      <td>1709.05</td>
      <td>1.0</td>
    </tr>
    <tr>
      <td>4</td>
      <td>2013-01-15</td>
      <td>0</td>
      <td>25</td>
      <td>2555</td>
      <td>1099.00</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>The <code class="language-plaintext highlighter-rouge">item_cnt_dat</code> colum contains positive values for sales and negative values for returns.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Sales Train set shape</span><span class="sh">"</span><span class="p">,</span> <span class="n">sales_train</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sales Train set shape (2935849, 6)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sales_train</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 2935849 entries, 0 to 2935848
Data columns (total 6 columns):
date              datetime64[ns]
date_block_num    int64
shop_id           int64
item_id           int64
item_price        float64
item_cnt_day      float64
dtypes: datetime64[ns](1), float64(2), int64(3)
memory usage: 134.4 MB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Null records</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sales_train</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Null records
date              0
date_block_num    0
shop_id           0
item_id           0
item_price        0
item_cnt_day      0
dtype: int64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Description</span><span class="sh">'</span><span class="p">)</span>
<span class="n">sales_train</span><span class="p">.</span><span class="nf">describe</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Description
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>count</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
    </tr>
    <tr>
      <td>mean</td>
      <td>1.456991e+01</td>
      <td>3.300173e+01</td>
      <td>1.019723e+04</td>
      <td>8.908532e+02</td>
      <td>1.242641e+00</td>
    </tr>
    <tr>
      <td>std</td>
      <td>9.422988e+00</td>
      <td>1.622697e+01</td>
      <td>6.324297e+03</td>
      <td>1.729800e+03</td>
      <td>2.618834e+00</td>
    </tr>
    <tr>
      <td>min</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>-1.000000e+00</td>
      <td>-2.200000e+01</td>
    </tr>
    <tr>
      <td>25%</td>
      <td>7.000000e+00</td>
      <td>2.200000e+01</td>
      <td>4.476000e+03</td>
      <td>2.490000e+02</td>
      <td>1.000000e+00</td>
    </tr>
    <tr>
      <td>50%</td>
      <td>1.400000e+01</td>
      <td>3.100000e+01</td>
      <td>9.343000e+03</td>
      <td>3.990000e+02</td>
      <td>1.000000e+00</td>
    </tr>
    <tr>
      <td>75%</td>
      <td>2.300000e+01</td>
      <td>4.700000e+01</td>
      <td>1.568400e+04</td>
      <td>9.990000e+02</td>
      <td>1.000000e+00</td>
    </tr>
    <tr>
      <td>max</td>
      <td>3.300000e+01</td>
      <td>5.900000e+01</td>
      <td>2.216900e+04</td>
      <td>3.079800e+05</td>
      <td>2.169000e+03</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Sales Test</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sales_test</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sales Test
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>shop_id</th>
      <th>item_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>5037</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>5</td>
      <td>5320</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>5</td>
      <td>5233</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3</td>
      <td>5</td>
      <td>5232</td>
    </tr>
    <tr>
      <td>4</td>
      <td>4</td>
      <td>5</td>
      <td>5268</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Sales Test set shape</span><span class="sh">"</span><span class="p">,</span> <span class="n">sales_test</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sales Test set shape (214200, 3)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sales_test</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 214200 entries, 0 to 214199
Data columns (total 3 columns):
ID         214200 non-null int64
shop_id    214200 non-null int64
item_id    214200 non-null int64
dtypes: int64(3)
memory usage: 4.9 MB
</code></pre></div></div>

<p><a id="Section_32"></a></p>
<h3 id="item-dataset">Item Dataset</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Items</span><span class="sh">"</span><span class="p">)</span>
<span class="n">items</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Items
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>item_name</th>
      <th>item_id</th>
      <th>item_category_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>! ВО ВЛАСТИ НАВАЖДЕНИЯ (ПЛАСТ.)         D</td>
      <td>0</td>
      <td>40</td>
    </tr>
    <tr>
      <td>1</td>
      <td>!ABBYY FineReader 12 Professional Edition Full...</td>
      <td>1</td>
      <td>76</td>
    </tr>
    <tr>
      <td>2</td>
      <td>***В ЛУЧАХ СЛАВЫ   (UNV)                    D</td>
      <td>2</td>
      <td>40</td>
    </tr>
    <tr>
      <td>3</td>
      <td>***ГОЛУБАЯ ВОЛНА  (Univ)                      D</td>
      <td>3</td>
      <td>40</td>
    </tr>
    <tr>
      <td>4</td>
      <td>***КОРОБКА (СТЕКЛО)                       D</td>
      <td>4</td>
      <td>40</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Items shape</span><span class="sh">"</span><span class="p">,</span> <span class="n">items</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Items shape (22170, 3)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Null records</span><span class="sh">"</span><span class="p">)</span>
<span class="n">items</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Null records
item_name           0
item_id             0
item_category_id    0
dtype: int64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">items</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 22170 entries, 0 to 22169
Data columns (total 3 columns):
item_name           22170 non-null object
item_id             22170 non-null int64
item_category_id    22170 non-null int64
dtypes: int64(2), object(1)
memory usage: 519.7+ KB
</code></pre></div></div>

<p><a id="Section_33"></a></p>
<h3 id="item-categories-dataset">Item Categories Dataset</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Item Categories</span><span class="sh">"</span><span class="p">)</span>
<span class="n">item_categories</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Item Categories
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>item_category_name</th>
      <th>item_category_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>PC - Гарнитуры/Наушники</td>
      <td>0</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Аксессуары - PS2</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Аксессуары - PS3</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Аксессуары - PS4</td>
      <td>3</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Аксессуары - PSP</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Item categories shape</span><span class="sh">"</span><span class="p">,</span> <span class="n">item_categories</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Item categories shape (84, 2)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item_categories</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 84 entries, 0 to 83
Data columns (total 2 columns):
item_category_name    84 non-null object
item_category_id      84 non-null int64
dtypes: int64(1), object(1)
memory usage: 1.4+ KB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Null records</span><span class="sh">"</span><span class="p">)</span>
<span class="n">item_categories</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Null records
item_category_name    0
item_category_id      0
dtype: int64
</code></pre></div></div>

<p><a id="Section_34"></a></p>
<h3 id="shop-dataset">Shop Dataset</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Shops</span><span class="sh">"</span><span class="p">)</span>
<span class="n">shops</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Shops
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>shop_name</th>
      <th>shop_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>!Якутск Орджоникидзе, 56 фран</td>
      <td>0</td>
    </tr>
    <tr>
      <td>1</td>
      <td>!Якутск ТЦ "Центральный" фран</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Адыгея ТЦ "Мега"</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Балашиха ТРК "Октябрь-Киномир"</td>
      <td>3</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Волжский ТЦ "Волга Молл"</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Shop shape</span><span class="sh">"</span><span class="p">,</span> <span class="n">shops</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Shop shape (60, 2)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Null records</span><span class="sh">"</span><span class="p">)</span>
<span class="n">shops</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Null records
shop_name    0
shop_id      0
dtype: int64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shops</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 60 entries, 0 to 59
Data columns (total 2 columns):
shop_name    60 non-null object
shop_id      60 non-null int64
dtypes: int64(1), object(1)
memory usage: 1.1+ KB
</code></pre></div></div>

<p>The csv files have been imported and inspected. They do not contain apparent null values and they also seem to be well organized. The tables require further inspection to evaluate the quality of the data.</p>

<hr />
<p><a id="Section_4"></a></p>
<h2 id="database-schema">Database schema</h2>

<p>The set of csv files are connected using primary key features. The relationships are established as follows:</p>

<ul>
  <li>shops (shop_id) -&gt; sales_train (shop_id): type <strong>one-to-many</strong></li>
  <li>item (item_category_id) -&gt; item_categories (category_id): type <strong>one-to-many</strong></li>
  <li>sales_train (shop_id) -&gt; shops (shop_id): type <strong>one-to-many</strong></li>
  <li>sales_train (item_id) -&gt; items (item_id): type <strong>one-to-many</strong></li>
</ul>

<p>We can then join the tables into a single dataset:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># merge datset and drop duplicates keys
</span><span class="n">train</span> <span class="o">=</span> <span class="n">sales_train</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)</span> \
                   <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">shops</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)</span> \
                   <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">item_categories</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)</span> \
                   <span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">item_id_</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id_</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id_</span><span class="sh">'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Join dataset shape:</span><span class="sh">"</span><span class="p">,</span><span class="n">train</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">train</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Join dataset shape: (2935849, 10)
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
      <th>item_name</th>
      <th>item_category_id</th>
      <th>shop_name</th>
      <th>item_category_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2013-02-01</td>
      <td>0</td>
      <td>59</td>
      <td>22154</td>
      <td>999.00</td>
      <td>1.0</td>
      <td>ЯВЛЕНИЕ 2012 (BD)</td>
      <td>37</td>
      <td>Ярославль ТЦ "Альтаир"</td>
      <td>Кино - Blu-Ray</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2013-03-01</td>
      <td>0</td>
      <td>25</td>
      <td>2552</td>
      <td>899.00</td>
      <td>1.0</td>
      <td>DEEP PURPLE  The House Of Blue Light  LP</td>
      <td>58</td>
      <td>Москва ТРК "Атриум"</td>
      <td>Музыка - Винил</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2013-05-01</td>
      <td>0</td>
      <td>25</td>
      <td>2552</td>
      <td>899.00</td>
      <td>-1.0</td>
      <td>DEEP PURPLE  The House Of Blue Light  LP</td>
      <td>58</td>
      <td>Москва ТРК "Атриум"</td>
      <td>Музыка - Винил</td>
    </tr>
    <tr>
      <td>3</td>
      <td>2013-06-01</td>
      <td>0</td>
      <td>25</td>
      <td>2554</td>
      <td>1709.05</td>
      <td>1.0</td>
      <td>DEEP PURPLE  Who Do You Think We Are  LP</td>
      <td>58</td>
      <td>Москва ТРК "Атриум"</td>
      <td>Музыка - Винил</td>
    </tr>
    <tr>
      <td>4</td>
      <td>2013-01-15</td>
      <td>0</td>
      <td>25</td>
      <td>2555</td>
      <td>1099.00</td>
      <td>1.0</td>
      <td>DEEP PURPLE 30 Very Best Of 2CD (Фирм.)</td>
      <td>56</td>
      <td>Москва ТРК "Атриум"</td>
      <td>Музыка - CD фирменного производства</td>
    </tr>
  </tbody>
</table>
</div>

<hr />
<p><a id="Section_5"></a></p>
<h2 id="verification-and-probing">Verification and Probing</h2>

<p>A good exercise is to reproduce previous_value_benchmark. As the name suggest - in this benchmark for the each shop/item pair our predictions are just monthly sales from the previous month, i.e. October 2015.</p>

<p>The most important step at reproducing this score is correctly aggregating daily data and constructing monthly sales data frame. You need to get lagged values, fill NaNs with zeros and clip the values into [0,20] range. If you do it correctly, you’ll get precisely 1.16777 on the public leaderboard.</p>

<p>Generating features like this is a necessary basis for more complex models. Also, if you decide to fit some model, don’t forget to clip the target into [0,20] range, it makes a big difference.</p>

<p>The following steps are used to produced the benchmark verification:</p>
<ol>
  <li>Isolate data from October 2015</li>
  <li>Drop unnecessary features</li>
  <li>Group filtered data by <code class="language-plaintext highlighter-rouge">shop_id</code> and <code class="language-plaintext highlighter-rouge">item_id</code></li>
  <li>Clip data and fill Na with <code class="language-plaintext highlighter-rouge">0</code></li>
  <li>Rename columns to match submission format</li>
</ol>

<p><strong>Step 1</strong>: Isolate data</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># isolate date from October 2015
</span><span class="n">bench_oct2015</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">33</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># display the subset
</span><span class="n">bench_oct2015</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
      <th>item_name</th>
      <th>item_category_id</th>
      <th>shop_name</th>
      <th>item_category_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2882335</td>
      <td>2015-10-23</td>
      <td>33</td>
      <td>45</td>
      <td>13315</td>
      <td>649.0</td>
      <td>1.0</td>
      <td>Комикс Супермен Земля-1 Книга 2</td>
      <td>47</td>
      <td>Самара ТЦ "ПаркХаус"</td>
      <td>Книги - Комиксы, манга</td>
    </tr>
    <tr>
      <td>2882336</td>
      <td>2015-05-10</td>
      <td>33</td>
      <td>45</td>
      <td>13880</td>
      <td>229.0</td>
      <td>1.0</td>
      <td>ЛЕПС ГРИГОРИЙ  Grand Collection  Лучшее для лу...</td>
      <td>55</td>
      <td>Самара ТЦ "ПаркХаус"</td>
      <td>Музыка - CD локального производства</td>
    </tr>
    <tr>
      <td>2882337</td>
      <td>2015-02-10</td>
      <td>33</td>
      <td>45</td>
      <td>13881</td>
      <td>659.0</td>
      <td>1.0</td>
      <td>ЛЕПС ГРИГОРИЙ  The Best  3CD (фирм.)</td>
      <td>55</td>
      <td>Самара ТЦ "ПаркХаус"</td>
      <td>Музыка - CD локального производства</td>
    </tr>
    <tr>
      <td>2882338</td>
      <td>2015-12-10</td>
      <td>33</td>
      <td>45</td>
      <td>13881</td>
      <td>659.0</td>
      <td>1.0</td>
      <td>ЛЕПС ГРИГОРИЙ  The Best  3CD (фирм.)</td>
      <td>55</td>
      <td>Самара ТЦ "ПаркХаус"</td>
      <td>Музыка - CD локального производства</td>
    </tr>
    <tr>
      <td>2882339</td>
      <td>2015-04-10</td>
      <td>33</td>
      <td>45</td>
      <td>13923</td>
      <td>169.0</td>
      <td>1.0</td>
      <td>ЛИКВИДАЦИЯ (Регион)</td>
      <td>40</td>
      <td>Самара ТЦ "ПаркХаус"</td>
      <td>Кино - DVD</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>Step 2</strong>: Aggregate data and fill na</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the sales are aggregated by shop_id, item_id
</span><span class="n">test_oct2015</span> <span class="o">=</span> <span class="n">bench_oct2015</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">"</span><span class="s">shop_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">item_id</span><span class="sh">"</span><span class="p">])</span>

<span class="c1"># aggregate item_cnt by sum
</span><span class="n">test_oct2015</span> <span class="o">=</span> <span class="n">test_oct2015</span><span class="p">.</span><span class="nf">aggregate</span><span class="p">({</span><span class="sh">"</span><span class="s">item_cnt_day</span><span class="sh">"</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">}).</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># melt indexes
</span><span class="n">test_oct2015</span> <span class="o">=</span> <span class="n">test_oct2015</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">shop_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">item_id</span><span class="sh">"</span><span class="p">])</span>

<span class="c1"># adjust column names to match submission
</span><span class="n">test_oct2015</span> <span class="o">=</span> <span class="n">test_oct2015</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span> <span class="n">test_oct2015</span><span class="p">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="sh">"</span><span class="s">item_cnt_month</span><span class="sh">"</span> <span class="p">})</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2047     42
19744    42
15406    42
13359    42
3240     42
         ..
21086    42
21214    42
17244    42
21342    42
2049     42
Name: item_id, Length: 5100, dtype: int64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_oct2015</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>22102    42
3350     42
15069    42
10200    41
7223     41
         ..
8138      1
20686     1
1929      1
16604     1
14289     1
Name: item_id, Length: 5413, dtype: int64
</code></pre></div></div>

<p>As shown above, our current predictions does not contain all the necessary records. This is due to the nature of the original filtered data. Indeed, the <code class="language-plaintext highlighter-rouge">shop_id</code>+<code class="language-plaintext highlighter-rouge">item_id</code> without sales in October 2015 do not appear. We need to merge the test set and our prediction using a left join to ensure that our submission meets the requirements.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the store+item without any sale are not listed in our table.
</span><span class="n">test_submission</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">test_oct2015</span><span class="p">,</span> <span class="n">sales_test</span><span class="p">,</span>
                           <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">right</span><span class="sh">'</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span>
                           <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]).</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_submission</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_submission</span> <span class="o">=</span> <span class="n">test_submission</span><span class="p">[[</span><span class="sh">'</span><span class="s">ID</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># clip predictions
</span><span class="n">test_submission</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_submission</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">].</span><span class="nf">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">test_submission</span><span class="p">.</span><span class="nf">describe</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>item_cnt_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>count</td>
      <td>214200.000000</td>
      <td>214200.000000</td>
    </tr>
    <tr>
      <td>mean</td>
      <td>107099.500000</td>
      <td>0.255649</td>
    </tr>
    <tr>
      <td>std</td>
      <td>61834.358168</td>
      <td>1.089856</td>
    </tr>
    <tr>
      <td>min</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <td>25%</td>
      <td>53549.750000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <td>50%</td>
      <td>107099.500000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <td>75%</td>
      <td>160649.250000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <td>max</td>
      <td>214199.000000</td>
      <td>20.000000</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_submission</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">previous_value_benchmark.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/benchmark.png" style="height: 150px;" />
</figure>

<p><strong>Note</strong>: This is the benchmark value that we were aiming for.</p>

<p>In addition, we can perform some leaderboard probing to gain valuable insights on the test set. By predicting a 0 value for all the test cases, the evaluation metric (RMSE) becomes:</p>

<p>\(RMSE^{2}=MSE=\frac{1}{N}\sum_{i=1}^{N} (y_i-\hat{y_i})^2=\frac{1}{N}\sum_{i=1}^{N} (y_i)^2\)<br />
By using the value (\(\alpha\)) from the Kaggle evaluation, then we can retrieve:</p>

\[\sum_{i=1}^{N} (y_i)^2=\alpha*N\]

<p>Now, if we use another constant prediction, say 1.0, we have:<br />
\(RMSE^{2}=MSE=\frac{1}{N}\sum_{i=1}^{N} (y_i-\hat{y_i})^2=\frac{1}{N}\sum_{i=1}^{N} (y_i-1)^{2}=\beta\)</p>

<p>If we combine our two equations, we obtain:</p>

\[N*\beta=\sum_{i=1}^{N} (y_i-0.5)^{2}=\sum_{i=1}^{N} (y_i^{2}-2*y_i-1)=\sum_{i=1}^{N}(y_i^{2})-2*\sum_{i=1}^{N}(y_i)+N\]

<p>This becomes:</p>

\[\frac{1}{N}\sum_{i=1}^{N}(y_i)=\frac{\alpha+1-\beta}{2}\]

<p>We can then scale our future predictions to match the sum of the squares.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># set predictions equal to 0
</span><span class="n">test_submission</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">test_submission</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">zero_value.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/zero_predictions.png" style="height: 150px;" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># set predictions equal to 1.0
</span><span class="n">test_submission</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">test_submission</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">one_value.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/one_predictions.png" style="height: 150px;" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mean_test</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.25011</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.41241</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Mean of test set: {:.8f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">mean_test</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mean of test set: 0.28393650
</code></pre></div></div>

<hr />
<p><a id="Section_6"></a></p>
<h2 id="exploratory-data-analysis-eda">Exploratory Data Analysis (EDA)</h2>

<p>Let’s first look for obvious invalid values in the train set:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 2935849 entries, 0 to 2935848
Data columns (total 10 columns):
date                  datetime64[ns]
date_block_num        int64
shop_id               int64
item_id               int64
item_price            float64
item_cnt_day          float64
item_name             object
item_category_id      int64
shop_name             object
item_category_name    object
dtypes: datetime64[ns](1), float64(2), int64(4), object(3)
memory usage: 224.0+ MB
</code></pre></div></div>

<p><strong>Note</strong>: From the above table, it appears that the features are stored using very complex data type. In order to save some memory, the 64-bit version of the floats and integers can be downcasted to 16-bit versions.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">.</span><span class="nf">describe</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
      <th>item_category_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>count</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
      <td>2.935849e+06</td>
    </tr>
    <tr>
      <td>mean</td>
      <td>1.456991e+01</td>
      <td>3.300173e+01</td>
      <td>1.019723e+04</td>
      <td>8.908532e+02</td>
      <td>1.242641e+00</td>
      <td>4.000138e+01</td>
    </tr>
    <tr>
      <td>std</td>
      <td>9.422988e+00</td>
      <td>1.622697e+01</td>
      <td>6.324297e+03</td>
      <td>1.729800e+03</td>
      <td>2.618834e+00</td>
      <td>1.710076e+01</td>
    </tr>
    <tr>
      <td>min</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>-1.000000e+00</td>
      <td>-2.200000e+01</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <td>25%</td>
      <td>7.000000e+00</td>
      <td>2.200000e+01</td>
      <td>4.476000e+03</td>
      <td>2.490000e+02</td>
      <td>1.000000e+00</td>
      <td>2.800000e+01</td>
    </tr>
    <tr>
      <td>50%</td>
      <td>1.400000e+01</td>
      <td>3.100000e+01</td>
      <td>9.343000e+03</td>
      <td>3.990000e+02</td>
      <td>1.000000e+00</td>
      <td>4.000000e+01</td>
    </tr>
    <tr>
      <td>75%</td>
      <td>2.300000e+01</td>
      <td>4.700000e+01</td>
      <td>1.568400e+04</td>
      <td>9.990000e+02</td>
      <td>1.000000e+00</td>
      <td>5.500000e+01</td>
    </tr>
    <tr>
      <td>max</td>
      <td>3.300000e+01</td>
      <td>5.900000e+01</td>
      <td>2.216900e+04</td>
      <td>3.079800e+05</td>
      <td>2.169000e+03</td>
      <td>8.300000e+01</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>Note</strong>:</p>
<ol>
  <li>As shown above, there are negative prices. This appears to be incorrect. We can further investigate by plotting the distribution of the prices. In addition, there seem to be a few items with a very large price tags.</li>
  <li>Similarly, there are a few days with very high item count.</li>
</ol>

<p><a id="Section_61"></a></p>
<h3 id="data-types">Data Types</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">change_data_type</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">float_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="n">dtype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">float64</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">int_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="n">dtype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">int64</span><span class="sh">'</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="n">float_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">float_cols</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">int_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">int_cols</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="n">train</span> <span class="o">=</span> <span class="nf">change_data_type</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">train</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 2935849 entries, 0 to 2935848
Data columns (total 10 columns):
date                  datetime64[ns]
date_block_num        int16
shop_id               int16
item_id               int16
item_price            float32
item_cnt_day          float32
item_name             object
item_category_id      int16
shop_name             object
item_category_name    object
dtypes: datetime64[ns](1), float32(2), int16(4), object(3)
memory usage: 134.4+ MB
</code></pre></div></div>

<p>The dataframe went from 224 MB to 134 MB.</p>

<p><a id="Section_62"></a></p>
<h3 id="eda-numerical-features">EDA Numerical Features</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot boxplot
</span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1c3bdc1f10&gt;
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_78_1.png" />
</figure>

<p><strong>Note</strong>: We can count how many items have a price tag above 150000.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">150000</span><span class="p">]</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
      <th>item_name</th>
      <th>item_category_id</th>
      <th>shop_name</th>
      <th>item_category_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1163158</td>
      <td>2013-12-13</td>
      <td>11</td>
      <td>12</td>
      <td>6066</td>
      <td>307980.0</td>
      <td>1.0</td>
      <td>Radmin 3  - 522 лиц.</td>
      <td>75</td>
      <td>Интернет-магазин ЧС</td>
      <td>Программы - Для дома и офиса</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let’s see if this item has had a difference price previously:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6066</span><span class="p">]</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
      <th>item_name</th>
      <th>item_category_id</th>
      <th>shop_name</th>
      <th>item_category_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1163158</td>
      <td>2013-12-13</td>
      <td>11</td>
      <td>12</td>
      <td>6066</td>
      <td>307980.0</td>
      <td>1.0</td>
      <td>Radmin 3  - 522 лиц.</td>
      <td>75</td>
      <td>Интернет-магазин ЧС</td>
      <td>Программы - Для дома и офиса</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can drop this item since this high price appears to be an error.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># remove the single outlier for large price
</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">]</span>
</code></pre></div></div>

<p>Does the dataset contain negative prices?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">().</span><span class="nf">sort_index</span><span class="p">().</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-1.0000       1
 0.0700       2
 0.0875       1
 0.0900       1
 0.1000    2932
Name: item_price, dtype: int64
</code></pre></div></div>

<p><strong>Note</strong>: One item has a negative price, we remove it from the list.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># remove the single outlier for negative price
</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot boxplot
</span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlim</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xscale</span><span class="p">(</span><span class="sh">"</span><span class="s">log</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1a1773acd0&gt;
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_89_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot boxplot
</span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1a78fcdfd0&gt;
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_90_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">]</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_price</th>
      <th>item_cnt_day</th>
      <th>item_name</th>
      <th>item_category_id</th>
      <th>shop_name</th>
      <th>item_category_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2909818</td>
      <td>2015-10-28</td>
      <td>33</td>
      <td>12</td>
      <td>11373</td>
      <td>0.908714</td>
      <td>2169.0</td>
      <td>Доставка до пункта выдачи (Boxberry)</td>
      <td>9</td>
      <td>Интернет-магазин ЧС</td>
      <td>Доставка товара</td>
    </tr>
  </tbody>
</table>
</div>

<p>This day does not correspond to a holiday during which we could expect a large sale. We remove this value.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># remove the outlier for item_cnt_day
</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1a29353a10&gt;
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_94_1.png" />
</figure>

<p>As expected, expensive items are not often purchased. Let’s now inspect trends over time.</p>

<p><a id="Section_62"></a></p>
<h3 id="eda-categorical-features">EDA Categorical Features</h3>

<p>We start by looking for duplicates in the categories.  Based on the configuration of the</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_name</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">().</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Химки ТЦ "Мега"                  1
!Якутск Орджоникидзе, 56 фран    1
Уфа ТЦ "Семья" 2                 1
Калуга ТРЦ "XXI век"             1
Якутск ТЦ "Центральный"          1
Name: shop_name, dtype: int64
</code></pre></div></div>

<p>There are no obvious duplicates. However, upon detailed inspection of the <code class="language-plaintext highlighter-rouge">shop_name</code> feature, we can make the following observations:</p>
<ol>
  <li>The <code class="language-plaintext highlighter-rouge">shop_name</code> contains the city of the store. The string is structured as “city, store name”</li>
  <li>Several id appears to be duplicates.</li>
</ol>

<p>The indexes below appear to be duplicates. They are combined under a single index. The same process is applied to the test set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_name</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">strip</span><span class="p">(</span><span class="sh">'</span><span class="s">!</span><span class="sh">'</span><span class="p">).</span><span class="nf">sort_values</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2                                    Адыгея ТЦ "Мега"
3                      Балашиха ТРК "Октябрь-Киномир"
4                            Волжский ТЦ "Волга Молл"
5                              Вологда ТРЦ "Мармелад"
6                          Воронеж (Плехановская, 13)
7                              Воронеж ТРЦ "Максимир"
8                        Воронеж ТРЦ Сити-Парк "Град"
9                                   Выездная Торговля
10                         Жуковский ул. Чкалова 39м?
11                         Жуковский ул. Чкалова 39м²
12                                Интернет-магазин ЧС
13                                Казань ТЦ "Бехетле"
14                            Казань ТЦ "ПаркХаус" II
15                               Калуга ТРЦ "XXI век"
16                                   Коломна ТЦ "Рио"
17                      Красноярск ТЦ "Взлетка Плаза"
18                               Красноярск ТЦ "Июнь"
19                              Курск ТЦ "Пушкинский"
20                                Москва "Распродажа"
21                             Москва МТРЦ "Афи Молл"
22                                 Москва Магазин С21
23                   Москва ТК "Буденовский" (пав.А2)
24                   Москва ТК "Буденовский" (пав.К7)
25                                Москва ТРК "Атриум"
26                        Москва ТЦ "Ареал" (Беляево)
27                     Москва ТЦ "МЕГА Белая Дача II"
28                    Москва ТЦ "МЕГА Теплый Стан" II
29                 Москва ТЦ "Новый век" (Новокосино)
30                             Москва ТЦ "Перловский"
31                            Москва ТЦ "Семеновский"
32                         Москва ТЦ "Серебряный Дом"
33                                  Мытищи ТРК "XL-3"
34                               Н.Новгород ТРЦ "РИО"
35                        Н.Новгород ТРЦ "Фантастика"
36              Новосибирск ТРЦ "Галерея Новосибирск"
37                              Новосибирск ТЦ "Мега"
38                                     Омск ТЦ "Мега"
39              РостовНаДону ТРК "Мегацентр Горизонт"
40    РостовНаДону ТРК "Мегацентр Горизонт" Островной
41                             РостовНаДону ТЦ "Мега"
42                             СПб ТК "Невский Центр"
43                                    СПб ТК "Сенная"
44                                Самара ТЦ "Мелодия"
45                               Самара ТЦ "ПаркХаус"
46                              Сергиев Посад ТЦ "7Я"
47                             Сургут ТРЦ "Сити Молл"
48                       Томск ТРЦ "Изумрудный Город"
49                              Тюмень ТРЦ "Кристалл"
50                                 Тюмень ТЦ "Гудвин"
51                          Тюмень ТЦ "Зеленый Берег"
52                               Уфа ТК "Центральный"
53                                   Уфа ТЦ "Семья" 2
54                                    Химки ТЦ "Мега"
55                           Цифровой склад 1С-Онлайн
56                               Чехов ТРЦ "Карнавал"
57                            Якутск Орджоникидзе, 56
0                        Якутск Орджоникидзе, 56 фран
58                            Якутск ТЦ "Центральный"
1                        Якутск ТЦ "Центральный" фран
59                             Ярославль ТЦ "Альтаир"
Name: shop_name, dtype: object
</code></pre></div></div>

<p>The pairs are defined as (0, 57), (1, 58), (10, 11).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_name</span><span class="sh">'</span><span class="p">].</span><span class="n">loc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0     !Якутск Орджоникидзе, 56 фран
57          Якутск Орджоникидзе, 56
1     !Якутск ТЦ "Центральный" фран
58          Якутск ТЦ "Центральный"
10       Жуковский ул. Чкалова 39м?
11       Жуковский ул. Чкалова 39м²
Name: shop_name, dtype: object
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># (0, 57) -&gt; Якутск Орджоникидзе, 56
</span><span class="n">train</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">57</span>
<span class="n">sales_test</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">57</span>

<span class="c1"># (1, 58) -&gt; Якутск ТЦ "Центральный"
</span><span class="n">train</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">58</span>
<span class="n">sales_test</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">58</span>

<span class="c1"># (10, 11) -&gt; Жуковский ул. Чкалова 39м²
</span><span class="n">train</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">sales_test</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># add revenue to train set
</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">revenue</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">.</span><span class="n">columns</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Index(['date', 'date_block_num', 'shop_id', 'item_id', 'item_price',
       'item_cnt_day', 'item_name', 'item_category_id', 'shop_name',
       'item_category_name', 'revenue'],
      dtype='object')
</code></pre></div></div>

<p>In addition, we can create a new feature containing the city name associated to the store name.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># replace one faulty city name (Сергиев Посад)
</span><span class="n">shops</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_name</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="sh">'</span><span class="s">Сергиев Посад ТЦ </span><span class="sh">"</span><span class="s">7Я</span><span class="sh">"'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_name</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">СергиевПосад ТЦ </span><span class="sh">"</span><span class="s">7Я</span><span class="sh">"'</span>

<span class="c1"># split shop name (and remove the leading !)
</span><span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">city</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_name</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">strip</span><span class="p">(</span><span class="sh">'</span><span class="s">!</span><span class="sh">'</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">city</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">().</span><span class="nf">sort_index</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Адыгея               1
Балашиха             1
Волжский             1
Вологда              1
Воронеж              3
Выездная             1
Жуковский            2
Интернет-магазин     1
Казань               2
Калуга               1
Коломна              1
Красноярск           2
Курск                1
Москва              13
Мытищи               1
Н.Новгород           2
Новосибирск          2
Омск                 1
РостовНаДону         3
СПб                  2
Самара               2
СергиевПосад         1
Сургут               1
Томск                1
Тюмень               3
Уфа                  2
Химки                1
Цифровой             1
Чехов                1
Якутск               4
Ярославль            1
Name: city, dtype: int64
</code></pre></div></div>

<p>The city name can be encoded to facilitate the use of this feature.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">LabelEncoder</span><span class="p">().</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">shops</span><span class="p">[</span><span class="sh">'</span><span class="s">city</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<p>We can now delete the unnecessary columns <code class="language-plaintext highlighter-rouge">city</code> and <code class="language-plaintext highlighter-rouge">shop_name</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shops</span> <span class="o">=</span> <span class="n">shops</span><span class="p">[[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">]]</span>
</code></pre></div></div>

<p>The next categorical feature to process is the item category. It is encoded as an id and as a name. The first step consists of looking at the <code class="language-plaintext highlighter-rouge">item_category_name</code> to identify potential embedded information.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item_categories</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>item_category_name</th>
      <th>item_category_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>PC - Гарнитуры/Наушники</td>
      <td>0</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Аксессуары - PS2</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Аксессуары - PS3</td>
      <td>2</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Аксессуары - PS4</td>
      <td>3</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Аксессуары - PSP</td>
      <td>4</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Аксессуары - PSVita</td>
      <td>5</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Аксессуары - XBOX 360</td>
      <td>6</td>
    </tr>
    <tr>
      <td>7</td>
      <td>Аксессуары - XBOX ONE</td>
      <td>7</td>
    </tr>
    <tr>
      <td>8</td>
      <td>Билеты (Цифра)</td>
      <td>8</td>
    </tr>
    <tr>
      <td>9</td>
      <td>Доставка товара</td>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div>

<p>It seems that the category contains two components:</p>
<ol>
  <li>A type</li>
  <li>A subtype</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># split `item_category_name`
</span><span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">item_category_name</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> - </span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># isolate `type_name` and 'subtype_name'
</span><span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">type_name</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>
<span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">subtype_name</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>

<span class="c1"># the type and subtype can be encoded
</span><span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">LabelEncoder</span><span class="p">().</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">type_name</span><span class="sh">'</span><span class="p">])</span>
<span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">LabelEncoder</span><span class="p">().</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">item_categories</span><span class="p">[</span><span class="sh">'</span><span class="s">subtype_name</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># filter out text features
</span><span class="n">item_categories</span> <span class="o">=</span> <span class="n">item_categories</span><span class="p">[[</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">]]</span>
</code></pre></div></div>

<p>Finally, we apply a similar process to the item names. Since the item names are not consistently defined, we keep only the <code class="language-plaintext highlighter-rouge">item_it</code> and the <code class="language-plaintext highlighter-rouge">item_category_id</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="p">[[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">]]</span>
</code></pre></div></div>

<p><a id="Section_63"></a></p>
<h3 id="monthly-data">Monthly Data</h3>

<p>This competition is special because it requires to perform some aggregation on the train set before building the model. In order to make monthly predictions, we aggregate the train set by shop and item. In addition, the train set needs to contain similar shop/item pairs as the test set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=====  ITEMS  =====</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">There are {} unique items in the train set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">There are {} unique items in the test set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">{} items are in the test but not in the train set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span> <span class="o">-</span> <span class="nf">set</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()))))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">===== SHOPS  =====</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">There are {} unique shops in the train set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">There are {} unique shops in the test set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">{} shop are in the test but not in the train set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span> <span class="o">-</span> <span class="nf">set</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()))))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">===== TEST  =====</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">The test set contains {} pairs.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">sales_test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">There are {} possible unique pairs using the test data.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span> <span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=====  ITEMS  =====
There are 21806 unique items in the train set.
There are 5100 unique items in the test set.
363 items are in the test but not in the train set.

===== SHOPS  =====
There are 57 unique shops in the train set.
There are 42 unique shops in the test set.
0 shop are in the test but not in the train set.

===== TEST  =====
The test set contains 214200 pairs.
There are 214200 possible unique pairs using the test data.
</code></pre></div></div>

<p>Before we dive into the monthly trends, we need to establish some important rules to help capture the proper sale trends. We need to aggregate the data per month (<code class="language-plaintext highlighter-rouge">date_block_num</code>, <code class="language-plaintext highlighter-rouge">shop_id</code>, <code class="language-plaintext highlighter-rouge">item_id</code>).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">full_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">34</span><span class="p">):</span>
    
    <span class="c1"># isolate sales made on ith month
</span>    <span class="n">monthly_sales</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># create pairs of id, shops, items
</span>    <span class="n">full_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">product</span><span class="p">([</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">monthly_sales</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">(),</span>
                                        <span class="n">monthly_sales</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
                               <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="sh">'</span><span class="s">int16</span><span class="sh">'</span><span class="p">))</span>
    
<span class="c1"># create dataframe    
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">vstack</span><span class="p">(</span><span class="n">full_data</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

<span class="c1"># convert data to optimize memory
</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int8</span><span class="p">)</span>
<span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int8</span><span class="p">)</span>
<span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>

<span class="c1"># sort values
</span><span class="n">full_data</span> <span class="o">=</span>  <span class="n">full_data</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">full_data</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(10913804, 3)
</code></pre></div></div>

<p>The data now needs to be populated. To do so, we compute the aggregates over <code class="language-plaintext highlighter-rouge">shop_id</code>, <code class="language-plaintext highlighter-rouge">date_block_num</code>, and <code class="language-plaintext highlighter-rouge">item_id</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">full_data</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>114910</td>
      <td>0</td>
      <td>2</td>
      <td>19</td>
    </tr>
    <tr>
      <td>117150</td>
      <td>0</td>
      <td>2</td>
      <td>27</td>
    </tr>
    <tr>
      <td>120623</td>
      <td>0</td>
      <td>2</td>
      <td>28</td>
    </tr>
    <tr>
      <td>118316</td>
      <td>0</td>
      <td>2</td>
      <td>29</td>
    </tr>
    <tr>
      <td>114602</td>
      <td>0</td>
      <td>2</td>
      <td>32</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># aggregate item_cnt_day
</span><span class="n">monthly_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]).</span><span class="nf">agg</span><span class="p">({</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">})</span>

<span class="c1"># reset index and columns
</span><span class="n">monthly_train</span> <span class="o">=</span> <span class="n">monthly_train</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">()</span>

<span class="c1"># combine monthly train and pairs
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">monthly_train</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># clip data, fill nulls with 0, and downsize the datatype
</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></div>

<p>Include the test set records.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create month number
</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">34</span>

<span class="c1"># downsize features
</span><span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
<span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
<span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales_test</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>

<span class="n">sales_test</span> <span class="o">=</span> <span class="n">sales_test</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">ID</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># concat test and full_data
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">full_data</span><span class="p">,</span> <span class="n">sales_test</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># fill test values to 0
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>Now that our dataset contains the full sets of month/shop/item, we can add our additional features to complete the set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># shops
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">shops</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># items
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">items</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># item_categories
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">item_categories</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># downsize the in64
</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
<span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
<span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
<span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">full_data</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_block_num</th>
      <th>shop_id</th>
      <th>item_id</th>
      <th>item_cnt_day</th>
      <th>city_id</th>
      <th>item_category_id</th>
      <th>type_id</th>
      <th>subtype_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>19</td>
      <td>0.0</td>
      <td>0</td>
      <td>40</td>
      <td>11</td>
      <td>6</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>27</td>
      <td>1.0</td>
      <td>0</td>
      <td>19</td>
      <td>5</td>
      <td>12</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>28</td>
      <td>0.0</td>
      <td>0</td>
      <td>30</td>
      <td>8</td>
      <td>57</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0</td>
      <td>2</td>
      <td>29</td>
      <td>0.0</td>
      <td>0</td>
      <td>23</td>
      <td>5</td>
      <td>18</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0</td>
      <td>2</td>
      <td>32</td>
      <td>0.0</td>
      <td>0</td>
      <td>40</td>
      <td>11</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>

<p>At this point, we have combined our datasets and are ready for more exploration. One of the most common mistake made when performing EDA is to not clearly define what one is trying to archive. In order to avoid this lack of direction, let’s ask ourselves a few questions that we want answer before going further with our dataset.</p>
<ol>
  <li>What is the monthly total count trend?</li>
  <li>Is there a cycle when averaging the total counts by month?</li>
  <li>What categories are the most sold?</li>
  <li>What shops sell more?</li>
  <li>What categories are generating the most revenue?</li>
  <li>How frequent are returns?</li>
</ol>

<p><strong>What is the monthly total count trend?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># generate ticks for monthly plots
</span><span class="n">x_tick_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="sh">'</span><span class="s">2013</span><span class="sh">'</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="sh">'</span><span class="s">M</span><span class="sh">'</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">34</span><span class="p">))</span>
<span class="n">x_tick_vals</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_tick_vals</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">groups</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Total item sold</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">groups</span><span class="p">.</span><span class="nf">max</span><span class="p">())</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">34</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">x_tick_vals</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">groups</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_139_0.png" />
</figure>

<p><strong>Note</strong>: From the above plot, we can make two observations:</p>
<ol>
  <li>There seems to be a overall decrease of sales year after year</li>
  <li>The plot present some seasonality, the sales during the month of December are much higher that the sales during the preceding and following months. This can be explained as the Holiday season is typically prone to more spendings.</li>
</ol>

<p><strong>Is there a cycle when averaging the total counts by month?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">month</span>
<span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">year</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">groups</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Total items sold per month</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.1</span><span class="o">*</span><span class="n">groups</span><span class="p">.</span><span class="nf">max</span><span class="p">())</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Month</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">x_tick_vals</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">groups</span><span class="p">);</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_144_0.png" />
</figure>

<p><strong>What categories are the most sold?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gp_category_mean</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">gp_category_sum</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">item_category_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">item_cnt_day</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gp_category_mean</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">deep</span><span class="sh">"</span><span class="p">).</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Average number of item sold daily per category</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">item_category_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">item_cnt_day</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gp_category_sum</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">deep</span><span class="sh">"</span><span class="p">).</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Average number of item sold per category</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_147_0.png" />
</figure>

<p><strong>Note</strong>: From the above two plots, we can observer two interesting facts:</p>
<ol>
  <li>The sales are clearly unbalances amongst item categories. Several categories (71 and 79) account for a very large portion of the average daily item category count sold daily.<br />
  a. “Подарки - Сумки, Альбомы, Коврики д/мыши”,71 (Gifts - Bags, Albums, Mousepads)<br />
  b. Служебные,79 (Office furnitures)</li>
  <li>When looking at the average number of item sold per categories, new categories appear to dominate the sales.<br />
  a. Игры PC - Стандартные издания,30 (PC Games - Standard Editions)<br />
  b. Кино - DVD,40 (Cinema - DVD)<br />
  c. Музыка - CD локального производства,55 (Music - Local Production CD)</li>
</ol>

<p>The discrepancy between the two plots can be explained because not all the items and all the categories were sold during the entire timeframe of the study.</p>

<p><strong>What shops sell more?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gp_shops_sum</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">shop_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">item_cnt_day</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gp_shops_sum</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">deep</span><span class="sh">"</span><span class="p">).</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Total number of item sold per store</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_151_0.png" />
</figure>

<p><strong>Note</strong>: From the above plots, we can see a wide distribution of item sold per store. This can be a helpful feature as the size of the store is certainly correlated to the monthly sales of each items.</p>

<p><strong>What categories are generating the most revenue?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gp_cat_rev</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">revenue</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">catplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">item_category_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">revenue</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">gp_cat_rev</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="sh">"</span><span class="s">year</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">deep</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">bar</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">3.5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_155_0.png" />
</figure>

<p><strong>Note</strong>: The above plots help understand two important aspects of the sale trends:</p>
<ol>
  <li>There is a time effect related to what item categories are popular. For instance, in 2013, the category19 was very popular and its associated revenue has been decreasing since.</li>
  <li>As expected, the category feature is directly related to quantities sold.</li>
</ol>

<p><strong>How frequent are returns?</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">return_df</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">sales</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nf">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<p><em>Return per category</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">return_cats</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sales</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
<span class="n">return_cats</span><span class="p">[</span><span class="sh">'</span><span class="s">percent_return</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_cats</span><span class="p">[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">return_cats</span><span class="p">[</span><span class="sh">'</span><span class="s">sales</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">item_category_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">percent_return</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">return_cats</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">deep</span><span class="sh">"</span><span class="p">).</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Percentage of return per category</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_161_0.png" />
</figure>

<p><strong>Note</strong>: From the above, we can see that the item category 17 (Игровые консоли - Прочие, Game consoles - Other) experiences the highest rate of return (4.5%). This is helpful because this feature can be use to better predict the quantity returned every month.</p>

<p><em>Return per store</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">return_stores</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sales</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
<span class="n">return_stores</span><span class="p">[</span><span class="sh">'</span><span class="s">percent_return</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_stores</span><span class="p">[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">return_stores</span><span class="p">[</span><span class="sh">'</span><span class="s">sales</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">shop_id</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">percent_return</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">return_stores</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">deep</span><span class="sh">"</span><span class="p">).</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Return rate per store</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_165_0.png" />
</figure>

<p><strong>Note</strong>: The above plot shows that overall, the shops experience a similar rate of return (~0.4%). However, two stores (9 and 33) experience a higher rate of return with 0.7% and 0.85% respectively.</p>

<p><em>Return per month</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">return_month</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sales</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
<span class="n">return_month</span><span class="p">[</span><span class="sh">'</span><span class="s">percent_return</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_month</span><span class="p">[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">return_month</span><span class="p">[</span><span class="sh">'</span><span class="s">sales</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">percent_return</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">return_month</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">deep</span><span class="sh">"</span><span class="p">).</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Return rate per store</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_170_0.png" />
</figure>

<p>Before performing some feature engineering, we clean up the memory of unused variables.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">del</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axes</span>
<span class="k">del</span> <span class="n">bench_oct2015</span><span class="p">,</span> <span class="n">test_oct2015</span><span class="p">,</span> <span class="n">test_submission</span>
<span class="k">del</span> <span class="n">f</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">x_tick_vals</span>
<span class="k">del</span> <span class="n">i</span>
<span class="k">del</span> <span class="n">gp_cat_rev</span><span class="p">,</span> <span class="n">gp_category_mean</span><span class="p">,</span> <span class="n">gp_category_sum</span><span class="p">,</span> <span class="n">gp_shops_sum</span><span class="p">,</span> <span class="n">groups</span>
<span class="k">del</span> <span class="n">return_cats</span><span class="p">,</span> <span class="n">return_stores</span><span class="p">,</span> <span class="n">monthly_train</span><span class="p">,</span> <span class="n">monthly_sales</span>
</code></pre></div></div>

<hr />
<p><a id="Section_7"></a></p>
<h2 id="feature-engineering">Feature Engineering</h2>

<p>In this section, we leverage the valuable insights we obtained from the EDA by creating new features.
The first step consists of creating a function to help generate lag features. For instance, we want each monthly record to contain information about the sales from the n-th previous month.</p>

<h3 id="downcast">Downcast</h3>
<p>In order to save some memory, we downcast the floats and integers stored in the dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Datasize before downcast:</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">full_data</span><span class="p">.</span><span class="nf">info</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Datasize before downcast:
&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 11128004 entries, 0 to 11128003
Data columns (total 8 columns):
date_block_num      int16
shop_id             int16
item_id             int16
item_cnt_day        float32
city_id             int16
item_category_id    int16
type_id             int16
subtype_id          int16
dtypes: float32(1), int16(7)
memory usage: 275.9 MB
None
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">downcast_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
        Changes column types in the dataframe: 
                
                `float64` type to `float16`
                `int64`   type to `int16`http://localhost:8888/notebooks/Google%20Drive/2-Coding/1-Coursera/Advanced%20ML/2-Kaggle/Final%20Project/Final%20Project.ipynb#
    </span><span class="sh">'''</span>
    
    <span class="c1"># Select columns to downcast
</span>    <span class="n">float_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">dtype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">float64</span><span class="sh">"</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">dtype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">float32</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">int_cols</span> <span class="o">=</span>   <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span> <span class="nf">if </span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">dtype</span> <span class="o">==</span> <span class="sh">"</span><span class="s">int64</span><span class="sh">"</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">dtype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">int32</span><span class="sh">'</span>  <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">dtype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">int16</span><span class="sh">'</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c</span><span class="o">!=</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">)]</span>
    
    <span class="c1"># Downcast
</span>    <span class="n">df</span><span class="p">[</span><span class="n">float_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">float_cols</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">int_cols</span><span class="p">]</span>   <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">int_cols</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int8</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">full_data</span> <span class="o">=</span> <span class="nf">downcast_dtypes</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Datasize after downcast:</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">full_data</span><span class="p">.</span><span class="nf">info</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Datasize after downcast:
&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 11128004 entries, 0 to 11128003
Data columns (total 8 columns):
date_block_num      int8
shop_id             int8
item_id             int16
item_cnt_day        float16
city_id             int8
item_category_id    int8
type_id             int8
subtype_id          int8
dtypes: float16(1), int16(1), int8(6)
memory usage: 191.0 MB
None
</code></pre></div></div>

<p><a id="Section_71"></a></p>
<h3 id="new-features-and-encoding">New Features and Encoding</h3>

<p>Before we implement the lags, we need to define what features we want to lag. Based on the EDA, the following features will be used:</p>

<ul>
  <li>Per shop_id and item_id, we want to propagate the min, average, and max price</li>
  <li>Per shop_id and item id, we want to propagate the current streak of sales (in month)</li>
  <li>Per store_id, item_id, we want the number of returns</li>
  <li>Per item_id, we want to propagate the min, average, and max price</li>
  <li>Per item_id, we want the number of store selling the item</li>
  <li>Per shop_id, we want the number of item sold</li>
  <li>Per shop_id, we want the most famous category</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create return features
</span><span class="n">return_df</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">[[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">]]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ===========================
# create groups
# ===========================
</span>
<span class="c1"># items
</span><span class="n">group_item</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># store + item
</span><span class="n">group_store_item</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># store
</span><span class="n">group_store</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># category
</span><span class="n">group_cat</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># category + store
</span><span class="n">group_cat_store</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># type code
</span><span class="n">group_type</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># type + store
</span><span class="n">group_type_shop</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># subtype
</span><span class="n">group_subtype</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># subtype + store
</span><span class="n">group_subtype_shop</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># city
</span><span class="n">group_city</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># city + item
</span><span class="n">group_city_item</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># return per shop + item
</span><span class="n">return_shop_item</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">)</span>

<span class="c1"># return per shop
</span><span class="n">return_shop</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">)</span>

<span class="c1"># return per item
</span><span class="n">retun_item</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">)</span>

<span class="c1"># ===========================
# create encodings
# ===========================
</span>
<span class="c1"># PRICE
# min, max, average of price per items per month
</span><span class="n">monthly_sales_group</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">])</span>
<span class="n">min_max_avg_prices</span> <span class="o">=</span> <span class="n">monthly_sales_group</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">]).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">min_max_avg_prices</span> <span class="o">=</span> <span class="n">min_max_avg_prices</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">min_item_price</span><span class="sh">"</span><span class="p">,</span>
                                                        <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">max_item_price</span><span class="sh">"</span><span class="p">,</span>
                                                        <span class="sh">"</span><span class="s">mean</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">avg_item_price</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># min, max, average of price per item per item per store per month
</span><span class="n">monthly_sales_item_store_group</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">])</span>
<span class="n">min_max_avg_item_store</span> <span class="o">=</span> <span class="n">monthly_sales_item_store_group</span><span class="p">[</span><span class="sh">'</span><span class="s">item_price</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">]).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">min_max_avg_item_store</span> <span class="o">=</span> <span class="n">min_max_avg_item_store</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">min_item_shop_price</span><span class="sh">"</span><span class="p">,</span>
                                                                <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">max_item_shop_price</span><span class="sh">"</span><span class="p">,</span>
                                                                <span class="sh">"</span><span class="s">mean</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">avg_item_shop_price</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># RETURNS
# sum returns per store
</span><span class="n">return_shop</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">).</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">shop_return</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># sum returns per item
</span><span class="n">return_item</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">).</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">item_return</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># sum returns per category
</span><span class="n">return_cat</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">).</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">cat_return</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># sum returns per store + item
</span><span class="n">return_item_store</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">).</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">item_shop_return</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># sum returns per store per category
</span><span class="n">return_store_cat</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">).</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">return</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">cat_shop_return</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># SALES
# number of stores selling the item per month
</span><span class="n">store_count</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">store_count</span> <span class="o">=</span> <span class="n">store_count</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">shop_count</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># target item count
</span><span class="n">target_item</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
<span class="n">target_item</span> <span class="o">=</span> <span class="n">target_item</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">item_cnt_day</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">item_sold</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># number of unique items sold in store per month
</span><span class="n">unique_items</span> <span class="o">=</span> <span class="n">group_store</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">nunique</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">unique_items</span> <span class="o">=</span> <span class="n">unique_items</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">item_avail</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># number of item sold per category
</span><span class="n">cat_count</span> <span class="o">=</span> <span class="n">group_cat</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">cat_count</span> <span class="o">=</span> <span class="n">cat_count</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">avg_cat_count</span><span class="sh">'</span><span class="p">})</span>

<span class="c1"># nunber of item sold per category per store
</span><span class="n">cat_store_count</span> <span class="o">=</span> <span class="n">group_cat_store</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">cat_store_count</span> <span class="o">=</span> <span class="n">cat_store_count</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">avg_cat_store_count</span><span class="sh">'</span><span class="p">})</span>

<span class="c1"># TYPES AND SUBTYPES
# types
</span><span class="n">type_count</span> <span class="o">=</span> <span class="n">group_type</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">type_count</span> <span class="o">=</span> <span class="n">type_count</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">avg_type</span><span class="sh">'</span><span class="p">})</span>

<span class="n">type_store_count</span> <span class="o">=</span> <span class="n">group_type_shop</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">type_store_count</span> <span class="o">=</span> <span class="n">type_store_count</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">avg_type_store</span><span class="sh">'</span><span class="p">})</span>

<span class="c1"># subtype
</span><span class="n">subtype_count</span> <span class="o">=</span> <span class="n">group_subtype</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">subtype_count</span> <span class="o">=</span> <span class="n">subtype_count</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">avg_subtype</span><span class="sh">'</span><span class="p">})</span>

<span class="n">subtype_store_count</span> <span class="o">=</span> <span class="n">group_subtype_shop</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">subtype_store_count</span> <span class="o">=</span> <span class="n">subtype_store_count</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">avg_subtype_store</span><span class="sh">'</span><span class="p">})</span>

<span class="c1"># CITY
</span><span class="n">city_count</span> <span class="o">=</span> <span class="n">group_city</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">avg_city</span><span class="sh">'</span><span class="p">})</span>
<span class="n">city_count_item</span> <span class="o">=</span> <span class="n">group_city_item</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">avg_city_item</span><span class="sh">'</span><span class="p">})</span>
</code></pre></div></div>

<p>In addition to the encoded features, we need a function to compute streaks. Three streaks are considered:</p>
<ol>
  <li>Number of successive month the item has been sold (looking only at the previous months).</li>
  <li>Number of total sales for the item.</li>
  <li>Number of total sales for the item with a 0 for month during which sales=0.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">streak</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Return a new feature corresponding to the streak of the sales for an item.
    </span><span class="sh">"""</span>

    <span class="n">clone</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="n">col</span><span class="p">]].</span><span class="nf">copy</span><span class="p">()</span>

    <span class="c1"># sort clone (item_id, shop_id, data_block_num)
</span>    <span class="n">clone</span> <span class="o">=</span> <span class="n">clone</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">([</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">])</span>

    <span class="c1"># create new sold feature
</span>    <span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">sold</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">clone</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># create streak reset condition
</span>    <span class="n">reset</span> <span class="o">=</span> <span class="p">(</span><span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">sold</span><span class="sh">'</span><span class="p">]</span><span class="o">!=</span><span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">sold</span><span class="sh">'</span><span class="p">].</span><span class="nf">shift</span><span class="p">())</span> <span class="o">|</span> \
            <span class="p">(</span><span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]</span><span class="o">!=</span><span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">shift</span><span class="p">())</span> <span class="o">|</span> \
            <span class="p">(</span><span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">]</span><span class="o">!=</span><span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">shift</span><span class="p">())</span>

    <span class="c1"># create streak
</span>    <span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">streak</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">clone</span><span class="p">[</span><span class="sh">'</span><span class="s">sold</span><span class="sh">'</span><span class="p">].</span><span class="nf">groupby</span><span class="p">((</span><span class="n">reset</span><span class="p">).</span><span class="nf">cumsum</span><span class="p">()).</span><span class="nf">cumsum</span><span class="p">()</span>

    <span class="c1"># add total sales (10, 11, 0, 0, 5, 1, 0) =&gt; (10, 21, 21, 21, 26, 27, 27)
</span>    <span class="n">cum_sales_df</span> <span class="o">=</span> <span class="n">clone</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span>
        <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">])[</span><span class="n">col</span><span class="p">].</span><span class="nf">sum</span><span class="p">().</span><span class="nf">groupby</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]).</span><span class="nf">cumsum</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="sh">'</span><span class="s">cum_sales</span><span class="sh">'</span><span class="p">})</span>
    <span class="n">clone</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">clone</span><span class="p">,</span>
                     <span class="n">right</span><span class="o">=</span><span class="n">cum_sales_df</span><span class="p">,</span>
                     <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">],</span>
                     <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># delete column
</span>    <span class="k">del</span> <span class="n">clone</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

    <span class="c1"># merge streak with original df
</span>    <span class="n">return_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                         <span class="n">right</span><span class="o">=</span><span class="n">clone</span><span class="p">,</span>
                         <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">],</span>
                         <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># add sale streak in term of number (10, 11, 0, 0, 5, 1, 0) =&gt; (10, 21, 0, 0, 5, 6, 0)
</span>    <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">cum_if_sales</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">cum_sales</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># remove values of cum_if_sales for months without sales
</span>    <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">cum_if_sales</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">cum_if_sales</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">sold</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># delete column
</span>    <span class="k">del</span> <span class="n">return_df</span><span class="p">[</span><span class="sh">'</span><span class="s">sold</span><span class="sh">'</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">return_df</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># combine all new features with original dataframe and create sale streaks
</span><span class="n">key_item_store</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_item</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_store</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_store_cat</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_cat</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_type</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_type_shop</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_subype</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_subtype_shop</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_city</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">key_city_item</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filename</span> <span class="o">=</span> <span class="sh">'</span><span class="s">data</span><span class="sh">'</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># PRICE
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">min_max_avg_prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_item</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">min_max_avg_item_store</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_item_store</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># RETURNS
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">return_shop</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_store</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">return_item</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_item</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#full_data = pd.merge(left=full_data, right=return_cat, on=key_cat, how='left')
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">return_item_store</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_item_store</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#full_data = pd.merge(left=full_data, right=return_store_cat, on=key_store_cat, how='left')
</span>
<span class="c1"># SALES
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">store_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_item</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">target_item</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_item</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#full_data = pd.merge(left=full_data, right=unique_items, on=key_store, how='left')
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">cat_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_cat</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">cat_store_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_store_cat</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># TYPES AND SUBTYPES
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">type_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_type</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">type_store_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_type_shop</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">subtype_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_subype</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">full_data</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">subtype_store_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_subtype_shop</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># CITY
#full_data = pd.merge(left=full_data, right=city_count, on=key_city, how='left')
#full_data = pd.merge(left=full_data, right=city_count_item, on=key_city_item, how='left')
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fill_na
</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">min_item_price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max_item_price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avg_item_price</span><span class="sh">'</span><span class="p">,</span>
           <span class="sh">'</span><span class="s">min_item_shop_price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max_item_shop_price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avg_item_shop_price</span><span class="sh">'</span><span class="p">,</span> 
           <span class="sh">'</span><span class="s">shop_return</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_return</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_shop_return</span><span class="sh">'</span><span class="p">]</span>

<span class="n">full_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">columns</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># create data skreak
</span><span class="n">full_data</span> <span class="o">=</span> <span class="nf">streak</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">del</span> <span class="n">min_max_avg_prices</span><span class="p">,</span> <span class="n">min_max_avg_item_store</span><span class="p">,</span> <span class="n">return_shop</span><span class="p">,</span> <span class="n">return_item</span><span class="p">,</span> <span class="n">return_cat</span><span class="p">,</span> <span class="n">return_item_store</span>
<span class="k">del</span> <span class="n">return_store_cat</span><span class="p">,</span> <span class="n">store_count</span><span class="p">,</span> <span class="n">target_item</span><span class="p">,</span> <span class="n">unique_items</span><span class="p">,</span> <span class="n">cat_count</span><span class="p">,</span> <span class="n">cat_store_count</span>
<span class="k">del</span> <span class="n">type_count</span><span class="p">,</span> <span class="n">type_store_count</span><span class="p">,</span> <span class="n">subtype_count</span><span class="p">,</span> <span class="n">subtype_store_count</span>
<span class="k">del</span> <span class="n">city_count</span><span class="p">,</span> <span class="n">city_count_item</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">del</span> <span class="n">return_df</span><span class="p">,</span> <span class="n">return_shop_item</span><span class="p">,</span> <span class="n">return_month</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filename</span> <span class="o">=</span> <span class="sh">'</span><span class="s">data</span><span class="sh">'</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
<span class="c1">#with open(filename, 'rb') as infile:
#    full_data = pickle.load(infile)
</span></code></pre></div></div>

<p><a id="Section_73"></a></p>
<h3 id="lags">Lags</h3>

<p>In order for the past information to be available when making predictions for the current month, lagged features need to be created. They consists of conveying the information from the past to the current records. For instance, what was the number of sales for a specific pair of item and shop during the previous month.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># List of columns that we will use to create lags
</span><span class="n">index_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">no_shift</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">]</span>
<span class="n">cols_to_rename</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">full_data</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">difference</span><span class="p">(</span><span class="n">index_cols</span><span class="p">).</span><span class="nf">difference</span><span class="p">(</span><span class="n">no_shift</span><span class="p">))</span>
</code></pre></div></div>

<p>We can now create a set of lagged features using lags ranging from 1 to 12 months.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">lag_feature</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">lags</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    Add new lag columns to the dataframe (df).
    Inputs:
        df: input dataframe containing time-series data.
        lags: list of integer corresponding to the desired lags.
    </span><span class="sh">'''</span>
    <span class="k">for</span> <span class="n">month_shift</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="n">lags</span><span class="p">):</span>
     
        <span class="c1"># clone df
</span>        <span class="n">df_shift</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">index_cols</span> <span class="o">+</span> <span class="n">cols</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>

        <span class="c1"># shift date_block_num
</span>        <span class="n">df_shift</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_shift</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="n">month_shift</span>

        <span class="c1"># dummy rename function
</span>        <span class="n">foo</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sh">'</span><span class="s">{}_lag_{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">month_shift</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">else</span> <span class="n">x</span>

        <span class="c1"># rename columns
</span>        <span class="n">df_shift</span> <span class="o">=</span> <span class="n">df_shift</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">foo</span><span class="p">)</span>

        <span class="c1"># downcast
</span>        <span class="n">df_shift</span> <span class="o">=</span> <span class="nf">downcast_dtypes</span><span class="p">(</span><span class="n">df_shift</span><span class="p">)</span>
        
        <span class="c1"># merge original data with shift
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_shift</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">index_cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">).</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create lags
</span><span class="n">full_data</span> <span class="o">=</span> <span class="nf">lag_feature</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="sh">'</span><span class="s">avg_cat_count</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avg_cat_store_count</span><span class="sh">'</span><span class="p">,</span>
                                         <span class="sh">'</span><span class="s">avg_subtype</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avg_subtype_store</span><span class="sh">'</span><span class="p">,</span>
                                         <span class="sh">'</span><span class="s">avg_type</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avg_type_store</span><span class="sh">'</span><span class="p">,</span>
                                         <span class="sh">'</span><span class="s">item_return</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_shop_return</span><span class="sh">'</span><span class="p">,</span>
                                         <span class="sh">'</span><span class="s">item_sold</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_count</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_return</span><span class="sh">'</span><span class="p">])</span>

<span class="n">full_data</span> <span class="o">=</span> <span class="nf">lag_feature</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="sh">'</span><span class="s">min_item_price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avg_item_price</span><span class="sh">'</span><span class="p">,</span>
                                               <span class="sh">'</span><span class="s">cum_if_sales</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cum_sales</span><span class="sh">'</span><span class="p">,</span>
                                               <span class="sh">'</span><span class="s">max_item_price</span><span class="sh">'</span><span class="p">])</span>

<span class="n">full_data</span> <span class="o">=</span> <span class="nf">lag_feature</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="sh">'</span><span class="s">max_item_shop_price</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">min_item_shop_price</span><span class="sh">'</span><span class="p">,</span>
                                                   <span class="sh">'</span><span class="s">avg_item_shop_price</span><span class="sh">'</span><span class="p">])</span>

<span class="n">full_data</span> <span class="o">=</span> <span class="nf">lag_feature</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">streak</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=0, max=1), HTML(value='')))






HBox(children=(IntProgress(value=0, max=4), HTML(value='')))






HBox(children=(IntProgress(value=0, max=6), HTML(value='')))






HBox(children=(IntProgress(value=0, max=7), HTML(value='')))
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Extract time based features.
</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">x</span><span class="o">//</span><span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2013</span><span class="p">))</span>
<span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">12</span><span class="p">))</span>
</code></pre></div></div>

<hr />
<p><a id="Section_8"></a></p>
<h2 id="train--test-split">Train / Test Split</h2>

<p>The objective of the model is to accurately predict sales of the 34th month. Since the test set is defined in the future of our available dataset, we need to respect the same conditions when defining our train/validation split. That is, the months included in the validation split should be posterior to the train period.</p>
<ul>
  <li>The training set is defined using months 12 to 28 (we remove the first 12 months as the data may be too old to accurately represent current trends in the sales).</li>
  <li>The validation set is defined using months 29 to 33 and the test set will use block 34.</li>
</ul>

<p>In addition, the goal of this competition is to predict the sales of month N without any information related to month N. Therefore, we delete from our dataset the features that are related to the sales of the current month.</p>

<h3 id="purge-features">Purge Features</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># metrics related to the sales of current month (to be deleted)
</span><span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">min_item_price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_item_price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">avg_item_price</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">min_item_shop_price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_item_shop_price</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">avg_item_shop_price</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">shop_return</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">item_return</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">item_shop_return</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">shop_count</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">item_sold</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">item_avail</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">avg_cat_count</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">avg_cat_store_count</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">avg_type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">avg_type_store</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">avg_subtype</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">avg_subtype_store</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">streak</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">cum_sales</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cum_if_sales</span><span class="sh">"</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># purge full set of columns to be deleted
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">difference</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)]</span>
</code></pre></div></div>

<p>Now we delete the first 12 months worth of data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># remove first 12 months (null lag and old data)
</span><span class="n">full_data</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">12</span><span class="p">)]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filename</span> <span class="o">=</span> <span class="sh">'</span><span class="s">data_before_split</span><span class="sh">'</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
<span class="c1">#with open(filename, 'rb') as infile:
#    full_data = pickle.load(infile)
</span></code></pre></div></div>

<h3 id="make-splits">Make Splits</h3>

<p>Finally, we split the dataset into a training, a validation, and a test set according to the rules defined above.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># train set
</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">].</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">],</span>
                                                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_train_dates</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">][</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">][</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># validation set for first-layer model
</span><span class="n">X_valid</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">)].</span><span class="nf">drop</span><span class="p">(</span>
                        <span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_valid_dates</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">)][</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">Y_valid</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">)][</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># validation set for meta-model
</span><span class="n">X_valid_meta</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">33</span><span class="p">].</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_valid_meta_dates</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">33</span><span class="p">][</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span>
<span class="n">Y_valid_meta</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">33</span><span class="p">][</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># test set (predictions)
</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">34</span><span class="p">].</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">],</span>
                                                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>We create a checkpoint by pickling our train, validation, and test sets.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># train
</span><span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_train.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">Y_train.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_train_dates</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_train_dates.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>

<span class="c1"># validation
</span><span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">Y_valid</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">Y_valid.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_valid_dates</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid_dates.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>

<span class="c1"># validation meta
</span><span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_valid_meta</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid_meta.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">Y_valid_meta</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">Y_valid_meta.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_valid_meta_dates</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid_meta_dates.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>

<span class="c1"># test
</span><span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_test.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="validate-split-strategy">Validate Split Strategy</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># define number of total records
</span><span class="n">n_rows</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X_test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X_valid_meta</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># print fractions
</span><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Train set records:</span><span class="sh">'</span><span class="p">,</span> <span class="n">X_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Validation set records:</span><span class="sh">'</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Meta validation set records:</span><span class="sh">'</span><span class="p">,</span> <span class="n">X_valid_meta</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Test set records:</span><span class="sh">'</span><span class="p">,</span> <span class="n">X_test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Train set records: %s (%.f%% of complete data)</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">X_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="n">X_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n_rows</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Validation set records: %s (%.f%% of complete data)</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">X_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="n">X_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n_rows</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Meta validation set records: %s (%.f%% of complete data)</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">X_valid_meta</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="n">X_valid_meta</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n_rows</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Train set records: 5068102
Validation set records: 1118820
Meta validation set records: 238172
Test set records: 214200
Train set records: 5068102 (76% of complete data)
Validation set records: 1118820 (17% of complete data)
Meta validation set records: 238172 (4% of complete data)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">mean for whole train set: {0}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
    <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">full_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span>
        <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">mean for validation train set: {0}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
    <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">full_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">),</span> <span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span>
        <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">))))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mean for whole train set: 0.29374054074287415
mean for validation train set: 0.2667059898376465
</code></pre></div></div>

<p><strong>Note</strong>: the above means are very close to the value obtained by probing the leaderboard.</p>

<p>Since we have been generating a lot of data, it is important to clear unnecessary variable. We have created our train, validation, and test set so the full dataset can be deleted.</p>

<p>Finally, we can look at new records in the test set, that is pairs the set of <code class="language-plaintext highlighter-rouge">item_id</code> from the test set not included in the train set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">item_in_test_only</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()).</span><span class="nf">difference</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Items in test and not in train: {0}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">item_in_test_only</span><span class="p">)))</span>
<span class="n">item_in_train_only</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()).</span><span class="nf">difference</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Items in train and not in test: {0}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">item_in_train_only</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Items in test and not in train: 1499
Items in train and not in test: 11626
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">del</span> <span class="n">full_data</span>
</code></pre></div></div>

<hr />
<p><a id="Section_9"></a></p>
<h2 id="models">Models</h2>

<p>We are now ready to train our models. We are going to follow a typical ensembling process:</p>
<ol>
  <li>Examine feature importance to see if PCA is needed.</li>
  <li>Create first layer models.</li>
  <li>For the promising base-layer models, fine-tune the hyperparameters.</li>
  <li>Stack model using a meta-model.</li>
</ol>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/stacking_cv_regressor_overview.png" style="height: 500px;" />
</figure>

<p><a id="Section_75"></a></p>
<h3 id="feature-importance">Feature Importance</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pickle</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">xgboost</span>
<span class="kn">from</span> <span class="n">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>
<span class="kn">import</span> <span class="n">gc</span>

<span class="n">gc</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
<span class="c1"># reload
</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">X_train.pickle</span><span class="sh">'</span><span class="p">)</span>
<span class="n">X_train_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">X_train_dates.pickle</span><span class="sh">'</span><span class="p">)</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">Y_train.pickle</span><span class="sh">'</span><span class="p">)</span>

<span class="n">X_valid</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid.pickle</span><span class="sh">'</span><span class="p">)</span>
<span class="n">X_valid_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid_dates.pickle</span><span class="sh">'</span><span class="p">)</span>
<span class="n">Y_valid</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">Y_valid.pickle</span><span class="sh">'</span><span class="p">)</span>

<span class="n">X_valid_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid_meta.pickle</span><span class="sh">'</span><span class="p">)</span>
<span class="n">X_valid_meta_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">X_valid_meta_dates.pickle</span><span class="sh">'</span><span class="p">)</span>
<span class="n">Y_valid_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">Y_valid_meta.pickle</span><span class="sh">'</span><span class="p">)</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">X_test.pickle</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>In order to obtain the feature importances, we create a simple tree-based model (Random-Forest) and extract the feature importances.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create simple random forest
</span><span class="n">forest</span> <span class="o">=</span> <span class="nc">ExtraTreesRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                              <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># train model on training set
</span><span class="n">forest</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>

<span class="c1"># extract feature importances
</span><span class="n">importances</span> <span class="o">=</span> <span class="n">forest</span><span class="p">.</span><span class="n">feature_importances_</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">std</span><span class="p">([</span><span class="n">tree</span><span class="p">.</span><span class="n">feature_importances_</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">forest</span><span class="p">.</span><span class="n">estimators_</span><span class="p">],</span>
             <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="n">importances</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 4 concurrent workers.
[Parallel(n_jobs=-1)]: Done  42 tasks      | elapsed: 51.8min
[Parallel(n_jobs=-1)]: Done  50 out of  50 | elapsed: 58.1min finished
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pd</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">999</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">X_train</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span><span class="sh">'</span><span class="s">score_mean</span><span class="sh">'</span><span class="p">:</span><span class="n">importances</span><span class="p">,</span><span class="sh">'</span><span class="s">score_std</span><span class="sh">'</span><span class="p">:</span><span class="n">std</span><span class="p">})</span>
<span class="n">feature_importance</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">'</span><span class="s">score_mean</span><span class="sh">'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature</th>
      <th>score_mean</th>
      <th>score_std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>27</td>
      <td>item_cnt_day_lag_1</td>
      <td>0.305195</td>
      <td>0.042668</td>
    </tr>
    <tr>
      <td>34</td>
      <td>item_id</td>
      <td>0.125091</td>
      <td>0.003394</td>
    </tr>
    <tr>
      <td>60</td>
      <td>shop_id</td>
      <td>0.039580</td>
      <td>0.002824</td>
    </tr>
    <tr>
      <td>37</td>
      <td>item_sold_lag_1</td>
      <td>0.038010</td>
      <td>0.021622</td>
    </tr>
    <tr>
      <td>16</td>
      <td>city_id</td>
      <td>0.027129</td>
      <td>0.001806</td>
    </tr>
    <tr>
      <td>58</td>
      <td>month</td>
      <td>0.025071</td>
      <td>0.002134</td>
    </tr>
    <tr>
      <td>29</td>
      <td>item_cnt_day_lag_2</td>
      <td>0.024382</td>
      <td>0.027393</td>
    </tr>
    <tr>
      <td>13</td>
      <td>avg_subtype_store_lag_1</td>
      <td>0.021515</td>
      <td>0.006218</td>
    </tr>
    <tr>
      <td>69</td>
      <td>subtype_id</td>
      <td>0.021043</td>
      <td>0.004745</td>
    </tr>
    <tr>
      <td>26</td>
      <td>item_category_id</td>
      <td>0.018220</td>
      <td>0.004668</td>
    </tr>
    <tr>
      <td>25</td>
      <td>date_block_num</td>
      <td>0.017076</td>
      <td>0.001475</td>
    </tr>
    <tr>
      <td>15</td>
      <td>avg_type_store_lag_1</td>
      <td>0.016783</td>
      <td>0.000826</td>
    </tr>
    <tr>
      <td>1</td>
      <td>avg_cat_store_count_lag_1</td>
      <td>0.016078</td>
      <td>0.001597</td>
    </tr>
    <tr>
      <td>30</td>
      <td>item_cnt_day_lag_3</td>
      <td>0.015121</td>
      <td>0.008848</td>
    </tr>
    <tr>
      <td>61</td>
      <td>shop_return_lag_1</td>
      <td>0.013561</td>
      <td>0.000370</td>
    </tr>
    <tr>
      <td>18</td>
      <td>cum_if_sales_lag_2</td>
      <td>0.012104</td>
      <td>0.014885</td>
    </tr>
    <tr>
      <td>17</td>
      <td>cum_if_sales_lag_1</td>
      <td>0.011855</td>
      <td>0.017054</td>
    </tr>
    <tr>
      <td>62</td>
      <td>streak_lag_1</td>
      <td>0.009901</td>
      <td>0.017725</td>
    </tr>
    <tr>
      <td>31</td>
      <td>item_cnt_day_lag_4</td>
      <td>0.009412</td>
      <td>0.008743</td>
    </tr>
    <tr>
      <td>48</td>
      <td>min_item_price_lag_1</td>
      <td>0.008958</td>
      <td>0.000425</td>
    </tr>
    <tr>
      <td>59</td>
      <td>shop_count_lag_1</td>
      <td>0.008888</td>
      <td>0.000927</td>
    </tr>
    <tr>
      <td>21</td>
      <td>cum_sales_lag_1</td>
      <td>0.008629</td>
      <td>0.004356</td>
    </tr>
    <tr>
      <td>14</td>
      <td>avg_type_lag_1</td>
      <td>0.008317</td>
      <td>0.000455</td>
    </tr>
    <tr>
      <td>0</td>
      <td>avg_cat_count_lag_1</td>
      <td>0.008092</td>
      <td>0.000505</td>
    </tr>
    <tr>
      <td>12</td>
      <td>avg_subtype_lag_1</td>
      <td>0.008021</td>
      <td>0.000505</td>
    </tr>
    <tr>
      <td>22</td>
      <td>cum_sales_lag_2</td>
      <td>0.007750</td>
      <td>0.006408</td>
    </tr>
    <tr>
      <td>70</td>
      <td>type_id</td>
      <td>0.007607</td>
      <td>0.001340</td>
    </tr>
    <tr>
      <td>49</td>
      <td>min_item_price_lag_2</td>
      <td>0.006894</td>
      <td>0.000784</td>
    </tr>
    <tr>
      <td>2</td>
      <td>avg_item_price_lag_1</td>
      <td>0.006879</td>
      <td>0.000407</td>
    </tr>
    <tr>
      <td>32</td>
      <td>item_cnt_day_lag_5</td>
      <td>0.006349</td>
      <td>0.001230</td>
    </tr>
    <tr>
      <td>3</td>
      <td>avg_item_price_lag_2</td>
      <td>0.006176</td>
      <td>0.000789</td>
    </tr>
    <tr>
      <td>38</td>
      <td>max_item_price_lag_1</td>
      <td>0.005687</td>
      <td>0.000350</td>
    </tr>
    <tr>
      <td>52</td>
      <td>min_item_shop_price_lag_1</td>
      <td>0.005490</td>
      <td>0.006499</td>
    </tr>
    <tr>
      <td>23</td>
      <td>cum_sales_lag_3</td>
      <td>0.005310</td>
      <td>0.001466</td>
    </tr>
    <tr>
      <td>50</td>
      <td>min_item_price_lag_3</td>
      <td>0.005241</td>
      <td>0.000841</td>
    </tr>
    <tr>
      <td>33</td>
      <td>item_cnt_day_lag_6</td>
      <td>0.005217</td>
      <td>0.000389</td>
    </tr>
    <tr>
      <td>28</td>
      <td>item_cnt_day_lag_12</td>
      <td>0.005185</td>
      <td>0.000260</td>
    </tr>
    <tr>
      <td>39</td>
      <td>max_item_price_lag_2</td>
      <td>0.005158</td>
      <td>0.000609</td>
    </tr>
    <tr>
      <td>35</td>
      <td>item_return_lag_1</td>
      <td>0.005050</td>
      <td>0.000282</td>
    </tr>
    <tr>
      <td>71</td>
      <td>year</td>
      <td>0.004917</td>
      <td>0.000670</td>
    </tr>
    <tr>
      <td>51</td>
      <td>min_item_price_lag_4</td>
      <td>0.004894</td>
      <td>0.000623</td>
    </tr>
    <tr>
      <td>6</td>
      <td>avg_item_shop_price_lag_1</td>
      <td>0.004718</td>
      <td>0.003328</td>
    </tr>
    <tr>
      <td>24</td>
      <td>cum_sales_lag_4</td>
      <td>0.004653</td>
      <td>0.000653</td>
    </tr>
    <tr>
      <td>64</td>
      <td>streak_lag_2</td>
      <td>0.004480</td>
      <td>0.004787</td>
    </tr>
    <tr>
      <td>4</td>
      <td>avg_item_price_lag_3</td>
      <td>0.004368</td>
      <td>0.000997</td>
    </tr>
    <tr>
      <td>19</td>
      <td>cum_if_sales_lag_3</td>
      <td>0.004304</td>
      <td>0.002244</td>
    </tr>
    <tr>
      <td>5</td>
      <td>avg_item_price_lag_4</td>
      <td>0.004222</td>
      <td>0.000603</td>
    </tr>
    <tr>
      <td>40</td>
      <td>max_item_price_lag_3</td>
      <td>0.004156</td>
      <td>0.000745</td>
    </tr>
    <tr>
      <td>41</td>
      <td>max_item_price_lag_4</td>
      <td>0.004048</td>
      <td>0.001032</td>
    </tr>
    <tr>
      <td>42</td>
      <td>max_item_shop_price_lag_1</td>
      <td>0.004008</td>
      <td>0.000292</td>
    </tr>
    <tr>
      <td>63</td>
      <td>streak_lag_12</td>
      <td>0.004008</td>
      <td>0.000249</td>
    </tr>
    <tr>
      <td>20</td>
      <td>cum_if_sales_lag_4</td>
      <td>0.003543</td>
      <td>0.000916</td>
    </tr>
    <tr>
      <td>65</td>
      <td>streak_lag_3</td>
      <td>0.003189</td>
      <td>0.002778</td>
    </tr>
    <tr>
      <td>68</td>
      <td>streak_lag_6</td>
      <td>0.002993</td>
      <td>0.000258</td>
    </tr>
    <tr>
      <td>67</td>
      <td>streak_lag_5</td>
      <td>0.002671</td>
      <td>0.000333</td>
    </tr>
    <tr>
      <td>66</td>
      <td>streak_lag_4</td>
      <td>0.002589</td>
      <td>0.000574</td>
    </tr>
    <tr>
      <td>53</td>
      <td>min_item_shop_price_lag_2</td>
      <td>0.002463</td>
      <td>0.000299</td>
    </tr>
    <tr>
      <td>7</td>
      <td>avg_item_shop_price_lag_2</td>
      <td>0.002361</td>
      <td>0.000242</td>
    </tr>
    <tr>
      <td>43</td>
      <td>max_item_shop_price_lag_2</td>
      <td>0.002280</td>
      <td>0.000286</td>
    </tr>
    <tr>
      <td>54</td>
      <td>min_item_shop_price_lag_3</td>
      <td>0.002064</td>
      <td>0.000261</td>
    </tr>
    <tr>
      <td>57</td>
      <td>min_item_shop_price_lag_6</td>
      <td>0.002018</td>
      <td>0.000140</td>
    </tr>
    <tr>
      <td>56</td>
      <td>min_item_shop_price_lag_5</td>
      <td>0.001937</td>
      <td>0.000142</td>
    </tr>
    <tr>
      <td>8</td>
      <td>avg_item_shop_price_lag_3</td>
      <td>0.001932</td>
      <td>0.000148</td>
    </tr>
    <tr>
      <td>44</td>
      <td>max_item_shop_price_lag_3</td>
      <td>0.001898</td>
      <td>0.000224</td>
    </tr>
    <tr>
      <td>47</td>
      <td>max_item_shop_price_lag_6</td>
      <td>0.001890</td>
      <td>0.000154</td>
    </tr>
    <tr>
      <td>11</td>
      <td>avg_item_shop_price_lag_6</td>
      <td>0.001880</td>
      <td>0.000111</td>
    </tr>
    <tr>
      <td>10</td>
      <td>avg_item_shop_price_lag_5</td>
      <td>0.001860</td>
      <td>0.000095</td>
    </tr>
    <tr>
      <td>55</td>
      <td>min_item_shop_price_lag_4</td>
      <td>0.001816</td>
      <td>0.000130</td>
    </tr>
    <tr>
      <td>46</td>
      <td>max_item_shop_price_lag_5</td>
      <td>0.001812</td>
      <td>0.000124</td>
    </tr>
    <tr>
      <td>9</td>
      <td>avg_item_shop_price_lag_4</td>
      <td>0.001726</td>
      <td>0.000107</td>
    </tr>
    <tr>
      <td>45</td>
      <td>max_item_shop_price_lag_4</td>
      <td>0.001710</td>
      <td>0.000148</td>
    </tr>
    <tr>
      <td>36</td>
      <td>item_shop_return_lag_1</td>
      <td>0.000569</td>
      <td>0.000060</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>Note</strong>: As shown above, several of our lag (1) features appears to be essential. This is a good sign as it shows that our EDA and feature engineering was done properly.</p>

<p><a id="Section_91"></a></p>
<h3 id="target-distribution">Target Distribution</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Train</span><span class="sh">'</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">Y_valid</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">norm_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Validation</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">legend</span><span class="p">();</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_231_0.png" />
</figure>

<p><a id="Section_91"></a></p>
<h3 id="first-level-models">First Level Models</h3>

<h4 id="scaling-and-encoding">Scaling and Encoding</h4>
<p>Because we have encoded features related to the price and average features, it is important to have a common scale when feeding our dataset into models like the Linear Regression. These models are very sensitive to data scale</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="n">X_train</span><span class="p">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">X_train</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="n">dtype</span><span class="o">!=</span><span class="sh">'</span><span class="s">int8</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">X_train</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="n">dtype</span><span class="o">!=</span><span class="sh">'</span><span class="s">int16</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="nc">MinMaxScaler</span><span class="p">().</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
        
        <span class="n">X_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
        <span class="n">X_valid</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">X_valid</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
        <span class="n">X_valid_meta</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">X_valid_meta</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
        <span class="n">X_test</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=0, max=72), HTML(value='')))
</code></pre></div></div>

<h4 id="simple-model-selection">Simple Model Selection</h4>

<p>In this section, we train several basic models with their default parameters and we compare how they perform on the validation set. The goal is to identify model with potential. The selected models will then be finely tuned.</p>

<p><strong>Note</strong>: Our dataset contains categorical features encoded using index integers. In order to train a linear model on the dataset, we need to remove these categorical features from the sets.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># features to be removed when training a linear model
</span><span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">city_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_category_id</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">subtype_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">type_id</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># select subset of features for linear models
</span><span class="n">X_train_lin</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">X_train</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">difference</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)]</span>
<span class="n">X_valid_lin</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">X_valid</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">difference</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)]</span>
<span class="n">X_valid_meta_lin</span> <span class="o">=</span> <span class="n">X_valid_meta</span><span class="p">[</span><span class="n">X_valid_meta</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">difference</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)]</span>
<span class="n">X_test_lin</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">X_test</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">difference</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)]</span>
</code></pre></div></div>

<p>We now train several simple models using their default parameter to assess their potential.</p>

<p>Our candidates consist of a set of tree-based models and a set of models not able to handle categorical features. We therefore create a test and train set without categorical features.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">models_trees</span> <span class="o">=</span> <span class="p">[</span><span class="nc">ExtraTreesRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                <span class="nc">RandomForestRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                <span class="nc">LGBMRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                <span class="nc">XGBRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="sh">'</span><span class="s">reg:squarederror</span><span class="sh">'</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">models_lin</span> <span class="o">=</span> <span class="p">[</span><span class="nc">Lasso</span><span class="p">(),</span> <span class="nc">ElasticNet</span><span class="p">(),</span> <span class="nc">BayesianRidge</span><span class="p">(),</span> <span class="nc">LinearRegression</span><span class="p">()]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># results summary
</span><span class="n">summary_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Model</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Parameters (Pre)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">train_RMSE</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">val_RMSE</span><span class="sh">'</span><span class="p">]</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">summary_cols</span><span class="p">)</span>

<span class="n">pred_valid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">train_estimator</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">estimators</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">pred_df</span><span class="p">):</span>
    
    <span class="n">n_rows</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="nf">enumerate</span><span class="p">(</span><span class="n">estimators</span><span class="p">)):</span>
        
        <span class="c1"># identify model
</span>        <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">n_rows</span><span class="p">,</span> <span class="sh">'</span><span class="s">Model</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimator</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span>
        <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">n_rows</span><span class="p">,</span><span class="sh">'</span><span class="s">Parameters (Pre)</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">estimator</span><span class="p">.</span><span class="nf">get_params</span><span class="p">())</span>
        
        <span class="c1"># train model
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Training:</span><span class="sh">"</span><span class="p">,</span> <span class="n">estimator</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">estimator</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s">training time: {:.1f}s</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">ts</span><span class="p">))</span>
        
        <span class="c1"># compute metrics    
</span>        <span class="n">pred_valid</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">estimator</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">x_valid</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
        <span class="n">pred_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">estimator</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
        <span class="n">rmse_val</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pred_valid</span><span class="p">))</span>
        <span class="n">rmse_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">pred_train</span><span class="p">))</span>
        
        <span class="c1"># save metrics
</span>        <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">n_rows</span><span class="p">,</span> <span class="sh">'</span><span class="s">train_RMSE</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmse_train</span>
        <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">n_rows</span><span class="p">,</span> <span class="sh">'</span><span class="s">val_RMSE</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmse_val</span>
        
        <span class="n">pred_df</span><span class="p">[</span><span class="n">estimator</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_valid</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="n">estimator</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="sh">'</span><span class="s">trained...</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="k">del</span> <span class="n">estimator</span>
        <span class="n">gc</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
            
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">([</span><span class="sh">'</span><span class="s">val_RMSE</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">df</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">pred_df</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summary_df</span><span class="p">,</span> <span class="n">pred_valid_df</span>  <span class="o">=</span> <span class="nf">train_estimator</span><span class="p">(</span><span class="n">X_train_lin</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span>
                                             <span class="n">X_valid_lin</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">,</span>
                                             <span class="n">models_lin</span><span class="p">,</span> <span class="n">summary_df</span><span class="p">,</span> <span class="n">pred_valid_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=1, bar_style='info', max=1), HTML(value='')))


--------------------------------------------------
Training: Lasso
	training time: 6.5s
Lasso trained...
--------------------------------------------------
Training: ElasticNet
	training time: 4.4s
ElasticNet trained...
--------------------------------------------------
Training: BayesianRidge
	training time: 21.7s
BayesianRidge trained...
--------------------------------------------------
Training: LinearRegression
	training time: 7.9s
LinearRegression trained...
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summary_df</span><span class="p">,</span> <span class="n">pred_valid_df</span>  <span class="o">=</span> <span class="nf">train_estimator</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span>
                             <span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">,</span>
                             <span class="n">models_trees</span><span class="p">,</span> <span class="n">summary_df</span><span class="p">,</span> <span class="n">pred_valid_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=1, bar_style='info', max=1), HTML(value='')))


--------------------------------------------------
Training: ExtraTreesRegressor



[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 4 concurrent workers.


building tree 1 of 10building tree 2 of 10
building tree 3 of 10
building tree 4 of 10

building tree 5 of 10
building tree 6 of 10
building tree 7 of 10
building tree 8 of 10
building tree 9 of 10
building tree 10 of 10


[Parallel(n_jobs=-1)]: Done  10 out of  10 | elapsed:  9.8min finished


	training time: 591.2s


[Parallel(n_jobs=4)]: Using backend ThreadingBackend with 4 concurrent workers.
[Parallel(n_jobs=4)]: Done  10 out of  10 | elapsed:    1.6s finished
[Parallel(n_jobs=4)]: Using backend ThreadingBackend with 4 concurrent workers.
[Parallel(n_jobs=4)]: Done  10 out of  10 | elapsed:    7.8s finished


ExtraTreesRegressor trained...
--------------------------------------------------
Training: RandomForestRegressor


[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 4 concurrent workers.


building tree 1 of 10building tree 2 of 10
building tree 3 of 10
building tree 4 of 10

building tree 5 of 10
building tree 6 of 10
building tree 7 of 10
building tree 8 of 10
building tree 9 of 10
building tree 10 of 10


[Parallel(n_jobs=-1)]: Done  10 out of  10 | elapsed: 15.5min finished


	training time: 932.4s


[Parallel(n_jobs=4)]: Using backend ThreadingBackend with 4 concurrent workers.
[Parallel(n_jobs=4)]: Done  10 out of  10 | elapsed:    1.7s finished
[Parallel(n_jobs=4)]: Using backend ThreadingBackend with 4 concurrent workers.
[Parallel(n_jobs=4)]: Done  10 out of  10 | elapsed:    7.5s finished


RandomForestRegressor trained...
--------------------------------------------------
Training: LGBMRegressor
	training time: 64.9s
LGBMRegressor trained...
--------------------------------------------------
Training: XGBRegressor

	training time: 3223.7s
XGBRegressor trained...
</code></pre></div></div>

<p>Below are the results of our basic models. As we can see, the Lasso and ElasticNet model contain too much regularization and are not able to make predictions.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summary_df</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Model</th>
      <th>Parameters (Pre)</th>
      <th>train_RMSE</th>
      <th>val_RMSE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>6</td>
      <td>LGBMRegressor</td>
      <td>{'boosting_type': 'gbdt', 'class_weight': None...</td>
      <td>0.826947</td>
      <td>0.813052</td>
    </tr>
    <tr>
      <td>7</td>
      <td>XGBRegressor</td>
      <td>{'base_score': 0.5, 'booster': 'gbtree', 'cols...</td>
      <td>0.897198</td>
      <td>0.822411</td>
    </tr>
    <tr>
      <td>2</td>
      <td>BayesianRidge</td>
      <td>{'alpha_1': 1e-06, 'alpha_2': 1e-06, 'compute_...</td>
      <td>0.933291</td>
      <td>0.838651</td>
    </tr>
    <tr>
      <td>3</td>
      <td>LinearRegression</td>
      <td>{'copy_X': True, 'fit_intercept': True, 'n_job...</td>
      <td>0.933289</td>
      <td>0.838666</td>
    </tr>
    <tr>
      <td>5</td>
      <td>RandomForestRegressor</td>
      <td>{'bootstrap': True, 'criterion': 'mse', 'max_d...</td>
      <td>0.329639</td>
      <td>0.878088</td>
    </tr>
    <tr>
      <td>4</td>
      <td>ExtraTreesRegressor</td>
      <td>{'bootstrap': False, 'criterion': 'mse', 'max_...</td>
      <td>0</td>
      <td>0.878273</td>
    </tr>
    <tr>
      <td>0</td>
      <td>Lasso</td>
      <td>{'alpha': 1.0, 'copy_X': True, 'fit_intercept'...</td>
      <td>1.21245</td>
      <td>1.07186</td>
    </tr>
    <tr>
      <td>1</td>
      <td>ElasticNet</td>
      <td>{'alpha': 1.0, 'copy_X': True, 'fit_intercept'...</td>
      <td>1.21245</td>
      <td>1.07186</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot results
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="sh">"</span><span class="s">val_RMSE</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">Model</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">)</span>
<span class="n">g</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Mean Accuracy</span><span class="sh">"</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Validation scores</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_249_0.png" />
</figure>

<p>When blending models, we need to combine models that are not “too” correlated. Therefore, we plot the correlations in the predictions of our models.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute the correlation matrix
</span><span class="n">corr</span> <span class="o">=</span> <span class="n">pred_valid_df</span><span class="p">.</span><span class="nf">corr</span><span class="p">()</span>

<span class="c1"># Generate a mask for the upper triangle
</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">triu_indices_from</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># Generate a custom diverging colormap
</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">diverging_palette</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">with</span> <span class="n">sns</span><span class="p">.</span><span class="nf">axes_style</span><span class="p">(</span><span class="sh">"</span><span class="s">white</span><span class="sh">"</span><span class="p">):</span>    
    <span class="c1"># Set up the matplotlib figure
</span>    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
    
    <span class="c1"># Draw the heatmap with the mask and correct aspect ratio
</span>    <span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">square</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">shrink</span><span class="sh">"</span><span class="p">:</span> <span class="p">.</span><span class="mi">4</span><span class="p">})</span>
    
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div></div>

<figure>
    <img src="https://tdody.github.io/assets/img/2019-11-10-Sales-Forecast/output_251_0.png" />
</figure>

<p>As we can see, the Lasso and ElasticNet model only predict 0, this is due to a poor regularization parameter value. We will keep these model and finely tune them</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tune_model</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">):</span>
    <span class="c1"># extract parameters to be tuned and candidate values
</span>    <span class="n">params</span> <span class="o">=</span> <span class="n">grid_params</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">grid_params</span><span class="p">.</span><span class="nf">values</span><span class="p">()</span>
    
    <span class="c1"># create all combinations
</span>    <span class="n">combinations</span> <span class="o">=</span> <span class="nf">product</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
    
    <span class="c1"># store results
</span>    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">return_obj</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># iterate 
</span>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
        <span class="c1"># format header for readability
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL {0}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="c1"># recreate input params
</span>        <span class="n">current_param</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combo</span><span class="p">))</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">current_param</span><span class="p">)</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">current_param</span><span class="p">)</span>
        
        <span class="c1"># train model
</span>        <span class="n">model</span> <span class="o">=</span> <span class="nf">estimator</span><span class="p">(</span><span class="o">**</span><span class="n">current_param</span><span class="p">)</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s">training done: {:.2f}s</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">ts</span><span class="p">))</span>
        
        <span class="c1"># make predictions
</span>        <span class="n">pred_validaiton</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
        
        <span class="c1"># compute metrics
</span>        <span class="n">mse</span> <span class="o">=</span> <span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">Y_val</span><span class="p">,</span> <span class="n">pred_validaiton</span><span class="p">)</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">RMSE SCORE: {:.5f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
        
        <span class="c1"># save scores
</span>        <span class="n">scores</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
        
        <span class="c1"># checkpoint
</span>        <span class="n">best_score</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best score: {:.5f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_score</span><span class="p">))</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">argmin</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best model: {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_model</span><span class="p">))</span>
        
        <span class="k">del</span> <span class="n">best_score</span>
        <span class="k">del</span> <span class="n">best_model</span>
        <span class="k">del</span> <span class="n">pred_validaiton</span>
        <span class="k">del</span> <span class="n">model</span>
        <span class="n">gc</span><span class="p">.</span><span class="n">collect</span>
        
    <span class="c1"># scores and models
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">SUMMARY</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">argmin</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best score: {:.5f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_score</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best model: {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_model</span><span class="p">))</span>

    <span class="n">return_obj</span><span class="p">[</span><span class="sh">'</span><span class="s">scores</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
    <span class="n">return_obj</span><span class="p">[</span><span class="sh">'</span><span class="s">best_score</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_score</span>
    <span class="n">return_obj</span><span class="p">[</span><span class="sh">'</span><span class="s">best_model_params</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_model</span>
    
    <span class="k">return</span> <span class="n">return_obj</span>
</code></pre></div></div>

<h4 id="ridge-regression">Ridge Regression</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">265</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">275</span><span class="p">]</span>
<span class="n">grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">alpha</span><span class="sh">'</span><span class="p">:</span><span class="n">alphas</span><span class="p">}</span>
<span class="n">val_res</span> <span class="o">=</span> <span class="nf">tune_model</span><span class="p">(</span><span class="n">Ridge</span><span class="p">,</span> <span class="n">X_train_lin</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> 
                   <span class="n">X_valid_lin</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------------------------------------
MODEL 0
{'alpha': 265}
	training done: 10.59s
RMSE SCORE: 0.83796
Best score: 0.83796
Best model: {'alpha': 265}
--------------------------------------------------
MODEL 1
{'alpha': 270}
	training done: 3.67s
RMSE SCORE: 0.83796
Best score: 0.83796
Best model: {'alpha': 270}
--------------------------------------------------
MODEL 2
{'alpha': 275}
	training done: 2.75s
RMSE SCORE: 0.83796
Best score: 0.83796
Best model: {'alpha': 270}
--------------------------------------------------
SUMMARY
Best score: 0.83796
Best model: {'alpha': 270}
</code></pre></div></div>

<h4 id="lasso">Lasso</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alphas</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">4.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">alpha</span><span class="sh">'</span><span class="p">:</span><span class="n">alphas</span><span class="p">}</span>
<span class="n">val_res</span> <span class="o">=</span> <span class="nf">tune_model</span><span class="p">(</span><span class="n">Lasso</span><span class="p">,</span> <span class="n">X_train_lin</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> 
                   <span class="n">X_valid_lin</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------------------------------------
MODEL 0
{'alpha': 6.309573444801929e-05}
	training done: 158.73s
RMSE SCORE: 0.83807
Best score: 0.83807
Best model: {'alpha': 6.309573444801929e-05}
--------------------------------------------------
MODEL 1
{'alpha': 8.912509381337459e-05}
	training done: 129.75s
RMSE SCORE: 0.83810
Best score: 0.83807
Best model: {'alpha': 6.309573444801929e-05}
--------------------------------------------------
MODEL 2
{'alpha': 0.0001258925411794166}
	training done: 49.31s
RMSE SCORE: 0.83808
Best score: 0.83807
Best model: {'alpha': 6.309573444801929e-05}
--------------------------------------------------
MODEL 3
{'alpha': 0.00017782794100389227}
	training done: 52.77s
RMSE SCORE: 0.83824
Best score: 0.83807
Best model: {'alpha': 6.309573444801929e-05}
--------------------------------------------------
MODEL 4
{'alpha': 0.00025118864315095795}
	training done: 52.73s
RMSE SCORE: 0.83879
Best score: 0.83807
Best model: {'alpha': 6.309573444801929e-05}
--------------------------------------------------
SUMMARY
Best score: 0.83807
Best model: {'alpha': 6.309573444801929e-05}
</code></pre></div></div>

<h4 id="bayesian-ridge">Bayesian Ridge</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">br_alpha_1</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">br_alpha_2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">br_lambda_1</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">br_lambda_2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="n">grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">alpha_1</span><span class="sh">'</span><span class="p">:</span> <span class="n">br_alpha_1</span><span class="p">,</span> <span class="sh">'</span><span class="s">alpha_2</span><span class="sh">'</span><span class="p">:</span> <span class="n">br_alpha_2</span><span class="p">,</span>
               <span class="sh">'</span><span class="s">lambda_1</span><span class="sh">'</span><span class="p">:</span> <span class="n">br_lambda_1</span><span class="p">,</span> <span class="sh">'</span><span class="s">lambda_2</span><span class="sh">'</span><span class="p">:</span> <span class="n">br_lambda_2</span><span class="p">}</span>
<span class="n">val_res</span> <span class="o">=</span> <span class="nf">tune_model</span><span class="p">(</span><span class="n">BayesianRidge</span><span class="p">,</span> <span class="n">X_train_lin</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span>
                    <span class="n">X_valid_lin</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------------------------------------
MODEL 0
{'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 10.0}
	training done: 29.31s
RMSE SCORE: 0.83807
Best score: 0.83807
Best model: {'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 10.0}
--------------------------------------------------
MODEL 1
{'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 31.622776601683793}
	training done: 16.63s
RMSE SCORE: 0.83815
Best score: 0.83807
Best model: {'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 10.0}
--------------------------------------------------
MODEL 2
{'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 100.0}
	training done: 16.15s
RMSE SCORE: 0.83832
Best score: 0.83807
Best model: {'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 10.0}
--------------------------------------------------
MODEL 3
{'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 316.22776601683796}
	training done: 16.43s
RMSE SCORE: 0.83852
Best score: 0.83807
Best model: {'alpha_1': 10000.0, 'alpha_2': 1e-08, 'lambda_1': 10000.0, 'lambda_2': 10.0}
...
--------------------------------------------------
MODEL 624
{'alpha_1': 1000000.0, 'alpha_2': 1e-06, 'lambda_1': 1000000.0, 'lambda_2': 1000.0}
	training done: 15.20s
RMSE SCORE: 0.83822
Best score: 0.83796
Best model: {'alpha_1': 10000.0, 'alpha_2': 1e-07, 'lambda_1': 316227.7660168379, 'lambda_2': 1000.0}
--------------------------------------------------
SUMMARY
Best score: 0.83796
Best model: {'alpha_1': 10000.0, 'alpha_2': 1e-07, 'lambda_1': 316227.7660168379, 'lambda_2': 1000.0}
</code></pre></div></div>

<h4 id="random-forest">Random Forest</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grid_params</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">max_features</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sqrt</span><span class="sh">'</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">min_samples_split</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">n_estimators</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">n_jobs</span><span class="sh">'</span><span class="p">:[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>

<span class="n">val_res</span> <span class="o">=</span> <span class="nf">tune_model</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span>
                    <span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------------------------------------
MODEL 0
{'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 10, 'n_jobs': -1}
	training done: 546.59s
RMSE SCORE: 0.82886
Best score: 0.82886
Best model: {'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 10, 'n_jobs': -1}
--------------------------------------------------
MODEL 1
{'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 50, 'n_jobs': -1}
	training done: 2117.12s
RMSE SCORE: 0.82208
Best score: 0.82208
Best model: {'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 50, 'n_jobs': -1}
--------------------------------------------------
MODEL 2
{'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 100, 'n_jobs': -1}
	training done: 4011.42s
RMSE SCORE: 0.82328
Best score: 0.82208
Best model: {'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 50, 'n_jobs': -1}
...
--------------------------------------------------
MODEL 47
{'max_depth': None, 'max_features': 'sqrt', 'min_samples_split': 10, 'n_estimators': 100, 'n_jobs': -1}
	training done: 1189.53s
RMSE SCORE: 0.82544
Best score: 0.80872
Best model: {'max_depth': 20, 'max_features': 'sqrt', 'min_samples_split': 10, 'n_estimators': 100, 'n_jobs': -1}
--------------------------------------------------
SUMMARY
Best score: 0.80872
Best model: {'max_depth': 20, 'max_features': 'sqrt', 'min_samples_split': 10, 'n_estimators': 100, 'n_jobs': -1}
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grid_params</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">max_features</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">min_samples_split</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">n_estimators</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">n_jobs</span><span class="sh">'</span><span class="p">:[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
             <span class="sh">'</span><span class="s">verbose</span><span class="sh">'</span><span class="p">:[</span><span class="mi">1</span><span class="p">]}</span>

<span class="n">val_res</span> <span class="o">=</span> <span class="nf">tune_model</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span>
                    <span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------------------------------------
MODEL 0
{'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 500, 'n_jobs': -1, 'verbose': 1}


[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 4 concurrent workers.
[Parallel(n_jobs=-1)]: Done  42 tasks      | elapsed: 30.1min
[Parallel(n_jobs=-1)]: Done 192 tasks      | elapsed: 113.6min
[Parallel(n_jobs=-1)]: Done 442 tasks      | elapsed: 255.3min
[Parallel(n_jobs=-1)]: Done 500 out of 500 | elapsed: 287.2min finished


	training done: 17241.45s


[Parallel(n_jobs=4)]: Using backend ThreadingBackend with 4 concurrent workers.
[Parallel(n_jobs=4)]: Done  42 tasks      | elapsed:    0.9s
[Parallel(n_jobs=4)]: Done 192 tasks      | elapsed:    4.9s
[Parallel(n_jobs=4)]: Done 442 tasks      | elapsed:   10.2s


RMSE SCORE: 0.82104
Best score: 0.82104
Best model: {'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 500, 'n_jobs': -1, 'verbose': 1}
--------------------------------------------------
SUMMARY
Best score: 0.82104
Best model: {'max_depth': 10, 'max_features': 'auto', 'min_samples_split': 5, 'n_estimators': 500, 'n_jobs': -1, 'verbose': 1}


[Parallel(n_jobs=4)]: Done 500 out of 500 | elapsed:   11.4s finished
</code></pre></div></div>

<h4 id="lightgbm">LightGBM</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tune_model_lgb</span><span class="p">(</span><span class="n">lgb_train_</span><span class="p">,</span> <span class="n">lgb_valid_</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">):</span>
    <span class="c1"># extract parameters to be tuned and candidate values
</span>    <span class="n">params</span> <span class="o">=</span> <span class="n">grid_params</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">grid_params</span><span class="p">.</span><span class="nf">values</span><span class="p">()</span>
    
    <span class="c1"># create all combinations
</span>    <span class="n">combinations</span> <span class="o">=</span> <span class="nf">product</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
    
    <span class="c1"># store results
</span>    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">return_obj</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># iterate 
</span>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
        <span class="c1"># format header for readability
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL {0}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="c1"># recreate input params
</span>        <span class="n">current_param</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">combo</span><span class="p">))</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">current_param</span><span class="p">)</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">current_param</span><span class="p">)</span>
        
        <span class="c1"># train model
</span>        <span class="n">gbm</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span><span class="n">current_param</span><span class="p">,</span>
                <span class="n">lgb_train</span><span class="p">,</span>
                <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                <span class="n">valid_sets</span><span class="o">=</span><span class="n">lgb_valid</span><span class="p">,</span>
                <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s">training done: {:.2f}s</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">ts</span><span class="p">))</span>
        
        <span class="c1"># make predictions
</span>        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">gbm</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">num_iteration</span><span class="o">=</span><span class="n">gbm</span><span class="p">.</span><span class="n">best_iteration</span><span class="p">),</span><span class="mf">0.</span><span class="p">,</span><span class="mf">20.</span><span class="p">)</span>
        
        <span class="c1"># compute metrics
</span>        <span class="n">mse</span> <span class="o">=</span> <span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">Y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">RMSE SCORE: {:.5f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
        
        <span class="c1"># save scores
</span>        <span class="n">scores</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
        
        <span class="c1"># checkpoint
</span>        <span class="n">best_score</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best score: {:.5f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_score</span><span class="p">))</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">argmin</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best model: {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_model</span><span class="p">))</span>
        
        <span class="k">del</span> <span class="n">best_score</span>
        <span class="k">del</span> <span class="n">best_model</span>
        <span class="k">del</span> <span class="n">y_pred</span>
        <span class="k">del</span> <span class="n">gbm</span>
        <span class="n">gc</span><span class="p">.</span><span class="n">collect</span>
        
    <span class="c1"># scores and models
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">SUMMARY</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">argmin</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best score: {:.5f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_score</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Best model: {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">best_model</span><span class="p">))</span>

    <span class="n">return_obj</span><span class="p">[</span><span class="sh">'</span><span class="s">scores</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
    <span class="n">return_obj</span><span class="p">[</span><span class="sh">'</span><span class="s">best_score</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_score</span>
    <span class="n">return_obj</span><span class="p">[</span><span class="sh">'</span><span class="s">best_model_params</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_model</span>
    
    <span class="k">return</span> <span class="n">return_obj</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># isolate categorical features
</span><span class="n">indexes_of_categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_train</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">get_loc</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_features</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create lbg training and validation set
</span><span class="n">lgb_train</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="nc">Dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">categorical_feature</span><span class="o">=</span><span class="n">indexes_of_categories</span><span class="p">,</span> <span class="n">free_raw_data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">lgb_valid</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="nc">Dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Y_valid</span><span class="p">,</span> <span class="n">categorical_feature</span><span class="o">=</span><span class="n">indexes_of_categories</span><span class="p">,</span> <span class="n">free_raw_data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">params_gs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">num_leaves</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">17</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">51</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">min_data_in_leaf</span><span class="sh">'</span><span class="p">:[</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">learning_rate</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">feature_fraction</span><span class="sh">'</span><span class="p">:[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.9</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">bagging_fraction</span><span class="sh">'</span><span class="p">:[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">max_bin</span><span class="sh">'</span><span class="p">:[</span><span class="mi">255</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">boosting_type</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">gbdt</span><span class="sh">'</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">objective</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">regression</span><span class="sh">'</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">metric</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">l2</span><span class="sh">'</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">bagging_freq</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">verbose</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">light_gbm</span> <span class="o">=</span> <span class="nf">tune_model_lgb</span><span class="p">(</span><span class="n">lgb_train</span><span class="p">,</span> <span class="n">lgb_valid</span><span class="p">,</span> <span class="n">params_gs</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------------------------------------
MODEL 0
{'num_leaves': 17, 'min_data_in_leaf': 10, 'max_depth': -1, 'learning_rate': 0.05, 'feature_fraction': 0.5, 'bagging_fraction': 0.5, 'max_bin': 255, 'boosting_type': 'gbdt', 'objective': 'regression', 'metric': 'l2', 'bagging_freq': 5, 'verbose': -1}



[1]	valid_0's l2: 1.10527
Training until validation scores don't improve for 5 rounds
[2]	valid_0's l2: 1.07531
[3]	valid_0's l2: 1.05201
[4]	valid_0's l2: 1.02279
[5]	valid_0's l2: 0.998551
[6]	valid_0's l2: 0.974025
[7]	valid_0's l2: 0.952692
[8]	valid_0's l2: 0.932333
[9]	valid_0's l2: 0.91344
[10]	valid_0's l2: 0.895566
[11]	valid_0's l2: 0.876383
[12]	valid_0's l2: 0.862929
[13]	valid_0's l2: 0.850901
[14]	valid_0's l2: 0.838443
[15]	valid_0's l2: 0.823629
[16]	valid_0's l2: 0.815305
[17]	valid_0's l2: 0.803962
[18]	valid_0's l2: 0.798741
[19]	valid_0's l2: 0.791434
[20]	valid_0's l2: 0.783215
[21]	valid_0's l2: 0.776634
[22]	valid_0's l2: 0.768956
[23]	valid_0's l2: 0.764029
[24]	valid_0's l2: 0.757802
[25]	valid_0's l2: 0.754147
[26]	valid_0's l2: 0.749015
[27]	valid_0's l2: 0.743662
[28]	valid_0's l2: 0.738082
[29]	valid_0's l2: 0.735406
[30]	valid_0's l2: 0.731135
[31]	valid_0's l2: 0.72884
[32]	valid_0's l2: 0.727529
[33]	valid_0's l2: 0.724651
[34]	valid_0's l2: 0.72392
[35]	valid_0's l2: 0.720609
[36]	valid_0's l2: 0.720633
[37]	valid_0's l2: 0.719136
[38]	valid_0's l2: 0.716923
[39]	valid_0's l2: 0.714208
[40]	valid_0's l2: 0.712108
[41]	valid_0's l2: 0.710699
[42]	valid_0's l2: 0.710426
[43]	valid_0's l2: 0.709536
[44]	valid_0's l2: 0.710491
[45]	valid_0's l2: 0.707844
[46]	valid_0's l2: 0.706848
[47]	valid_0's l2: 0.705889
[48]	valid_0's l2: 0.703528
[49]	valid_0's l2: 0.701249
[50]	valid_0's l2: 0.701599
[51]	valid_0's l2: 0.700817
[52]	valid_0's l2: 0.700734
[53]	valid_0's l2: 0.699862
[54]	valid_0's l2: 0.699969
[55]	valid_0's l2: 0.699991
[56]	valid_0's l2: 0.699688
[57]	valid_0's l2: 0.699316
[58]	valid_0's l2: 0.697707
[59]	valid_0's l2: 0.697867
[60]	valid_0's l2: 0.697003
[61]	valid_0's l2: 0.695797
[62]	valid_0's l2: 0.694803
[63]	valid_0's l2: 0.694291
[64]	valid_0's l2: 0.693099
[65]	valid_0's l2: 0.692775
[66]	valid_0's l2: 0.693045
[67]	valid_0's l2: 0.691834
[68]	valid_0's l2: 0.692186
[69]	valid_0's l2: 0.692687
[70]	valid_0's l2: 0.692229
[71]	valid_0's l2: 0.692593
[72]	valid_0's l2: 0.692336
Early stopping, best iteration is:
[67]	valid_0's l2: 0.691834
	training done: 40.75s
RMSE SCORE: 0.83516
Best score: 0.83516
Best model: {'num_leaves': 17, 'min_data_in_leaf': 10, 'max_depth': -1, 'learning_rate': 0.05, 'feature_fraction': 0.5, 'bagging_fraction': 0.5, 'max_bin': 255, 'boosting_type': 'gbdt', 'objective': 'regression', 'metric': 'l2', 'bagging_freq': 5, 'verbose': -1}
--------------------------------------------------
MODEL 1
{'num_leaves': 17, 'min_data_in_leaf': 10, 'max_depth': -1, 'learning_rate': 0.05, 'feature_fraction': 0.5, 'bagging_fraction': 0.5, 'max_bin': 255, 'boosting_type': 'gbdt', 'objective': 'regression', 'metric': 'l2', 'bagging_freq': 6, 'verbose': -1}



[1]	valid_0's l2: 1.10527
Training until validation scores don't improve for 5 rounds
[2]	valid_0's l2: 1.07531
[3]	valid_0's l2: 1.05201
[4]	valid_0's l2: 1.02279
[5]	valid_0's l2: 0.998551
[6]	valid_0's l2: 0.97405
[7]	valid_0's l2: 0.95349
[8]	valid_0's l2: 0.932658
[9]	valid_0's l2: 0.914223
[10]	valid_0's l2: 0.897632
[11]	valid_0's l2: 0.877349
[12]	valid_0's l2: 0.863744
[13]	valid_0's l2: 0.851036
[14]	valid_0's l2: 0.838301
[15]	valid_0's l2: 0.823764
[16]	valid_0's l2: 0.816064
[17]	valid_0's l2: 0.805195
[18]	valid_0's l2: 0.79905
[19]	valid_0's l2: 0.791872
[20]	valid_0's l2: 0.783252
[21]	valid_0's l2: 0.777125
[22]	valid_0's l2: 0.76982
[23]	valid_0's l2: 0.765262
[24]	valid_0's l2: 0.759256
[25]	valid_0's l2: 0.75549
[26]	valid_0's l2: 0.750393
[27]	valid_0's l2: 0.744901
[28]	valid_0's l2: 0.739169
[29]	valid_0's l2: 0.736655
[30]	valid_0's l2: 0.732419
[31]	valid_0's l2: 0.730543
[32]	valid_0's l2: 0.72918
[33]	valid_0's l2: 0.725655
[34]	valid_0's l2: 0.725163
[35]	valid_0's l2: 0.721856
[36]	valid_0's l2: 0.721893
[37]	valid_0's l2: 0.720522
[38]	valid_0's l2: 0.717873
[39]	valid_0's l2: 0.714776
[40]	valid_0's l2: 0.712635
[41]	valid_0's l2: 0.710812
[42]	valid_0's l2: 0.710365
[43]	valid_0's l2: 0.70942
[44]	valid_0's l2: 0.709538
[45]	valid_0's l2: 0.707223
[46]	valid_0's l2: 0.705169
[47]	valid_0's l2: 0.703678
[48]	valid_0's l2: 0.701343
[49]	valid_0's l2: 0.700215
[50]	valid_0's l2: 0.700314
[51]	valid_0's l2: 0.699423
[52]	valid_0's l2: 0.699303
[53]	valid_0's l2: 0.697868
[54]	valid_0's l2: 0.697933
[55]	valid_0's l2: 0.697991
[56]	valid_0's l2: 0.698016
[57]	valid_0's l2: 0.697487
[58]	valid_0's l2: 0.696206
[59]	valid_0's l2: 0.69619
[60]	valid_0's l2: 0.695404
[61]	valid_0's l2: 0.694171
[62]	valid_0's l2: 0.693438
[63]	valid_0's l2: 0.693584
[64]	valid_0's l2: 0.692399
[65]	valid_0's l2: 0.691994
[66]	valid_0's l2: 0.692421
[67]	valid_0's l2: 0.691399
[68]	valid_0's l2: 0.691757
[69]	valid_0's l2: 0.692146
[70]	valid_0's l2: 0.691961
[71]	valid_0's l2: 0.69215
[72]	valid_0's l2: 0.692097
Early stopping, best iteration is:
[67]	valid_0's l2: 0.691399
	training done: 21.72s
RMSE SCORE: 0.83113
Best score: 0.83113
Best model: {'num_leaves': 17, 'min_data_in_leaf': 10, 'max_depth': -1, 'learning_rate': 0.05, 'feature_fraction': 0.5, 'bagging_fraction': 0.5, 'max_bin': 255, 'boosting_type': 'gbdt', 'objective': 'regression', 'metric': 'l2', 'bagging_freq': 6, 'verbose': -1}
 
--------------------------------------------------
MODEL 1619
{'num_leaves': 51, 'min_data_in_leaf': 30, 'max_depth': 10, 'learning_rate': 0.1, 'feature_fraction': 0.9, 'bagging_fraction': 0.8, 'max_bin': 255, 'boosting_type': 'gbdt', 'objective': 'regression', 'metric': 'l2', 'bagging_freq': 7, 'verbose': -1}


[1]	valid_0's l2: 1.07129
Training until validation scores don't improve for 5 rounds
[2]	valid_0's l2: 1.00838
[3]	valid_0's l2: 0.962023
[4]	valid_0's l2: 0.919852
[5]	valid_0's l2: 0.887095
[6]	valid_0's l2: 0.851199
[7]	valid_0's l2: 0.831776
[8]	valid_0's l2: 0.814751
[9]	valid_0's l2: 0.800856
[10]	valid_0's l2: 0.789847
[11]	valid_0's l2: 0.780962
[12]	valid_0's l2: 0.774846
[13]	valid_0's l2: 0.769069
[14]	valid_0's l2: 0.764315
[15]	valid_0's l2: 0.753459
[16]	valid_0's l2: 0.749205
[17]	valid_0's l2: 0.747357
[18]	valid_0's l2: 0.744728
[19]	valid_0's l2: 0.744139
[20]	valid_0's l2: 0.744054
[21]	valid_0's l2: 0.742659
[22]	valid_0's l2: 0.743116
[23]	valid_0's l2: 0.743458
[24]	valid_0's l2: 0.73827
[25]	valid_0's l2: 0.738553
[26]	valid_0's l2: 0.733934
[27]	valid_0's l2: 0.734115
[28]	valid_0's l2: 0.734221
[29]	valid_0's l2: 0.734035
[30]	valid_0's l2: 0.733784
[31]	valid_0's l2: 0.734618
[32]	valid_0's l2: 0.7356
[33]	valid_0's l2: 0.733096
[34]	valid_0's l2: 0.732815
[35]	valid_0's l2: 0.733961
[36]	valid_0's l2: 0.735807
[37]	valid_0's l2: 0.735931
[38]	valid_0's l2: 0.735966
[39]	valid_0's l2: 0.736026
Early stopping, best iteration is:
[34]	valid_0's l2: 0.732815
	training done: 25.08s
RMSE SCORE: 0.86025
Best score: 0.82441
Best model: {'num_leaves': 51, 'min_data_in_leaf': 30, 'max_depth': 10, 'learning_rate': 0.05, 'feature_fraction': 0.5, 'bagging_fraction': 0.5, 'max_bin': 255, 'boosting_type': 'gbdt', 'objective': 'regression', 'metric': 'l2', 'bagging_freq': 5, 'verbose': -1}
--------------------------------------------------
SUMMARY
Best score: 0.82441
Best model: {'num_leaves': 51, 'min_data_in_leaf': 30, 'max_depth': 10, 'learning_rate': 0.05, 'feature_fraction': 0.5, 'bagging_fraction': 0.5, 'max_bin': 255, 'boosting_type': 'gbdt', 'objective': 'regression', 'metric': 'l2', 'bagging_freq': 5, 'verbose': -1}
</code></pre></div></div>

<h4 id="xgboost">XGBoost</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">learning_rate</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.16</span><span class="p">,</span> <span class="sh">'</span><span class="s">n_estimators</span><span class="sh">'</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> 
               <span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="sh">'</span><span class="s">min_child_weight</span><span class="sh">'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
               <span class="sh">'</span><span class="s">subsample</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sh">'</span><span class="s">colsample_bytree</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="sh">'</span><span class="s">nthread</span><span class="sh">'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
               <span class="sh">'</span><span class="s">scale_pos_weight</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">random_state</span><span class="sh">'</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="sh">'</span><span class="s">verbose</span><span class="sh">'</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">XGBRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">best_params</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="sh">"</span><span class="s">rmse</span><span class="sh">"</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">)],</span> 
          <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">early_stopping_rounds</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0]	validation_0-rmse:1.03205
Will train until validation_0-rmse hasn't improved in 50 rounds.
[1]	validation_0-rmse:0.980421
[2]	validation_0-rmse:0.94645
[3]	validation_0-rmse:0.913994
[4]	validation_0-rmse:0.891504
[5]	validation_0-rmse:0.874951
[6]	validation_0-rmse:0.862584
[7]	validation_0-rmse:0.853669
[8]	validation_0-rmse:0.847595
[9]	validation_0-rmse:0.839851
[10]	validation_0-rmse:0.837036
[11]	validation_0-rmse:0.834322
[12]	validation_0-rmse:0.83262
[13]	validation_0-rmse:0.83206
[14]	validation_0-rmse:0.830011
[15]	validation_0-rmse:0.828429
[16]	validation_0-rmse:0.827463
[17]	validation_0-rmse:0.826978
[18]	validation_0-rmse:0.825869
[19]	validation_0-rmse:0.824109
[20]	validation_0-rmse:0.823856
[21]	validation_0-rmse:0.823428
[22]	validation_0-rmse:0.822876
[23]	validation_0-rmse:0.821865
[24]	validation_0-rmse:0.821441
[25]	validation_0-rmse:0.821135
[26]	validation_0-rmse:0.820952
[27]	validation_0-rmse:0.820293
[28]	validation_0-rmse:0.819232
[29]	validation_0-rmse:0.821048
[30]	validation_0-rmse:0.821688
[31]	validation_0-rmse:0.82166
[32]	validation_0-rmse:0.82134
[33]	validation_0-rmse:0.821112
[34]	validation_0-rmse:0.82101
[35]	validation_0-rmse:0.82121
[36]	validation_0-rmse:0.821139
[37]	validation_0-rmse:0.821079
[38]	validation_0-rmse:0.82094
[39]	validation_0-rmse:0.821209
[40]	validation_0-rmse:0.820822
[41]	validation_0-rmse:0.821023
[42]	validation_0-rmse:0.820533
[43]	validation_0-rmse:0.820379
[44]	validation_0-rmse:0.819605
[45]	validation_0-rmse:0.819557
[46]	validation_0-rmse:0.819411
[47]	validation_0-rmse:0.819752
[48]	validation_0-rmse:0.820246
[49]	validation_0-rmse:0.820295
[50]	validation_0-rmse:0.820421
[51]	validation_0-rmse:0.820169
[52]	validation_0-rmse:0.819825
[53]	validation_0-rmse:0.819881
[54]	validation_0-rmse:0.819917
[55]	validation_0-rmse:0.819968
[56] . . .
[124]	validation_0-rmse:0.820778
[125]	validation_0-rmse:0.82067
[126]	validation_0-rmse:0.82077
[127]	validation_0-rmse:0.820908
[128]	validation_0-rmse:0.821074
[129]	validation_0-rmse:0.821126
[130]	validation_0-rmse:0.821155
[131]	validation_0-rmse:0.821098
[132]	validation_0-rmse:0.821102
[133]	validation_0-rmse:0.821045
[134]	validation_0-rmse:0.821084
[135]	validation_0-rmse:0.821045
[136]	validation_0-rmse:0.820932
[137]	validation_0-rmse:0.820839
[138]	validation_0-rmse:0.820851
[139]	validation_0-rmse:0.821082
[140]	validation_0-rmse:0.820964
[141]	validation_0-rmse:0.820966
[142]	validation_0-rmse:0.820985
[143]	validation_0-rmse:0.821103
[144]	validation_0-rmse:0.821175
[145]	validation_0-rmse:0.820316
[146]	validation_0-rmse:0.820125
[147]	validation_0-rmse:0.82009
[148]	validation_0-rmse:0.819621
Stopping. Best iteration:
[98]	validation_0-rmse:0.818906


XGBRegressor(base_score=0.5, booster='gbtree', colsample_bylevel=1,
             colsample_bynode=1, colsample_bytree=0.7, gamma=0,
             importance_type='gain', learning_rate=0.16, max_delta_step=0,
             max_depth=6, min_child_weight=7, missing=None, n_estimators=500,
             n_jobs=1, nthread=-1, objective='reg:linear', random_state=42,
             reg_alpha=0, reg_lambda=1, scale_pos_weight=1, seed=None,
             silent=None, subsample=0.9, verbose=2, verbosity=1)
</code></pre></div></div>

<p><a id="Section_92"></a></p>
<h4 id="final-models">Final Models</h4>

<p>Based on the above tuned models, we finally trained the models on months 12 to 27, then we make predictions for months 28 to 34. We then stack the models and trained the stacked model using months 28 to 33. Finally, we make predictions on month 34. Here are the summaries of our tuning process:</p>

<p><strong>Step 1</strong>: Model training</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># combine the X_train and X_train_valid dataframes
</span><span class="n">all_data</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">all_target</span> <span class="o">=</span> <span class="n">Y_train</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">Y_valid</span><span class="p">)</span>

<span class="n">all_data_lin</span> <span class="o">=</span> <span class="n">X_train_lin</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">X_valid_lin</span><span class="p">)</span>
<span class="n">all_dates</span> <span class="o">=</span> <span class="n">X_train_dates</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">X_valid_dates</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># we create 2nd level feeature matrix, init it with zeros first
</span><span class="n">X_train_valid_level2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">([</span><span class="n">X_valid_dates</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">X_test_level2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">([</span><span class="n">X_valid_meta_dates</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">X_submit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">([</span><span class="n">X_test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">])</span>

<span class="c1"># Now fill `X_train_valid_level2` with metafeatures
</span><span class="k">for</span> <span class="n">cur_block_num</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">]:</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Testing on month: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">cur_block_num</span><span class="p">))</span>
    
    <span class="sh">'''</span><span class="s">
        1. Split `X_train` into parts
           Remember, that corresponding dates are stored in `dates_train` 
        2. Fit Ridge Regression
        3. Fit Lasso Regression
        4. Fit Bayesian Ridge
        5. Fit Random Forest
        6. Fit LightGBM
        7. Fit XGB
        8. Store predictions from 2. to 7. in the right place of `X_train_valid_level2`. 
           You can use `dates_train_level2` for it
           Make sure the order of the meta-features is the same as in `X_test_level2`
    </span><span class="sh">'''</span>      
    
    <span class="c1"># 1. Split `X_train` into parts
</span>    <span class="c1"># first chunk from month 1 to month cur_block_num-1 (for training)
</span>    <span class="c1"># secondd chunk for month cur_block_num (test) 
</span>    <span class="n">X_train_temp</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_dates</span> <span class="o">&lt;</span>  <span class="n">cur_block_num</span><span class="p">]</span>
    <span class="n">X_train_lin_temp</span> <span class="o">=</span> <span class="n">all_data_lin</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_dates</span> <span class="o">&lt;</span>  <span class="n">cur_block_num</span><span class="p">]</span>
    
    <span class="n">X_test_temp</span> <span class="o">=</span>  <span class="n">all_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_dates</span> <span class="o">==</span> <span class="n">cur_block_num</span><span class="p">]</span>
    <span class="n">X_test_lin_temp</span> <span class="o">=</span> <span class="n">all_data_lin</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_dates</span> <span class="o">==</span>  <span class="n">cur_block_num</span><span class="p">]</span> 
    
    <span class="n">y_train_temp</span> <span class="o">=</span> <span class="n">all_target</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_dates</span> <span class="o">&lt;</span>  <span class="n">cur_block_num</span><span class="p">].</span><span class="n">values</span>
    <span class="n">y_test_temp</span> <span class="o">=</span> <span class="n">all_target</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_dates</span> <span class="o">==</span> <span class="n">cur_block_num</span><span class="p">].</span><span class="n">values</span>
    
    <span class="c1"># 2. Fit Ridge Regression
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train_lin_temp</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_train_temp</span><span class="p">)</span>
    
    <span class="c1"># predict level2
</span>    <span class="n">pred_ridge</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_lin_temp</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># predict month 33
</span>    <span class="n">pred_ridge_33</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_valid_meta_lin</span><span class="p">)</span>
    <span class="c1"># predict month 34
</span>    <span class="n">pred_ridge_34</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_lin</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s"> done with Ridge</span><span class="sh">'</span><span class="p">)</span>
     
    <span class="c1"># 3. Fit Lasso Regression
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">Lasso</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">6.309573444801929e-05</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train_lin_temp</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_train_temp</span><span class="p">)</span>
    <span class="c1"># predict level 2
</span>    <span class="n">pred_lasso</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_lin_temp</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># predict month 33
</span>    <span class="n">pred_lasso_33</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_valid_meta_lin</span><span class="p">)</span>
    <span class="c1"># predict month 34
</span>    <span class="n">pred_lasso_34</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_lin</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s"> done with Lasso</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="c1"># 4. Fit Bayesian Ridge
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">BayesianRidge</span><span class="p">(</span>
        <span class="n">alpha_1</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">,</span> <span class="n">alpha_2</span><span class="o">=</span><span class="mf">1e-07</span><span class="p">,</span>
        <span class="n">lambda_1</span><span class="o">=</span><span class="mf">316227.7660168379</span><span class="p">,</span><span class="n">lambda_2</span><span class="o">=</span><span class="mf">1000.0</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train_lin_temp</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_train_temp</span><span class="p">)</span>
    <span class="c1"># predict level 2
</span>    <span class="n">pred_bayesian</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_lin_temp</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># predict month 33
</span>    <span class="n">pred_bayesian_33</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_valid_meta_lin</span><span class="p">)</span>
    <span class="c1"># predict month 34
</span>    <span class="n">pred_bayesian_34</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_lin</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s"> done with Bayesian</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="c1"># 5. Fit Random Forest
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">RandomForestRegressor</span><span class="p">(</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="sh">'</span><span class="s">sqrt</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train_temp</span><span class="p">,</span> <span class="n">y_train_temp</span><span class="p">)</span>
    <span class="c1"># predict level 2
</span>    <span class="n">pred_rdm</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_temp</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># predict month 33
</span>    <span class="n">pred_rdm_33</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_valid_meta</span><span class="p">)</span>
    <span class="c1"># predict month 34
</span>    <span class="n">pred_rdm_34</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s"> done with Random Forest</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="c1"># 6. Fit LightGBM
</span>    <span class="c1"># create lbg training and validation set
</span>    <span class="n">lgb_train</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="nc">Dataset</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">X_train_temp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_train_temp</span><span class="p">,</span>
        <span class="n">categorical_feature</span><span class="o">=</span><span class="n">indexes_of_categories</span><span class="p">,</span>
        <span class="n">free_raw_data</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">num_leaves</span><span class="sh">'</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span> <span class="sh">'</span><span class="s">min_data_in_leaf</span><span class="sh">'</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">'</span><span class="s">learning_rate</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">feature_fraction</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sh">'</span><span class="s">bagging_fraction</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">max_bin</span><span class="sh">'</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="sh">'</span><span class="s">boosting_type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">gbdt</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">objective</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">regression</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">metric</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">l2</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">bagging_freq</span><span class="sh">'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="sh">'</span><span class="s">verbose</span><span class="sh">'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
                <span class="n">lgb_train</span><span class="p">,</span>
                <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="c1"># predict level 2
</span>    <span class="n">pred_lgb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_temp</span><span class="p">)</span>
    <span class="c1"># predict month 33
</span>    <span class="n">pred_lgb_33</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_valid_meta</span><span class="p">)</span>
    <span class="c1"># predict month 34
</span>    <span class="n">pred_lgb_34</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s"> done with LGBM</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="c1"># 7. Fit XGBoost
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">XGBRegressor</span><span class="p">(</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.16</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">min_child_weight</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">subsample</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">nthread</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale_pos_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
    <span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train_temp</span><span class="p">,</span> <span class="n">y_train_temp</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="sh">"</span><span class="s">rmse</span><span class="sh">"</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_test_temp</span><span class="p">,</span> <span class="n">y_test_temp</span><span class="p">)],</span> 
          <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">early_stopping_rounds</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
    <span class="c1"># predict level 2
</span>    <span class="n">pred_xgb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_temp</span><span class="p">)</span>
    <span class="c1"># predict month 33
</span>    <span class="n">pred_xgb_33</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_valid_meta</span><span class="p">)</span>
    <span class="c1"># predict month 34
</span>    <span class="n">pred_xgb_34</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\t</span><span class="s"> done with XGB</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># 8. Store predictions from 2. to 7. in the right place of `X_train_valid_level2`. 
</span>    <span class="c1"># You can use `dates_train_level2` for it    
</span>    <span class="n">indexes</span> <span class="o">=</span> <span class="n">X_valid_dates</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">X_valid_dates</span> <span class="o">==</span> <span class="n">cur_block_num</span><span class="p">]</span>
    <span class="n">indexes_shift</span> <span class="o">=</span> <span class="n">X_valid_dates</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">min</span><span class="p">()</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">indexes</span> <span class="o">-</span> <span class="n">indexes_shift</span>
    
    <span class="n">X_train_valid_level2</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_ridge</span>
    <span class="n">X_train_valid_level2</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_lasso</span>
    <span class="n">X_train_valid_level2</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_bayesian</span>
    <span class="n">X_train_valid_level2</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_rdm</span>
    <span class="n">X_train_valid_level2</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_lgb</span>
    <span class="n">X_train_valid_level2</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_xgb</span>
    
    <span class="n">X_test_level2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_ridge_33</span>
    <span class="n">X_test_level2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_lasso_33</span>
    <span class="n">X_test_level2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_bayesian_33</span>
    <span class="n">X_test_level2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_rdm_33</span>
    <span class="n">X_test_level2</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_lgb_33</span>
    <span class="n">X_test_level2</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_xgb_33</span>
    
    <span class="n">X_submit</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_ridge_34</span>
    <span class="n">X_submit</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_lasso_34</span>
    <span class="n">X_submit</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_bayesian_34</span>
    <span class="n">X_submit</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_rdm_34</span>
    <span class="n">X_submit</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_lgb_34</span>
    <span class="n">X_submit</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_xgb_34</span>
    
    <span class="k">del</span> <span class="n">model</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Testing on month: 28
	 done with Ridge
	 done with Lasso
	 done with Bayesian
	 done with Random Forest
	 done with LGBM
	 done with XGB
Testing on month: 29
	 done with Ridge
	 done with Lasso
	 done with Bayesian
	 done with Random Forest
	 done with LGBM
	 done with XGB
Testing on month: 30
	 done with Ridge
	 done with Lasso
	 done with Bayesian
	 done with Random Forest
	 done with LGBM
	 done with XGB
Testing on month: 31
	 done with Ridge
	 done with Lasso
	 done with Bayesian
	 done with Random Forest
	 done with LGBM
Testing on month: 32
	 done with Ridge
	 done with Lasso
	 done with Bayesian
	 done with Random Forest
	 done with LGBM
	 done with XGB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># save predictions
</span><span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_train_valid_level2</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_train_valid_level2.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_test_level2</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_test_level2.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
<span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">X_submit</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">X_submit.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">RMSE Scores on months 28 through 32</span><span class="sh">'</span><span class="p">)</span>
<span class="n">X_train_valid_level2_clip</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">X_train_valid_level2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Ridge Regression: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_train_valid_level2_clip</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_valid</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Lasso Regression: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_train_valid_level2_clip</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y_valid</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Bayesian Regression: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_train_valid_level2_clip</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">Y_valid</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Random Forest: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_train_valid_level2_clip</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">Y_valid</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">LGBM: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_train_valid_level2_clip</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">Y_valid</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">XGBM: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_train_valid_level2_clip</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">Y_valid</span><span class="p">))))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ridge Regression: 0.837
Lasso Regression: 0.837
Bayesian Regression: 0.837
Random Forest: 0.801
LGBM: 0.817
XGBM: 0.807
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">RMSE Scores on month 33</span><span class="sh">'</span><span class="p">)</span>
<span class="n">X_test_level2_clip</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">X_test_level2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Ridge Regression: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_test_level2_clip</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_valid_meta</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Lasso Regression: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_test_level2_clip</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y_valid_meta</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Bayesian Regression: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_test_level2_clip</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">Y_valid_meta</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Random Forest: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_test_level2_clip</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">Y_valid_meta</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">LGBM: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_test_level2_clip</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">Y_valid_meta</span><span class="p">))))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">XGBM: {:.3f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">X_test_level2_clip</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">Y_valid_meta</span><span class="p">))))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RMSE Scores on month 33
Ridge Regression: 0.962
Lasso Regression: 0.963
Bayesian Regression: 0.962
Random Forest: 0.921
LGBM: 0.953
XGBM: 0.946
</code></pre></div></div>

<p><a id="Section_92"></a></p>
<h3 id="meta-model">Meta Model</h3>

<p>Two meta models are considered:</p>
<ol>
  <li>In the first scenario, our model is only trained on the predictions of our first-layer models.</li>
  <li>We are also testing a case where our meta model is trained using our full features and the predictions of the first-layer models.</li>
</ol>

<p><a id="Section_92"></a></p>
<h4 id="meta-model-without-existing-features">Meta Model without Existing Features</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>

<span class="n">best_rmse</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">best_combo</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">combo_len</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">comb</span> <span class="o">=</span> <span class="nf">combinations</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">combo_len</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">comb</span><span class="p">):</span> 
        
        <span class="c1"># create meta model
</span>        <span class="n">meta</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">()</span>
        
        <span class="c1"># fit meta model using predictions for months 28 through 32
</span>        <span class="n">meta</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_test_level2</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">Y_valid_meta</span><span class="p">)</span>

        <span class="c1"># make predictions using the validation month 33
</span>        <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test_level2</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># compute rmse on validation test
</span>        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">Y_valid_meta</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="n">rmse</span><span class="o">&lt;</span><span class="n">best_rmse</span><span class="p">:</span>
            <span class="n">best_combo</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">best_rmse</span> <span class="o">=</span> <span class="n">rmse</span>
            
<span class="nf">print</span><span class="p">(</span><span class="n">best_combo</span><span class="p">,</span> <span class="n">best_rmse</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(0, 1, 2, 3, 4, 5) 0.9134753537081098
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create meta model
</span><span class="n">meta</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">()</span>
<span class="n">meta</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train_valid_level2</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">)</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_submit</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_test_pred</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(214200,)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">meta.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<p><a id="Section_92"></a></p>
<h4 id="meta-model-with-existing-features">Meta Model with Existing Features</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X_train_level2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">X_train_valid_level2</span><span class="p">,</span> <span class="n">X_valid_lin</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">X_train_level2</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(1118820, 71)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X_test_level2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">X_test_level2</span><span class="p">,</span> <span class="n">X_valid_meta_lin</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">X_test_level2</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(238172, 71)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X_submit_level2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">X_submit</span><span class="p">,</span> <span class="n">X_test_lin</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">X_submit_level2</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(214200, 71)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create meta model
</span><span class="n">meta_with</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">()</span>
<span class="n">meta_with</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train_level</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">)</span>
<span class="n">y_test_pred_with</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">meta_with</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_submit_level2</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pickle</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">meta_with_feat.pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<p><a id="Section_93"></a></p>
<h3 id="submission-and-conclusion">Submission and Conclusion</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">data_before_split</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
    <span class="n">full_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test set (predictions)
</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">full_data</span><span class="p">[</span><span class="n">full_data</span><span class="p">[</span><span class="sh">'</span><span class="s">date_block_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">34</span><span class="p">].</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">item_cnt_day</span><span class="sh">'</span><span class="p">],</span>
                                                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># add prediction to feature before merging
</span><span class="n">X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_pred</span>

<span class="n">test_submission</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">X_test</span><span class="p">[[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]],</span> <span class="n">sales_test</span><span class="p">,</span>
                           <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">right</span><span class="sh">'</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span>
                           <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]).</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_submission</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_submission</span> <span class="o">=</span> <span class="n">test_submission</span><span class="p">[[</span><span class="sh">'</span><span class="s">ID</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]]</span>

<span class="c1"># set predictions
</span><span class="n">test_submission</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">stacking_without.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># add prediction to feature before merging
</span><span class="n">X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_pred_with</span>

<span class="n">test_submission</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">X_test</span><span class="p">[[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]],</span> <span class="n">sales_test</span><span class="p">,</span>
                           <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">right</span><span class="sh">'</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span>
                           <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">]).</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_submission</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">shop_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">item_id</span><span class="sh">'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_submission</span> <span class="o">=</span> <span class="n">test_submission</span><span class="p">[[</span><span class="sh">'</span><span class="s">ID</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">item_cnt_month</span><span class="sh">'</span><span class="p">]]</span>

<span class="c1"># set predictions
</span><span class="n">test_submission</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">stacking_with.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>Our final solution obtains 0.938030 and 0.945603 on the public and private leaderboard respectively.</p>
