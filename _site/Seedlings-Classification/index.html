<footer id="attribution" style="float:right; color:#999; background:#fff;">
Created by Thibault Dody, 02/13/2020.
</footer>

<h1 id="plant-seedlings-dataset">Plant Seedlings Dataset</h1>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/banner.jpg" style="width:642px;height:288px;" />
</figure>

<h1 id="table-of-content">Table of Content</h1>

<h2 id="introduction">Introduction</h2>

<p><strong>Can you differentiate a weed from a crop seedling?</strong></p>

<p>The ability to do so effectively can mean better crop yields and better stewardship of the environment.</p>

<p>The Aarhus University Signal Processing group, in collaboration with University of Southern Denmark, has recently released a dataset containing images of approximately 960 unique plants belonging to 12 species at several growth stages.</p>

<p>It comprises annotated RGB images with a physical resolution of roughly 10 pixels per mm.</p>

<p>The dataset (version 2) can be found <a href="https://vision.eng.au.dk/plant-seedlings-dataset/">here</a>.</p>

<p>The dataset contains images of the following classes subdivided into two main groups:</p>

<ul>
  <li>
    <p>Agriculture plants</p>

    <ul>
      <li>Maize</li>
      <li>Common wheat</li>
      <li>Sugar beet</li>
    </ul>
  </li>
  <li>
    <p>Wild weeds</p>

    <ul>
      <li>Scentless Mayweed</li>
      <li>Common Chickweed</li>
      <li>Shepherd’s Purse</li>
      <li>Cleavers</li>
      <li>Charlock</li>
      <li>Fat Hen</li>
      <li>Small-flowered Cranesbill</li>
      <li>Black-grass</li>
      <li>Loose Silky-bent</li>
    </ul>
  </li>
</ul>

<p><strong>Objective</strong><br />
The goal of this study is to develop a model to classify the species given a new image. The insights gained from this analysis can then be re-used by growers to eliminate weeds and better monitor species meant to be cultivated.</p>

<h2 id="load-libraries-and-import-data">Load Libraries and Import Data</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="n">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">from</span> <span class="n">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">import</span> <span class="n">matplotlib</span>
<span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">from</span> <span class="n">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">set_style</span><span class="p">(</span><span class="sh">"</span><span class="s">darkgrid</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="n">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="n">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="n">skimage.segmentation</span> <span class="kn">import</span> <span class="n">mark_boundaries</span>

<span class="kn">from</span> <span class="n">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="n">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="n">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">Dropout</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">Flatten</span>
<span class="kn">from</span> <span class="n">keras.layers.convolutional</span> <span class="kn">import</span> <span class="n">Conv2D</span>
<span class="kn">from</span> <span class="n">keras.layers.convolutional</span> <span class="kn">import</span> <span class="n">MaxPooling2D</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="n">keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span><span class="n">ReduceLROnPlateau</span><span class="p">,</span><span class="n">CSVLogger</span>
<span class="kn">from</span> <span class="n">keras</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="n">keras</span> <span class="kn">import</span> <span class="n">losses</span>
<span class="kn">from</span> <span class="n">keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span><span class="p">,</span> <span class="n">np_utils</span>
<span class="kn">from</span> <span class="n">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="n">keras</span> <span class="kn">import</span> <span class="n">optimizers</span>
<span class="kn">from</span> <span class="n">keras_tqdm</span> <span class="kn">import</span> <span class="n">TQDMNotebookCallback</span>

<span class="kn">from</span> <span class="n">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="n">imageio</span>
<span class="kn">from</span> <span class="n">skimage</span> <span class="kn">import</span> <span class="n">color</span>
<span class="kn">from</span> <span class="n">skimage.morphology</span> <span class="kn">import</span> <span class="n">closing</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">opening</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tnrange</span><span class="p">,</span> <span class="n">tqdm_notebook</span>
<span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">from</span> <span class="n">os</span> <span class="kn">import</span> <span class="n">listdir</span>
<span class="kn">from</span> <span class="n">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>

<span class="kn">import</span> <span class="n">lime</span>
<span class="kn">from</span> <span class="n">lime</span> <span class="kn">import</span> <span class="n">lime_image</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">TAD_tools_v01</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Using TensorFlow backend.
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ZIPFILE = './NonsegmentedV2.zip'
</span><span class="n">ZIPEXTRACT</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../Data/</span><span class="sh">'</span>
</code></pre></div></div>

<h2 id="data-inspection">Data Inspection</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">species</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span><span class="p">):</span>
    <span class="n">species</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="n">counts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">folder</span><span class="p">)))</span>

<span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
<span class="n">species</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

<span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">species</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="sh">'</span><span class="s">Greens</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Image distribution amongst species</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_9_0.png" />
</figure>

<h3 id="observations---data-distribution">Observations - Data distribution</h3>

<ul>
  <li>The above figure depicts an unbalanced dataset. Indeed, there is a three-time factor between the most common class (Loose Silky-bent) and the least common class (Common wheat).</li>
  <li>The agricultural plants (wheat, maize, beet) are less present in the dataset compared to wild weeds.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span><span class="p">)):</span>
    <span class="c1"># select random images from class
</span>    <span class="n">image_names</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span>
        <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">image_name</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">image_names</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">image_name</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">image_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_11_0.png" />
</figure>

<h3 id="observations---data-content">Observations - Data content</h3>

<p>A few observations from each class are depicted in the above figure. The following observations can be made:</p>

<ol>
  <li>All images are top-down photographs.</li>
  <li>The images have <strong>different sizes</strong>. This will have to be investigated.</li>
  <li>If we assume that the soil gravels have the same size in all picture, it appears that the images are taken at various distances from the plants. This can create several issues with the model:
 a. The size of the gravels can be interpreted to classify a plant if certain species are consistently being photographed from the same distance.
 b. If the distance from the camera varies within a class, it can create confusion in the model as the definition of the plants will be different.</li>
  <li>Some pictures are <strong>out of focus</strong>. This is an issue as shape detection becomes harder with blurry edges.</li>
  <li>Several other components can be identified on the pictures. If these only appear with certain species, the model might learn to identify certain species based on the presence of unrelated components such as:
 a. Gravels
 b. Tags
 c. Rulers or dividers</li>
  <li>The images have been taken at <strong>various step of the growth cycle</strong> of the plants. For instance, for the same species, some pictures show a single leaf while other shows more mature specimen with multiple large leaves.</li>
</ol>

<h2 id="data-investigation">Data Investigation</h2>

<h3 id="file-number-vs-image-size">File Number vs Image Size</h3>

<p>Prior to investigating the relationships between file number, image shape, and image resolution, we import the data into a pandas DataFrame to facilitate our analysis.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># instantiate main DataFrame
</span><span class="n">resolution_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># extract image information
</span><span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span><span class="p">):</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">folder</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)</span>
        <span class="n">resolution_df</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">:</span> <span class="nb">file</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">:</span> <span class="n">folder</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">},</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># compute image ratio
</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">ratio</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># isolate file number
</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">extract</span><span class="p">(</span>
    <span class="sa">r</span><span class="sh">'</span><span class="s">(\d+)</span><span class="sh">'</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int16</span><span class="p">)</span>

<span class="c1"># print head to confirm extraction
</span><span class="n">resolution_df</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
  <style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>file_name</th>
      <th>species</th>
      <th>width</th>
      <th>height</th>
      <th>ratio</th>
      <th>file_num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>348.png</td>
      <td>Cleavers</td>
      <td>450.0</td>
      <td>450.0</td>
      <td>1.0</td>
      <td>348</td>
    </tr>
    <tr>
      <td>1</td>
      <td>176.png</td>
      <td>Cleavers</td>
      <td>295.0</td>
      <td>295.0</td>
      <td>1.0</td>
      <td>176</td>
    </tr>
    <tr>
      <td>2</td>
      <td>88.png</td>
      <td>Cleavers</td>
      <td>299.0</td>
      <td>299.0</td>
      <td>1.0</td>
      <td>88</td>
    </tr>
    <tr>
      <td>3</td>
      <td>162.png</td>
      <td>Cleavers</td>
      <td>194.0</td>
      <td>194.0</td>
      <td>1.0</td>
      <td>162</td>
    </tr>
    <tr>
      <td>4</td>
      <td>189.png</td>
      <td>Cleavers</td>
      <td>438.0</td>
      <td>438.0</td>
      <td>1.0</td>
      <td>189</td>
    </tr>
  </tbody>
</table>
</div>

<p>The data has been imported into a dataframe. We have created two new features:</p>

<ol>
  <li>Image ratio - Ratio between image width and image height</li>
  <li>File number - Number associated to the image</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resolution_df</span><span class="p">.</span><span class="nf">describe</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>width</th>
      <th>height</th>
      <th>ratio</th>
      <th>file_num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>count</td>
      <td>5539.000000</td>
      <td>5539.000000</td>
      <td>5539.000000</td>
      <td>5539.000000</td>
    </tr>
    <tr>
      <td>mean</td>
      <td>355.202022</td>
      <td>354.783535</td>
      <td>1.000231</td>
      <td>267.794187</td>
    </tr>
    <tr>
      <td>std</td>
      <td>295.108600</td>
      <td>292.700461</td>
      <td>0.007453</td>
      <td>183.276616</td>
    </tr>
    <tr>
      <td>min</td>
      <td>49.000000</td>
      <td>49.000000</td>
      <td>0.943368</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <td>25%</td>
      <td>152.000000</td>
      <td>152.000000</td>
      <td>1.000000</td>
      <td>118.000000</td>
    </tr>
    <tr>
      <td>50%</td>
      <td>267.000000</td>
      <td>267.000000</td>
      <td>1.000000</td>
      <td>236.000000</td>
    </tr>
    <tr>
      <td>75%</td>
      <td>469.000000</td>
      <td>469.000000</td>
      <td>1.000000</td>
      <td>394.000000</td>
    </tr>
    <tr>
      <td>max</td>
      <td>3652.000000</td>
      <td>3457.000000</td>
      <td>1.332083</td>
      <td>805.000000</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can now create several investigation to establish whether of not the file numbers have been assigned randomly.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="mi">4</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">"</span><span class="s">hls</span><span class="sh">"</span><span class="p">,</span> <span class="mi">12</span><span class="p">)[</span><span class="n">idx</span><span class="p">]],</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_20_0.png" />
</figure>

<p><strong>Observations</strong></p>

<p>The first important observation is related to the number of files and the maximum resolution per plant. As shown in the above plot, the maximum resolution greatly varies between classes (~3000 pixel width for “Black-grass” vs. ~1000 pixel width for “Cleavers”).</p>

<p>A pattern appears when plotting the image width against the file number. As the file number increases, the width of the image increases up to a certain point, then the image size abruptly decreases. <strong>The pattern repeats approximately four times per species.</strong> Note that the pattern is not as well defined for the Back-grass and the Loose Silky bent species.</p>

<p>From this observation, we can make the following assumptions:</p>

<ul>
  <li>Four different plant specimens have been photographed at various stage of their growth cycles.</li>
  <li>Four batches of specimens have been photographed simultaneously during their growth. Once the specimen are matured enough, they stopped being photographed.</li>
</ul>

<p>We now need to create additional visualizations to validate our hypotheses.</p>

<p>There is one aspect of the data distribution to account for. Indeed, the trends are not perfect and some noise is clearly visible. In order to identify the file number corresponding to the beginning of a new resolution cycle, <strong>we are applying a rolling average</strong>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># define a drop ratio between batches
</span><span class="n">max_ratio</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c1"># store the file number corresponding to drop in resolution
</span><span class="n">cutoff_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># prepare plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># iterate over each plant
</span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>

    <span class="c1"># sort per file num
</span>    <span class="n">plant_df</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span>
                                 <span class="n">plant</span><span class="p">].</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># rolling max
</span>    <span class="n">window</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">].</span><span class="nf">rolling</span><span class="p">(</span>
        <span class="n">window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="n">window</span><span class="p">).</span><span class="nf">max</span><span class="p">()</span>

    <span class="c1"># find drop
</span>    <span class="n">drops</span> <span class="o">=</span> <span class="n">plant_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span>
         <span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">].</span><span class="nf">shift</span><span class="p">(</span><span class="o">-</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">].</span><span class="nf">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">plant_df</span><span class="p">[</span><span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">].</span><span class="nf">max</span><span class="p">()</span> <span class="o">*</span>
         <span class="n">max_ratio</span><span class="p">),</span> <span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span>

    <span class="n">cutoff_df</span> <span class="o">=</span> <span class="n">cutoff_df</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">:</span> <span class="n">plant</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">:</span> <span class="n">drops</span><span class="p">.</span><span class="nf">to_list</span><span class="p">()</span>
    <span class="p">},</span>
                                 <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="mi">4</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">plant_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">],</span>
                        <span class="n">plant_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sh">'</span><span class="s">roll_max_width</span><span class="sh">'</span><span class="p">],</span>
                        <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span>
                        <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">drop_val</span> <span class="ow">in</span> <span class="n">cutoff_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cutoff_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">].</span><span class="nf">all</span><span class="p">():</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">axvline</span><span class="p">(</span><span class="n">drop_val</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">plant_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">],</span>
                           <span class="n">y</span><span class="o">=</span><span class="n">plant_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">],</span>
                           <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">"</span><span class="s">hls</span><span class="sh">"</span><span class="p">,</span> <span class="mi">12</span><span class="p">)[</span><span class="n">idx</span><span class="p">]],</span>
                           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_22_0.png" />
</figure>

<p>We can now plot various photographs per cycle and determine if there is any correlation (same seedling, same growth stage).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>

    <span class="c1"># isolate first cycle cutoff
</span>    <span class="n">cutoff_num</span> <span class="o">=</span> <span class="n">cutoff_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cutoff_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span>
                               <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># isolate file numbers less that cutoff_num
</span>    <span class="n">all_file_nums</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cutoff_num</span><span class="p">)].</span><span class="nf">sort_values</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># select images at 0%, 25%, 50%, 75%, and 100% of cycle
</span>    <span class="n">selected_file_nums</span> <span class="o">=</span> <span class="n">all_file_nums</span><span class="p">.</span><span class="nf">quantile</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span>
                                                 <span class="mf">1.00</span><span class="p">]).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">).</span><span class="n">values</span>

    <span class="c1"># plot images
</span>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">file_num</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">selected_file_nums</span><span class="p">):</span>
        <span class="c1"># some images contain an underscore in the file name
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">)</span> <span class="o">+</span>
                                   <span class="sh">'</span><span class="s">.png</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">)</span> <span class="o">+</span>
                                   <span class="sh">'</span><span class="s">-1.png</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># plot image, hide grid, set title
</span>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">))</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_24_0.png" />
</figure>

<p><strong>Observations</strong></p>

<p>For the above plots and displayed photographs, a <strong>clear relationship can be identified between file number and plant size</strong> (photo size). We can later leverage this information to extract a new feature corresponding to the seedling size.<br />
We can hypothesize that the original photographs were taken at full resolution and that seedlings were manually cropped to create the individual images.</p>

<h3 id="image-shape-and-resolution">Image Shape and Resolution</h3>

<h3 id="investigation">Investigation</h3>

<p>As previously established, the image sizes range from 49 pixels to 3652 pixels. This is an extreme difference that will impact the model. We are now going to dig deeper and investigate if the image size is correlated to the classes and if the set contains outliers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">jointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">#4CB391</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_29_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">Pearson correlation between image height and image width: {:.5f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
        <span class="n">resolution_df</span><span class="p">[[</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">]].</span><span class="nf">corr</span><span class="p">().</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pearson correlation between image height and image width: 0.99922
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">{:.2f}% of the images are square (ratio=1.)</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">((</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">ratio</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>98.77% of the images are square (ratio=1.)
</code></pre></div></div>

<p><strong>Observations</strong></p>

<p>From the above distribution plot, it appear that most of the images present a 1:1 shape ratio. We can now filter the square images and search for additional information using the non-square images.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">species</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Distribution of image width between species</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'Distribution of image width between species')
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_33_1.png" />
</figure>

<p><strong>Observations</strong></p>

<p>The above boxplot shows the followings:</p>

<ol>
  <li>Each class contains outliers with large width.</li>
  <li>The width distribution is not consistent between classes.</li>
  <li>The minimum width seems to be roughly identical between classes (~60 pixels) except for the “Charlock” class.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Minimum image height and width across species:</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])[[</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">]].</span><span class="nf">min</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Minimum image height and width across species:
                           width  height
species                                 
Black-grass                 73.0    73.0
Charlock                   121.0   121.0
Cleavers                    66.0    66.0
Common Chickweed            54.0    54.0
Common wheat                51.0    51.0
Fat Hen                     55.0    55.0
Loose Silky-bent            71.0    71.0
Maize                       54.0    54.0
Scentless Mayweed           49.0    49.0
Shepherd Purse              63.0    63.0
Small-flowered Cranesbill   62.0    62.0
Sugar beet                  49.0    49.0
</code></pre></div></div>

<p>We previously saw that most of the images are square. We can focus on the rectangular image to see if there is a pattern in their distribution (species, size).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filtered_df</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">ratio</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.00</span><span class="p">]</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">jointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">filtered_df</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">#4CB391</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_37_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">Pearson correlation between image height and image width for rectangular images: {:.5f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
        <span class="n">filtered_df</span><span class="p">[[</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">]].</span><span class="nf">corr</span><span class="p">().</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pearson correlation between image height and image width for rectangular images: 0.99013
</code></pre></div></div>

<p><strong>Observations</strong></p>

<p>The height/width of rectangular images are distributed is a manner similar as the rest of the data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">filtered_df</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">#4CB391</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">hue</span><span class="o">=</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">"</span><span class="s">bright</span><span class="sh">"</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_40_0.png" />
</figure>

<p><strong>Observations</strong></p>

<p>From the above plots, we can draw the following observations:</p>

<ol>
  <li>Most of the rectangular images from the “Loose Silky-bent” are small images &lt;700pixels)</li>
  <li>Eventhough these images are not perfectly square, they are fairly square (correlation of 0.99).</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="k">for</span> <span class="n">single</span> <span class="ow">in</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="nf">unique</span><span class="p">():</span>
    <span class="n">sns</span><span class="p">.</span><span class="nf">kdeplot</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">single</span><span class="p">].</span><span class="n">width</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">single</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">KDE-Plot of image width given species</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Image width</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Density</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">#4CB391</span><span class="sh">"</span><span class="p">,</span> <span class="n">hist_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">alpha</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.8</span><span class="p">},</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">color</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">})</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Image width</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Density</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Overall image width distribution</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_42_0.png" />
</figure>

<p>The above plots show distribution that are typical for log distribution. We can apply a log transformation to normalize them.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="k">for</span> <span class="n">single</span> <span class="ow">in</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="nf">unique</span><span class="p">():</span>
    <span class="n">sns</span><span class="p">.</span><span class="nf">kdeplot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span>
        <span class="n">resolution_df</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">single</span><span class="p">].</span><span class="n">width</span><span class="p">),</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">single</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">KDE-Plot of image width given species</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Image width</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Density</span><span class="sh">"</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">.</span><span class="n">width</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">#4CB391</span><span class="sh">"</span><span class="p">,</span> <span class="n">hist_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">alpha</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.8</span><span class="p">},</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">color</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">})</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Image width</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Density</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Overall image width distribution</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_44_0.png" />
</figure>

<p><strong>Observations</strong></p>

<ol>
  <li>Three groups can be identified from the above plots.</li>
  <li>These groups are highly tied to a subset of species. This could be a valuable add-on to our model.</li>
</ol>

<h2 id="feature-engineering">Feature Engineering</h2>

<p>During our investigation, we have reached the following conclusions:</p>

<ol>
  <li>The image size can be a good indicator of the plant species.</li>
  <li>For each species, we have identified image cycles through the file names. We have extracted approximate cut-off for each cycle and each species.</li>
  <li>Each image contains a certain number of external components that can contaminate the model.</li>
</ol>

<p>One of the first focus of our feature engineering is going to <strong>try to estimate the growth state</strong>. To do so, we will cluster the width of the images.</p>

<p><em>Note: since we have established that most of the images are square, we are only going to use the width as our main feature from now on.</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># normalize and scale the data
</span><span class="n">scaler</span> <span class="o">=</span> <span class="nc">StandardScaler</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">K</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">inertias</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="n">km</span> <span class="o">=</span> <span class="nc">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
    <span class="n">km</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># compute inertias
</span>    <span class="n">inertias</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">km</span><span class="p">.</span><span class="n">inertia_</span><span class="p">)</span> 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=0, max=17), HTML(value='')))
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">inertias</span><span class="p">,</span> <span class="sh">'</span><span class="s">X-</span><span class="sh">'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">#4CB391</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Values of K</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Inertia</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">The Elbow Method using Inertia</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_48_0.png" />
</figure>

<p><strong>Observations</strong></p>

<p>Using the elbow method on the inertia, we can consider <strong>5</strong> to be an appropriate number of clusters for our growth cycle.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># re-train KMeans using optimal number of clusters
</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># assign cluster to records
</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">km</span><span class="p">.</span><span class="nf">fit_predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">"</span><span class="s">hls</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[</span><span class="n">x</span><span class="p">]).</span><span class="n">values</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">,</span>
           <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">height</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">,</span>
           <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
           <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Image width</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Image height</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Width Clustering</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="k">for</span> <span class="n">cluster_center</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">scaler</span><span class="p">.</span><span class="nf">inverse_transform</span><span class="p">((</span><span class="n">km</span><span class="p">.</span><span class="n">cluster_centers_</span><span class="p">))):</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster_center</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cluster_center</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">160</span><span class="p">)</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_51_0.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="mi">4</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">"</span><span class="s">hls</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
        <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">width</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span>
                   <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">'</span><span class="s">hls</span><span class="sh">'</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[</span><span class="n">x</span><span class="p">],</span>
                   <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Cluster </span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                   <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">'</span><span class="s">hls</span><span class="sh">'</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[</span><span class="n">x</span><span class="p">],</span>
                   <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper right</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_52_0.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">scaler</span><span class="p">.</span><span class="nf">inverse_transform</span><span class="p">((</span><span class="n">km</span><span class="p">.</span><span class="n">cluster_centers_</span><span class="p">))).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Cluster {}: width = {:.1f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cluster 0: width = 93.7
Cluster 1: width = 517.8
Cluster 2: width = 294.4
Cluster 3: width = 166.0
Cluster 4: width = 1008.7
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CLUSTER_ORDER</span> <span class="o">=</span> <span class="n">km</span><span class="p">.</span><span class="n">cluster_centers_</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nf">argsort</span><span class="p">().</span><span class="nf">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">CLUSTER_ORDER</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0, 3, 2, 1, 4]
</code></pre></div></div>

<p><strong>Observations</strong></p>

<p>The above plots show the results of our clustering. We can make the following observations:</p>

<ul>
  <li>most plant present photographs in the 5 clusters.</li>
  <li>for each plant, the repetition of growth cycle through each period (file numbers) are identical.</li>
</ul>

<p>We can now plot individual of each cycle and validate our assumptions.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>

<span class="c1"># iterate over species
</span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>

    <span class="c1"># iterate over clusters
</span>    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">CLUSTER_ORDER</span><span class="p">):</span>

        <span class="c1"># select subset
</span>        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">cycle</span><span class="p">)]</span>

        <span class="c1"># select random image
</span>        <span class="k">if</span> <span class="n">filtered_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>

            <span class="c1"># plot image, hide grid, set title
</span>            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">n</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">n</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">n</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">Cluster </span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>
        
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_56_0.png" />
</figure>

<p>We also would like to obtain the count of photographs per species and per cluster.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CLUSTER_ORDER_str</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">CLUSTER_ORDER</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># aggregate by species and growth_lvl
</span><span class="n">agg_df</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]).</span><span class="nf">size</span><span class="p">().</span><span class="nf">unstack</span><span class="p">().</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">agg_df</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">agg_df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># compute percentable per species
</span><span class="n">agg_df</span> <span class="o">=</span> <span class="n">agg_df</span> <span class="o">/</span> <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()</span>

<span class="n">agg_df</span> <span class="o">=</span> <span class="n">agg_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">CLUSTER_ORDER</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">agg_df</span><span class="p">.</span><span class="nf">reindex</span><span class="p">(</span><span class="n">CLUSTER_ORDER_str</span><span class="p">),</span>
            <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="sh">"</span><span class="s">.0%</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">BuGn</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
            <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Cluster distribution per species</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_59_0.png" />
</figure>

<p><strong>Observations</strong></p>

<ul>
  <li>The new growth cycle cluster appears to be a good feature for certain species. For instance 43% of the “Scentless Mayweed” can be found in cluster 0. In addition, some cluster barely contain any individual for certain species.</li>
  <li>This finding can be considered as data leakage and our model may be tempted to predict a class based on the size of the image. Something will have to be done to prevent such a flaw.</li>
  <li>Finally, we observed early on, a class imbalance. The imbalance combined with the leakage can become really problematic and will both need to be addressed.</li>
</ul>

<h2 id="convolutional-neural-network">Convolutional Neural Network</h2>

<p>In this section, we will train a CNN to predict the <code class="language-plaintext highlighter-rouge">species</code> feature. The approach is divided between the following steps:</p>

<ol>
  <li>Encode the target feature</li>
  <li>Download the data</li>
  <li>Split the data between a training and test set</li>
  <li>Perform data augmentation</li>
  <li>Determine the cost function to be optimized</li>
</ol>

<h3 id="data-loader-validation-and-data--augmentation">Data Loader, Validation and Data  Augmentation</h3>

<p>In order for our model to generalize well on unseen data, a good practice consists of using image transformation to create new unseen examples.<br />
We need to ensure that our model does not over fit the training data. To do so, we are using a training set and a test set both taken from the original dataset.</p>

<p>Keras contains useful tools to help process image files and feed them in batches to the model. We will be using a generator for both the train and test phases.</p>

<ul>
  <li>First, we must create a new feature to our dataset which contains the full path to each image.</li>
  <li>Then, we can create two generators, the training generator will contains several data augmentation transformation (horizontal and vertical flips, zoom).</li>
  <li>Both the train and test generator will normalize the pixel values.</li>
  <li>Finally, the images will be sent to the model using batches of 32 RGB images reshaped at 70x70.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create full path to data
</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">full_path</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../Data/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">resolution_df</span><span class="p">[</span>
    <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">]</span>
<span class="n">resolution_df</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>file_name</th>
      <th>species</th>
      <th>width</th>
      <th>height</th>
      <th>ratio</th>
      <th>file_num</th>
      <th>growth_lvl</th>
      <th>full_path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>348.png</td>
      <td>Cleavers</td>
      <td>450.0</td>
      <td>450.0</td>
      <td>1.0</td>
      <td>348</td>
      <td>1</td>
      <td>../Data/Cleavers/348.png</td>
    </tr>
    <tr>
      <td>1</td>
      <td>176.png</td>
      <td>Cleavers</td>
      <td>295.0</td>
      <td>295.0</td>
      <td>1.0</td>
      <td>176</td>
      <td>2</td>
      <td>../Data/Cleavers/176.png</td>
    </tr>
    <tr>
      <td>2</td>
      <td>88.png</td>
      <td>Cleavers</td>
      <td>299.0</td>
      <td>299.0</td>
      <td>1.0</td>
      <td>88</td>
      <td>2</td>
      <td>../Data/Cleavers/88.png</td>
    </tr>
    <tr>
      <td>3</td>
      <td>162.png</td>
      <td>Cleavers</td>
      <td>194.0</td>
      <td>194.0</td>
      <td>1.0</td>
      <td>162</td>
      <td>3</td>
      <td>../Data/Cleavers/162.png</td>
    </tr>
    <tr>
      <td>4</td>
      <td>189.png</td>
      <td>Cleavers</td>
      <td>438.0</td>
      <td>438.0</td>
      <td>1.0</td>
      <td>189</td>
      <td>1</td>
      <td>../Data/Cleavers/189.png</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># image size
</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">224</span>

<span class="c1"># batch size
</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="c1"># random seed
</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">10</span>
</code></pre></div></div>

<p>At this point of the analysis, the images have not been loaded into a numpy array. Using the data stored in the pandas DataFrame, we load the images into a single array of size (N, scale, scale).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load images into a numpy array
</span><span class="n">full_set</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">full_path</span><span class="sh">'</span><span class="p">]):</span>
    <span class="n">full_set</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">i</span><span class="p">)[:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],(</span><span class="n">scale</span><span class="p">,</span><span class="n">scale</span><span class="p">)))</span>
<span class="n">full_set</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">asarray</span><span class="p">(</span><span class="n">full_set</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">{} images in full set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">full_set</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=0, max=5539), HTML(value='')))



5539 images in full set.
</code></pre></div></div>

<p>Now that the images have been loaded and resized, we have to work on the target labels. The current feature used to encode the species contains various strings. We need to convert the list of labels into a one-hot encoded array of size (N, n) where n is the number of species in the dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># encode target
# create encoder and fit on training set
</span><span class="n">labels</span> <span class="o">=</span> <span class="nc">LabelEncoder</span><span class="p">()</span>
<span class="n">labels</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># display target classes
</span><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Classes</span><span class="sh">'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">))</span>

<span class="c1"># encode labels
</span><span class="n">encodedlabels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>
<span class="n">clearalllabels</span> <span class="o">=</span> <span class="n">np_utils</span><span class="p">.</span><span class="nf">to_categorical</span><span class="p">(</span><span class="n">encodedlabels</span><span class="p">)</span>

<span class="c1"># store number of classes for future use
</span><span class="n">n_classes</span> <span class="o">=</span> <span class="n">clearalllabels</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Classes['Black-grass' 'Charlock' 'Cleavers' 'Common Chickweed' 'Common wheat'
 'Fat Hen' 'Loose Silky-bent' 'Maize' 'Scentless Mayweed' 'Shepherd Purse'
 'Small-flowered Cranesbill' 'Sugar beet']
</code></pre></div></div>

<p>Before we can feed our data into a model, an essential step consists of scaling the pixel values down to range from 0 to 1. This will stabilize the training of the model. Since RGB encoding ranges from 0 to 255, we will divide the pixel values by 255.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># scale data
</span><span class="n">full_set</span> <span class="o">=</span> <span class="n">full_set</span> <span class="o">/</span> <span class="mf">255.</span>
</code></pre></div></div>

<p>Finally, we need to establish our validation strategy. We divide the entire set of images into a training set (90%) and a test set (10%). Since the classes are unbalanced, we are forcing the train-test-split to be as consistent as possible by stratifying the selection process.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># isolate train and test indexes
</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">full_set</span><span class="p">,</span>
                                                    <span class="n">clearalllabels</span><span class="p">,</span>
                                                    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                    <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                                                    <span class="n">stratify</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot proportions
</span><span class="n">train_split</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)).</span><span class="nf">value_counts</span><span class="p">()</span><span class="o">/</span><span class="n">y_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
<span class="n">test_split</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)).</span><span class="nf">value_counts</span><span class="p">()</span><span class="o">/</span><span class="n">y_test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">train_split</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train_split</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">#4CB391</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">test_split</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train_split</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">#4CB391</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Class distribution - Training Set</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Class distribution - Test Set</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Proportion (%)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Proportion (%)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Class ID</span><span class="sh">"</span><span class="p">);</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_74_0.png" />
</figure>

<p>Finally, we will use data augmentation to help the model generalize on unseen data. The following actions can be taken:</p>

<ol>
  <li>Rotation from -180 to 180 deg</li>
  <li>Width and height shifts of 10%</li>
  <li>Shear range of 10%</li>
  <li>Zoom range of 10%</li>
  <li>Horizontal and vertical flips</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># data augmentation
</span><span class="n">generator</span> <span class="o">=</span> <span class="nc">ImageDataGenerator</span><span class="p">(</span><span class="n">rotation_range</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
                               <span class="n">width_shift_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">height_shift_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">brightness_range</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                               <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">channel_shift_range</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">fill_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">nearest</span><span class="sh">'</span><span class="p">,</span>
                               <span class="n">horizontal_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">vertical_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="sh">'</span><span class="s">float32</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="build-model">Build Model</h3>

<p>It is now time to build our model. We will use a Convolutional Neural Network (CNN). The three CNN blocks are defined as follows:</p>

<ol>
  <li>Conv2D + relu</li>
  <li>BatchNorm</li>
  <li>Conv2D + relu</li>
  <li>Maxpooling</li>
  <li>BatchNorm</li>
  <li>Dropout</li>
</ol>

<p>The CNN is followed by two dense layers equipped with BatchNorm and Dropout.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">Sequential</span><span class="p">()</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Flatten</span><span class="p">())</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">())</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">())</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dense</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">softmax</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="metric-definition-and-optimizer">Metric Definition and Optimizer</h3>

<p>Before we can train our model, we have to define the followings:</p>

<ol>
  <li><strong>Optimizing metrics</strong>: in our case, we will be optimizing the cross-entropy. This is typical for a multi-class problem.</li>
  <li><strong>Optimizer technique</strong>: an Adam optimizer is used.</li>
  <li><strong>Optimization strategy</strong>: that is how to adjust the learning rate, when to stop the training.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># optimizer
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">beta_1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">beta_2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>

<span class="c1"># define loss function
</span><span class="n">model</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="p">.</span><span class="n">categorical_crossentropy</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">acc</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># define optimization schedule with callbacks
</span><span class="n">lrate</span> <span class="o">=</span> <span class="nc">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">,</span>
                          <span class="n">factor</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                          <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./Model_0/weights.best_{epoch:02d}-{val_acc:.2f}.hdf5</span><span class="sh">"</span>
<span class="n">checkpoints</span> <span class="o">=</span> <span class="nc">ModelCheckpoint</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span>
                              <span class="n">monitor</span><span class="o">=</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">save_best_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                              <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">callbacks_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lrate</span><span class="p">,</span> <span class="n">checkpoints</span><span class="p">,</span> <span class="nc">TQDMNotebookCallback</span><span class="p">(</span><span class="n">leave_inner</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">leave_outer</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>

<span class="n">model</span><span class="p">.</span><span class="nf">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "sequential_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_1 (Conv2D)            (None, 220, 220, 32)      2432      
_________________________________________________________________
batch_normalization_1 (Batch (None, 220, 220, 32)      128       
_________________________________________________________________
conv2d_2 (Conv2D)            (None, 216, 216, 64)      51264     
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 108, 108, 64)      0         
_________________________________________________________________
batch_normalization_2 (Batch (None, 108, 108, 64)      256       
_________________________________________________________________
dropout_1 (Dropout)          (None, 108, 108, 64)      0         
_________________________________________________________________
conv2d_3 (Conv2D)            (None, 104, 104, 64)      102464    
_________________________________________________________________
batch_normalization_3 (Batch (None, 104, 104, 64)      256       
_________________________________________________________________
conv2d_4 (Conv2D)            (None, 100, 100, 64)      102464    
_________________________________________________________________
max_pooling2d_2 (MaxPooling2 (None, 50, 50, 64)        0         
_________________________________________________________________
batch_normalization_4 (Batch (None, 50, 50, 64)        256       
_________________________________________________________________
dropout_2 (Dropout)          (None, 50, 50, 64)        0         
_________________________________________________________________
conv2d_5 (Conv2D)            (None, 46, 46, 128)       204928    
_________________________________________________________________
batch_normalization_5 (Batch (None, 46, 46, 128)       512       
_________________________________________________________________
conv2d_6 (Conv2D)            (None, 42, 42, 128)       409728    
_________________________________________________________________
max_pooling2d_3 (MaxPooling2 (None, 21, 21, 128)       0         
_________________________________________________________________
batch_normalization_6 (Batch (None, 21, 21, 128)       512       
_________________________________________________________________
dropout_3 (Dropout)          (None, 21, 21, 128)       0         
_________________________________________________________________
conv2d_7 (Conv2D)            (None, 17, 17, 256)       819456    
_________________________________________________________________
batch_normalization_7 (Batch (None, 17, 17, 256)       1024      
_________________________________________________________________
conv2d_8 (Conv2D)            (None, 13, 13, 256)       1638656   
_________________________________________________________________
max_pooling2d_4 (MaxPooling2 (None, 6, 6, 256)         0         
_________________________________________________________________
batch_normalization_8 (Batch (None, 6, 6, 256)         1024      
_________________________________________________________________
dropout_4 (Dropout)          (None, 6, 6, 256)         0         
_________________________________________________________________
flatten_1 (Flatten)          (None, 9216)              0         
_________________________________________________________________
dense_1 (Dense)              (None, 256)               2359552   
_________________________________________________________________
batch_normalization_9 (Batch (None, 256)               1024      
_________________________________________________________________
dropout_5 (Dropout)          (None, 256)               0         
_________________________________________________________________
dense_2 (Dense)              (None, 256)               65792     
_________________________________________________________________
batch_normalization_10 (Batc (None, 256)               1024      
_________________________________________________________________
dropout_6 (Dropout)          (None, 256)               0         
_________________________________________________________________
dense_3 (Dense)              (None, 12)                3084      
=================================================================
Total params: 5,765,836
Trainable params: 5,762,828
Non-trainable params: 3,008
_________________________________________________________________
</code></pre></div></div>

<pre><code class="language-pythonpython"># Fit the model
history = model.fit_generator(generator.flow(X_train, y_train, batch_size=batch_size),
                    epochs=50,
                    steps_per_epoch=np.ceil(X_train.shape[0] / batch_size),
                    validation_data=(X_test, y_test),
                    callbacks=callbacks_list,
                    verbose=2)
</code></pre>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Epoch</span> <span class="mi">1</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2586</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">2.1630</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.3713</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">9.3464</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.2022</span>  
<span class="n">Epoch</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2562</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">1.4018</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.5561</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">1.7693</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.5235</span>  
<span class="n">Epoch</span> <span class="mi">3</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2554</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">1.1133</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.6468</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">1.6343</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.5505</span>  
<span class="p">.</span>  
<span class="p">.</span>  
<span class="p">.</span>  
<span class="n">Epoch</span> <span class="mi">49</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2746</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.2220</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.9234</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.3810</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8736</span>  
<span class="n">Epoch</span> <span class="mi">50</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2747</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.2100</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.9202</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.2375</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.9152</span>  
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lr</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">lr_0.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">history_0.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">loss</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">training</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">dodgerblue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_loss</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">validation</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">crimson</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Loss function</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">epochs</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">acc</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">training</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">dodgerblue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">validation</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">crimson</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Accuracy</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">epochs</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">accuracy</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="sh">'</span><span class="s">lr</span><span class="sh">'</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">dodgerblue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Learning Rate</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">epochs</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">learning rate</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.0011</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">);</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_85_0.png" />
</figure>

<p><strong>Results</strong></p>

<p>The value of the loss functions is almost identical between the two sets. We can see that the model has reached a stable configuration as the loss function of the training set and test set both plateau after 15 epochs.</p>

<p>In addition, the accuracy of both models reach around 90%.</p>

<p><strong>In conclusion, the training of the model is considered to be successful</strong>. Overfitting has been prevented by using data augmentation techniques and the model performs well on both sets.</p>

<p>The next step is to investigate the performances of the model by looking at predictions.</p>

<h3 id="predictions-and-results">Predictions and Results</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Maximum accuray on validation step:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"> Epoch: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">])))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">        {:.2f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Maximum accuray on validation step:
 Epoch: 43
        92.42%
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load best model
</span><span class="n">model</span><span class="p">.</span><span class="nf">load_weights</span><span class="p">(</span><span class="sh">"</span><span class="s">./Model_0/weights.best_43-0.92.hdf5</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Make predictions on both the train and test sets.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Training Data</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">TAD_tools_v01</span><span class="p">.</span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">y_train_pred</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">,</span>
                                    <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">Oranges</span><span class="p">,</span>
                                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mf">11.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Training Data
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_93_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Test Data</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">TAD_tools_v01</span><span class="p">.</span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">y_test_pred</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">,</span>
                                    <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">Greens</span><span class="p">,</span>
                                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mf">11.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test Data
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_94_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Accurancy:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Train: {:.2f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_train_pred</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Test:  {:.2f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_test_pred</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">F1-score</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Train: {:.3f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_train_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="sh">'</span><span class="s">weighted</span><span class="sh">'</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Test:  {:.3f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="sh">'</span><span class="s">weighted</span><span class="sh">'</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Classification Report</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">classification_report</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_train_pred</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_test_pred</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Accurancy:
   Train: 93.68%
   Test:  92.78%

F1-score
   Train: 93.670%
   Test:  92.916%

Classification Report
              precision    recall  f1-score   support

           0       0.70      0.66      0.68       278
           1       0.97      0.98      0.98       407
           2       0.89      0.96      0.92       301
           3       0.99      0.94      0.97       642
           4       0.81      0.99      0.89       228
           5       0.99      0.98      0.98       484
           6       0.91      0.86      0.89       686
           7       0.99      0.97      0.98       231
           8       0.91      0.98      0.95       546
           9       0.98      0.91      0.95       247
          10       0.99      0.98      0.99       518
          11       0.99      0.97      0.98       417

    accuracy                           0.94      4985
   macro avg       0.93      0.93      0.93      4985
weighted avg       0.94      0.94      0.94      4985

              precision    recall  f1-score   support

           0       0.61      0.74      0.67        31
           1       0.93      0.93      0.93        45
           2       0.82      0.97      0.89        34
           3       0.99      0.94      0.96        71
           4       0.89      1.00      0.94        25
           5       1.00      0.98      0.99        54
           6       0.92      0.80      0.86        76
           7       1.00      1.00      1.00        26
           8       0.94      0.95      0.94        61
           9       1.00      0.89      0.94        27
          10       0.98      0.98      0.98        58
          11       0.98      0.98      0.98        46

    accuracy                           0.93       554
   macro avg       0.92      0.93      0.92       554
weighted avg       0.93      0.93      0.93       554
</code></pre></div></div>

<p>In addition to the confusion matrix per species, we can show how well our basic model performs per species and per growth stage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># isolate train and test indexes as dataframe
</span><span class="n">df_X_train</span><span class="p">,</span> <span class="n">df_X_test</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">,</span>
                                                    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                    <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                                                    <span class="n">stratify</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># add predictions to dataframe
</span><span class="n">df_X_train</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">[</span><span class="n">y_train_pred</span><span class="p">]</span>
<span class="n">df_X_test</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">[</span><span class="n">y_test_pred</span><span class="p">]</span>

<span class="c1"># define if prediction is correct
</span><span class="n">df_X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">]</span>
<span class="n">df_X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># group predictions by growth-phase and species
</span><span class="n">df_X_train</span> <span class="o">=</span> <span class="n">df_X_train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">df_X_train</span> <span class="o">=</span> <span class="n">df_X_train</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="sh">"</span><span class="s">species</span><span class="sh">"</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">)</span>

<span class="n">df_X_test</span> <span class="o">=</span> <span class="n">df_X_test</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">df_X_test</span> <span class="o">=</span> <span class="n">df_X_test</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="sh">"</span><span class="s">species</span><span class="sh">"</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Training set:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">df_X_train</span><span class="p">.</span><span class="nf">reindex</span><span class="p">(</span><span class="n">CLUSTER_ORDER</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdYlGn</span><span class="sh">'</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">fontsize</span><span class="sh">"</span><span class="p">:</span><span class="mi">12</span><span class="p">})</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">"</span><span class="s">right</span><span class="sh">"</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="sh">"</span><span class="s">anchor</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Training set:
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_98_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Test set:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">df_X_test</span><span class="p">.</span><span class="nf">reindex</span><span class="p">(</span><span class="n">CLUSTER_ORDER</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdYlGn</span><span class="sh">'</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">fontsize</span><span class="sh">"</span><span class="p">:</span><span class="mi">12</span><span class="p">})</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">"</span><span class="s">right</span><span class="sh">"</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="sh">"</span><span class="s">anchor</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test set:
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_99_1.png" />
</figure>

<p><strong>Observations</strong><br />
From the above confusion matrices and classification reports, we notice that our model performs well across all classes but two (Black-grass and Loose Silky-bent).</p>

<p>Indeed, the accuracy on these two classes are only <strong>0.74</strong> for the Black-grass and <strong>0.80</strong> for the Loose Silky-bent) on the validation set. We can also notice that these accuracies for the two class because the model mostly misclassifies Black-grass for Loose Silky-bent and vice-versa.</p>

<p>In addition, our model tends to do better on fully grown plants. Indeed, the high-resolution images (cluster 4) are almost all perfectly classified (except for the Loose Silky-Bent and the Shepeherd Purse).</p>

<p>Let’s plot some of these errors against true specimens and assess if there is an apparent reason for the misclassifications.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create a mapping between labels and classes
</span><span class="n">id_class_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">label</span> <span class="k">for</span>  <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">)}</span>
<span class="n">class_id_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">id_class_mapping</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># true Black-grass predicted as Loose Silky-bent
</span><span class="n">false_loose_silky</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span>
    <span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">class_id_mapping</span><span class="p">[</span><span class="sh">'</span><span class="s">Black-grass</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">y_train_pred</span> <span class="o">==</span> <span class="n">class_id_mapping</span><span class="p">[</span><span class="sh">'</span><span class="s">Loose Silky-bent</span><span class="sh">'</span><span class="p">])]</span>

<span class="c1"># true Loose Silky-bent predicted as Black-grass
</span><span class="n">false_black_grass</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span>
    <span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">class_id_mapping</span><span class="p">[</span><span class="sh">'</span><span class="s">Loose Silky-bent</span><span class="sh">'</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">y_train_pred</span> <span class="o">==</span> <span class="n">class_id_mapping</span><span class="p">[</span><span class="sh">'</span><span class="s">Black-grass</span><span class="sh">'</span><span class="p">])]</span>

<span class="c1"># true Loose Silky-bent correctly predicted
</span><span class="n">true_loose_silky</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
    <span class="n">y_train_pred</span> <span class="o">==</span> <span class="n">class_id_mapping</span><span class="p">[</span><span class="sh">'</span><span class="s">Loose Silky-bent</span><span class="sh">'</span><span class="p">])]</span>

<span class="c1"># true Black-grass correctly predicted
</span><span class="n">true_black_grass</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">y_train_pred</span><span class="p">)</span>
                           <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_train_pred</span> <span class="o">==</span> <span class="n">class_id_mapping</span><span class="p">[</span><span class="sh">'</span><span class="s">Black-grass</span><span class="sh">'</span><span class="p">])]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">gridspec_kw</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">wspace</span><span class="sh">'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">hspace</span><span class="sh">'</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">grey</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>

        <span class="c1"># select set
</span>        <span class="k">if</span> <span class="n">R</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">C</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">true_black_grass</span>
        <span class="k">elif</span> <span class="n">R</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">C</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">false_loose_silky</span>
        <span class="k">elif</span> <span class="n">R</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">C</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">false_black_grass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">true_loose_silky</span>

        <span class="c1"># randomly select images
</span>        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">preds</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># true Black grass
</span>        <span class="n">images</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span> <span class="p">...]</span> <span class="o">*</span> <span class="mf">255.</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">R</span><span class="p">,</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">R</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">C</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[(</span><span class="n">row</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">col</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">C</span><span class="p">)]</span>
                <span class="c1">#image = np.array(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_xticklabels</span><span class="p">([])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_yticklabels</span><span class="p">([])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_aspect</span><span class="p">(</span><span class="sh">'</span><span class="s">equal</span><span class="sh">'</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Pred. BG</span><span class="sh">"</span>
                    <span class="n">ct</span> <span class="o">=</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">True BG</span><span class="sh">"</span>
                    <span class="n">cl</span> <span class="o">=</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span>
                <span class="k">elif</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Pred. LSB</span><span class="sh">"</span>
                    <span class="n">ct</span> <span class="o">=</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sh">""</span>
                    <span class="n">cl</span> <span class="o">=</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span>
                <span class="k">elif</span> <span class="n">row</span> <span class="o">&gt;=</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sh">""</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">True LSB</span><span class="sh">"</span>
                    <span class="n">ct</span> <span class="o">=</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span>
                    <span class="n">cl</span> <span class="o">=</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sh">""</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sh">""</span>
                    <span class="n">ct</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span>

                <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ct</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cl</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>

<span class="n">fig</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_103_0.png" />
</figure>

<p><strong>Observations</strong><br />
The above plot shows several examples of Black-grass and Loose silky-bent specimens both correctly and incorrectly classified. The main conclusion to draw from these observations is the that the model struggles to classify these two species because they are almost identical. Both of them can be described as thin and long green leaves similar to ordinary grass.</p>

<p>Before trying to adjust our model, we need to better understand our model and open the “black-box”. There are several model interpreters currently available. One of the popular one is LIME (Local Interpretable Model-Agnostic Explanations)</p>

<h3 id="model-inspection">Model Inspection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>

<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>

        <span class="c1"># isolate species
</span>        <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">n_classes</span><span class="p">)[</span><span class="n">m</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># find examples of the species
</span>        <span class="n">idxes</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">spec</span>
        
        <span class="c1"># isolate image
</span>        <span class="n">filtered_images</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">idxes</span><span class="p">,...]</span>
        
        <span class="c1"># random image
</span>        <span class="n">image</span> <span class="o">=</span> <span class="n">filtered_images</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">filtered_images</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],...]</span>

        <span class="c1"># make prediction
</span>        <span class="n">test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">,...],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># generate explanations
</span>        <span class="n">explainer</span> <span class="o">=</span> <span class="n">lime_image</span><span class="p">.</span><span class="nc">LimeImageExplainer</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">.</span><span class="nf">explain_instance</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="n">model</span><span class="p">.</span><span class="n">predict_proba</span><span class="p">,</span>  <span class="c1"># classification function
</span>            <span class="n">top_labels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">hide_color</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="mi">286</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">explanation</span><span class="p">.</span><span class="nf">get_image_and_mask</span><span class="p">(</span><span class="n">explanation</span><span class="p">.</span><span class="n">top_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">positive_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                    <span class="n">num_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                    <span class="n">hide_rest</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">img_boundry1</span> <span class="o">=</span> <span class="nf">mark_boundaries</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                
        <span class="c1"># convert label to species name
</span>        <span class="n">predicted_species</span> <span class="o">=</span> <span class="n">id_class_mapping</span><span class="p">[</span><span class="n">test_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        
        <span class="c1"># plot results
</span>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">img_boundry1</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">true </span><span class="sh">"</span> <span class="o">+</span> <span class="n">id_class_mapping</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s"> predicted: </span><span class="sh">"</span> <span class="o">+</span>
                           <span class="n">predicted_species</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_106_1.png" />
</figure>

<p><strong>Observations</strong></p>

<p>Although our model performs relatively well, we can see that in several cases shown above, the model uses the surrounding elements (pebbles, measuring label, and tags). The above plot shows areas leading to a positive predictions while red ones stands for negative impact on the predictions. We can see that the plant is often only partially used.</p>

<p>In conclusion, our model could be improved by removing extra components from the images.</p>

<h2 id="model-improvement">Model Improvement</h2>

<p>We have identified flaws in the predictions of our first model:</p>

<ol>
  <li>Uses external components to make predictions.</li>
  <li>Struggles to make the difference between <code class="language-plaintext highlighter-rouge">Black-grass</code> and <code class="language-plaintext highlighter-rouge">Loose Silky-bent</code></li>
</ol>

<p>One of the main observations we can make is related to the photographs we have and the type of predictions. We could try to eliminate the surrounding components by focusing on the green channel of the image. Indeed, no element besides the seedling is green.</p>

<p>There are many different ways to represent images. The most common ones are <strong>RGB</strong>, <strong>HSV</strong>, and <strong>CIELAB</strong>. They are defined as follows.</p>

<h3 id="image-decomposition">Image Decomposition</h3>

<p><strong>RGB</strong></p>

<p>Each image is encoded using three channels, this encoding is typically called RGB (Red, Blue, Green) corresponding to the magnitude of the color in each channel (from 0 to 255 as an 8 bit number). We can see if extracting specific channel can helps the seedling to stand out.</p>
<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/rgb.jpg" style="height:250px;" />
</figure>

<p><strong>HSV (hue, saturation, value)</strong></p>

<p>HSV is an alternative representation. The colors are encoded using 3 parameters:</p>

<ol>
  <li>Hue as an angle value 0° for red, 120° for green and 240° for blue.</li>
  <li>Saturation is the intensity of the color as a number from 0 to 1 where 0 corresponds to the grayscale.</li>
  <li>Value corresponds to the base grayscale value from 0 to 1 where 0 is black and 1 is white.</li>
</ol>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/hsv.jpg" style="height:250px;" />
</figure>

<p><strong>CIELAB</strong></p>

<p>It expresses color as three values:</p>

<ol>
  <li>L* for the lightness from black (0) to white (100)</li>
  <li>a* from green (−) to red (+)</li>
  <li>b* from blue (−) to yellow (+)</li>
</ol>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/cielab.jpg" style="height:250px;" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span> 
    <span class="sh">'</span><span class="s">Red</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Green</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Blue</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Hue</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Saturation</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Value</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Lightness</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">A: green-red</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B: blue-yellow</span><span class="sh">'</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>

    <span class="c1"># isolate first cycle cutoff
</span>    <span class="n">cutoff_num</span> <span class="o">=</span> <span class="n">cutoff_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cutoff_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span>
                               <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># isolate file numbers less that cutoff_num
</span>    <span class="n">all_file_nums</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cutoff_num</span><span class="p">)].</span><span class="nf">sort_values</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># select images at 50% of cycle
</span>    <span class="n">selected_file_num</span> <span class="o">=</span> <span class="n">all_file_nums</span><span class="p">.</span><span class="nf">quantile</span><span class="p">([</span><span class="mf">0.5</span><span class="p">]).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">).</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">image_rgb</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s">.png</span><span class="sh">'</span><span class="p">,</span> <span class="n">as_gray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pilmode</span><span class="o">=</span><span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">image_hsv</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">colors</span><span class="p">.</span><span class="nf">rgb_to_hsv</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
    <span class="n">image_lab</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="nf">rgb2lab</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
    
    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_rgb</span><span class="p">,</span> <span class="n">image_hsv</span><span class="p">,</span> <span class="n">image_lab</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">k</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">k</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">k</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[:,:,(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">RdBu</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">k</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">k</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_111_0.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">selected_image</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4535</span><span class="p">][</span><span class="sh">'</span><span class="s">full_path</span><span class="sh">'</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4535</span><span class="p">][</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4535</span><span class="p">][</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">name</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'Small-flowered Cranesbill/135'
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rgb</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">selected_image</span><span class="p">,</span> <span class="n">as_gray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pilmode</span><span class="o">=</span><span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">)</span>
<span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2HSV</span><span class="p">)</span>
<span class="n">lab</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2LAB</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
<span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>
<span class="n">l</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>

<span class="n">pixel_colors</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">.</span><span class="nf">reshape</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="nf">shape</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">shape</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="p">.</span><span class="nc">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">norm</span><span class="p">.</span><span class="nf">autoscale</span><span class="p">(</span><span class="n">pixel_colors</span><span class="p">)</span>
<span class="n">pixel_colors</span> <span class="o">=</span> <span class="nf">norm</span><span class="p">(</span><span class="n">pixel_colors</span><span class="p">).</span><span class="nf">tolist</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">g</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Red</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Green</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">b</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Red</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Blue</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">b</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Green</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Blue</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_115_0.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>

<span class="n">pixel_colors</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">.</span><span class="nf">reshape</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="nf">shape</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">shape</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="p">.</span><span class="nc">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">norm</span><span class="p">.</span><span class="nf">autoscale</span><span class="p">(</span><span class="n">pixel_colors</span><span class="p">)</span>
<span class="n">pixel_colors</span> <span class="o">=</span> <span class="nf">norm</span><span class="p">(</span><span class="n">pixel_colors</span><span class="p">).</span><span class="nf">tolist</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Hue</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Saturation</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">v</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Hue</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Value</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">v</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Saturation</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Value</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_116_0.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>

<span class="n">pixel_colors</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">.</span><span class="nf">reshape</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="nf">shape</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">shape</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="p">.</span><span class="nc">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">norm</span><span class="p">.</span><span class="nf">autoscale</span><span class="p">(</span><span class="n">pixel_colors</span><span class="p">)</span>
<span class="n">pixel_colors</span> <span class="o">=</span> <span class="nf">norm</span><span class="p">(</span><span class="n">pixel_colors</span><span class="p">).</span><span class="nf">tolist</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">a</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Lightness</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">A: Green -&gt; Red</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">b</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Lightness</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">B: Yellow -&gt; Blue</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">b</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">pixel_colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">A: Green -&gt; Red</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">B: Yellow -&gt; Blue</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_117_0.png" />
</figure>

<p><strong>Observations</strong></p>

<p>From the above image decomposition plots, the <code class="language-plaintext highlighter-rouge">Hue</code> value of the HSV decomposition seems to be a good index to help decompose the seedling from the background. We can now implement a process to automatically remove background from images.</p>

<p>In order to properly remove the background, we can start by plotting the histogram of the Hue-level for sampled images. The plot below shows 5 samples of each species at different steps of the growth cycle with the histogram of the pixel hue.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>

    <span class="c1"># isolate first cycle cutoff
</span>    <span class="n">cutoff_num</span> <span class="o">=</span> <span class="n">cutoff_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cutoff_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span>
                               <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># isolate file numbers less that cutoff_num
</span>    <span class="n">all_file_nums</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cutoff_num</span><span class="p">)].</span><span class="nf">sort_values</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">full_path</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># select images at specific quantiles of cycle
</span>    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">all_file_nums</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="sh">"</span><span class="s">lower</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">selected_file_paths</span> <span class="o">=</span> <span class="n">all_file_nums</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>

    <span class="c1"># plot images
</span>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">selected_file_paths</span><span class="p">):</span>
        <span class="n">image_rgb</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="n">as_gray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">pilmode</span><span class="o">=</span><span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># plot image, hide grid, set title
</span>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># convert image to hue
</span>        <span class="n">image_hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2HSV</span><span class="p">)</span>
        <span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">image_hsv</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">flatten</span><span class="p">(),</span>
                 <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span><span class="p">],</span>
                 <span class="n">kde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">#4CB391</span><span class="sh">"</span><span class="p">,</span> <span class="n">hist_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">alpha</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="n">norm_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_120_1.png" />
</figure>

<p><strong>Observations</strong></p>

<p>From the above plots, it appears that the hue values of the pixels cluster into two groups. From there, we could consider two approaches:</p>

<ol>
  <li>Simple: define a threshold value of around 70 to manually divide the pixels into two cluster and eliminate the potion of the image where the hue of the pixels is larger than the threshold.</li>
  <li>Complex but more suited to the various pixel distributions: <strong>for each image, cluster the hue of the pixels using a clustering algorithm and define the threshold as the boundary between the two clusters</strong>.</li>
</ol>

<p>Since we want to reach the best accuracy possible, we will implement the <strong>clustering option</strong>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cluster_pixels_lab</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">,</span> <span class="n">return_labels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    
    <span class="c1"># convert image to hsv
</span>    <span class="n">image_hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2HSV</span><span class="p">)</span>
    
    <span class="c1"># extract pixcels of Hue
</span>    <span class="n">pixels</span> <span class="o">=</span> <span class="n">image_hsv</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># create and fit KMeans
</span>    <span class="n">kmeans</span> <span class="o">=</span> <span class="nc">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">).</span><span class="nf">fit</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
    
    <span class="c1"># compute centers
</span>    <span class="n">sorted_centers</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">kmeans</span><span class="p">.</span><span class="n">cluster_centers_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># corresponding clusters
</span>    <span class="n">sorted_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="n">kmeans</span><span class="p">.</span><span class="n">cluster_centers_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">image_hsv</span><span class="p">,</span> <span class="n">sorted_centers</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">sorted_clusters</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">kmeans</span><span class="p">.</span><span class="n">labels_</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">royalblue</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gold</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">silver</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lightgreen</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mediumpurple</span><span class="sh">"</span><span class="p">]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())):</span>

    <span class="c1"># isolate first cycle cutoff
</span>    <span class="n">cutoff_num</span> <span class="o">=</span> <span class="n">cutoff_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cutoff_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span>
                               <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># isolate file numbers less that cutoff_num
</span>    <span class="n">all_file_nums</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cutoff_num</span><span class="p">)].</span><span class="nf">sort_values</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">full_path</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># select images at specific quantiles of cycle
</span>    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">all_file_nums</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                          <span class="mf">1.0</span><span class="p">,</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="sh">"</span><span class="s">lower</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">all_file_nums</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>

    <span class="c1"># read image
</span>    <span class="n">image_rgb</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">as_gray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pilmode</span><span class="o">=</span><span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># plot image, hide grid, set title
</span>    <span class="n">image_hsv</span><span class="p">,</span> <span class="n">sorted_centers</span><span class="p">,</span> <span class="n">sorted_clusters</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nf">cluster_pixels_lab</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">hist</span><span class="p">(</span><span class="n">image_hsv</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">flatten</span><span class="p">(),</span>
                                         <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">sorted_clusters</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">uint8</span><span class="p">([[[</span><span class="n">sorted_centers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">255</span><span class="p">,</span><span class="mi">175</span><span class="p">]]])</span> <span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_HSV2RGB</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span>
        <span class="n">color</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nf">tolist</span><span class="p">())</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">hist</span><span class="p">(</span><span class="n">image_hsv</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">].</span><span class="nf">flatten</span><span class="p">()[</span><span class="n">labels</span><span class="o">==</span><span class="n">k</span><span class="p">],</span>
                          <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Cluster </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, </span><span class="sh">'</span> <span class="o">+</span> <span class="sh">"</span><span class="s">{:.2f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">sorted_centers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">axvline</span><span class="p">(</span><span class="n">sorted_centers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">"</span><span class="s">--</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper right</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=1, bar_style='info', max=1), HTML(value='')))
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_123_2.png" />
</figure>

<p><strong>Observations</strong></p>

<p>From above results depicting the pixel clustering, our approach is very promising.</p>

<p>In most cases, the green color is assigned a cluster. However, for cases where the seedling consists of grass-type leaves, a cluster cannot be assigned. However, we can use the information from the clustering of the other species to come up with a threshold.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># threshold to apply on A value
</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">colormin</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="o">-</span><span class="n">sensitivity</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
<span class="n">colormax</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="o">+</span><span class="n">sensitivity</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">segment_plant</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">):</span>

    <span class="c1"># apply blur
</span>    <span class="n">blurr</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">GaussianBlur</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># convert to HSV
</span>    <span class="n">image_hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">blurr</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2HSV</span><span class="p">)</span>

    <span class="c1"># apply filters
</span>    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">image_hsv</span><span class="p">,</span> <span class="n">colormin</span><span class="p">,</span> <span class="n">colormax</span><span class="p">)</span>

    <span class="n">struc</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">morphologyEx</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">struc</span><span class="p">)</span>

    <span class="c1"># returned filtered image
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_and</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">,</span> <span class="n">image_rgb</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">mask</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scale_1</span> <span class="o">=</span> <span class="mi">224</span>
<span class="n">scale_2</span> <span class="o">=</span> <span class="mi">70</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
<span class="n">growth_cycles</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Start</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Full</span><span class="sh">'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plant</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()):</span>

    <span class="c1"># isolate first cycle cutoff
</span>    <span class="n">cutoff_num</span> <span class="o">=</span> <span class="n">cutoff_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cutoff_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span>
                               <span class="n">plant</span><span class="p">,</span> <span class="sh">'</span><span class="s">drop</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># isolate file numbers less that cutoff_num
</span>    <span class="n">all_file_nums</span> <span class="o">=</span> <span class="n">resolution_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">plant</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cutoff_num</span><span class="p">)].</span><span class="nf">sort_values</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">file_num</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">full_path</span><span class="sh">'</span><span class="p">]</span>

    <span class="c1"># select images at specific quantiles of cycle
</span>    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">all_file_nums</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                          <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="sh">"</span><span class="s">lower</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">file_paths</span> <span class="o">=</span> <span class="n">all_file_nums</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
    
        <span class="n">image_rgb</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span>
                                       <span class="n">as_gray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                       <span class="n">pilmode</span><span class="o">=</span><span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="nf">segment_plant</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
    
        <span class="n">reshape_1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">result</span><span class="p">,(</span><span class="n">scale_1</span><span class="p">,</span><span class="n">scale_1</span><span class="p">))</span>
        <span class="n">reshape_2</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">result</span><span class="p">,(</span><span class="n">scale_2</span><span class="p">,</span><span class="n">scale_2</span><span class="p">))</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">reshape_1</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">reshape_2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="n">plant</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/Growth: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">growth_cycles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Mask</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Final, ({0},{1})</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="o">*</span><span class="n">image_rgb</span><span class="p">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Final, ({0},{1})</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="o">*</span><span class="n">reshape_1</span><span class="p">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Final, ({0},{1})</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="o">*</span><span class="n">reshape_2</span><span class="p">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_128_0.png" />
</figure>

<p><strong>Observations</strong></p>

<p>Our image segmentation is now ready, the results look good with every species.</p>

<h3 id="generate-new-images">Generate New Images</h3>

<p>We are going to segment each image and save it locally by using the same folder structure as the original dataset. Once the images have been segmented, we can feed them back into the model and train the CNN again.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SAVELOCATION</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./DataAugmented_HSV_224/</span><span class="sh">'</span>

<span class="c1"># create folder
</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">SAVELOCATION</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SAVELOCATION</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SCALE</span> <span class="o">=</span> <span class="mi">224</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># extract image information
</span><span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sh">'</span><span class="s">1st loop</span><span class="sh">'</span><span class="p">):</span>

    <span class="c1"># create folder
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">SAVELOCATION</span> <span class="o">+</span> <span class="n">folder</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SAVELOCATION</span> <span class="o">+</span> <span class="n">folder</span><span class="p">)</span>

    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nf">tqdm_notebook</span><span class="p">(</span><span class="nf">listdir</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">folder</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sh">'</span><span class="s">2nd loop</span><span class="sh">'</span><span class="p">):</span>

        <span class="c1"># read image
</span>        <span class="n">image_rgb</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">ZIPEXTRACT</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nb">file</span><span class="p">,</span>
                               <span class="n">as_gray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">pilmode</span><span class="o">=</span><span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># segment image
</span>        <span class="n">masked_image</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">segment_plant</span><span class="p">(</span><span class="n">image_rgb</span><span class="p">)</span>

        <span class="c1"># resize image
</span>        <span class="n">resized_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">masked_image</span><span class="p">,</span> <span class="p">(</span><span class="n">SCALE</span><span class="p">,</span> <span class="n">SCALE</span><span class="p">))</span> 
        
        <span class="c1"># save image
</span>        <span class="n">imageio</span><span class="p">.</span><span class="nf">imwrite</span><span class="p">(</span><span class="n">SAVELOCATION</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nb">file</span><span class="p">,</span> <span class="n">resized_image</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create full path to data
</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">full_path_seg</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAVELOCATION</span> <span class="o">+</span> <span class="n">resolution_df</span><span class="p">[</span>
    <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">]</span>
<span class="n">resolution_df</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div style="overflow-x:auto;">
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>file_name</th>
      <th>species</th>
      <th>width</th>
      <th>height</th>
      <th>ratio</th>
      <th>file_num</th>
      <th>growth_lvl</th>
      <th>full_path</th>
      <th>full_path_seg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>348.png</td>
      <td>Cleavers</td>
      <td>450.0</td>
      <td>450.0</td>
      <td>1.0</td>
      <td>348</td>
      <td>1</td>
      <td>../Data/Cleavers/348.png</td>
      <td>./DataAugmented_HSV_224/Cleavers/348.png</td>
    </tr>
    <tr>
      <td>1</td>
      <td>176.png</td>
      <td>Cleavers</td>
      <td>295.0</td>
      <td>295.0</td>
      <td>1.0</td>
      <td>176</td>
      <td>2</td>
      <td>../Data/Cleavers/176.png</td>
      <td>./DataAugmented_HSV_224/Cleavers/176.png</td>
    </tr>
    <tr>
      <td>2</td>
      <td>88.png</td>
      <td>Cleavers</td>
      <td>299.0</td>
      <td>299.0</td>
      <td>1.0</td>
      <td>88</td>
      <td>2</td>
      <td>../Data/Cleavers/88.png</td>
      <td>./DataAugmented_HSV_224/Cleavers/88.png</td>
    </tr>
    <tr>
      <td>3</td>
      <td>162.png</td>
      <td>Cleavers</td>
      <td>194.0</td>
      <td>194.0</td>
      <td>1.0</td>
      <td>162</td>
      <td>3</td>
      <td>../Data/Cleavers/162.png</td>
      <td>./DataAugmented_HSV_224/Cleavers/162.png</td>
    </tr>
    <tr>
      <td>4</td>
      <td>189.png</td>
      <td>Cleavers</td>
      <td>438.0</td>
      <td>438.0</td>
      <td>1.0</td>
      <td>189</td>
      <td>1</td>
      <td>../Data/Cleavers/189.png</td>
      <td>./DataAugmented_HSV_224/Cleavers/189.png</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># batch size
</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="c1"># random seed
</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">10</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load images into a numpy array
</span><span class="n">full_set_segm</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">.</span><span class="n">notebook</span><span class="p">.</span><span class="nf">tqdm</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">full_path_seg</span><span class="sh">'</span><span class="p">]):</span>
    <span class="n">full_set_segm</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">imageio</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">as_gray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">pilmode</span><span class="o">=</span><span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">))</span>
<span class="n">full_set_segm</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">asarray</span><span class="p">(</span><span class="n">full_set_segm</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">{} images in full set.</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">full_set_segm</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HBox(children=(IntProgress(value=0, max=5539), HTML(value='')))



5539 images in full set.
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># encode target
# create encoder and fit on training set
</span><span class="n">labels</span> <span class="o">=</span> <span class="nc">LabelEncoder</span><span class="p">()</span>
<span class="n">labels</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># display target classes
</span><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Classes</span><span class="sh">'</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">))</span>

<span class="c1"># encode labels
</span><span class="n">encodedlabels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>
<span class="n">clearalllabels</span> <span class="o">=</span> <span class="n">np_utils</span><span class="p">.</span><span class="nf">to_categorical</span><span class="p">(</span><span class="n">encodedlabels</span><span class="p">)</span>

<span class="c1"># store number of classes for future use
</span><span class="n">n_classes</span> <span class="o">=</span> <span class="n">clearalllabels</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Classes['Black-grass' 'Charlock' 'Cleavers' 'Common Chickweed' 'Common wheat'
 'Fat Hen' 'Loose Silky-bent' 'Maize' 'Scentless Mayweed' 'Shepherd Purse'
 'Small-flowered Cranesbill' 'Sugar beet']
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># scale data
</span><span class="n">full_set_segm</span> <span class="o">=</span> <span class="n">full_set_segm</span> <span class="o">/</span> <span class="mf">255.</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># isolate train and test indexes
</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">full_set_segm</span><span class="p">,</span>
                                                    <span class="n">clearalllabels</span><span class="p">,</span>
                                                    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                    <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                                                    <span class="n">stratify</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># data augmentation
</span><span class="n">generator</span> <span class="o">=</span> <span class="nc">ImageDataGenerator</span><span class="p">(</span><span class="n">rotation_range</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
                               <span class="n">width_shift_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">height_shift_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">brightness_range</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                               <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">channel_shift_range</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">fill_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">nearest</span><span class="sh">'</span><span class="p">,</span>
                               <span class="n">horizontal_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">vertical_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="sh">'</span><span class="s">float32</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">Sequential</span><span class="p">()</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">SCALE</span><span class="p">,</span> <span class="n">SCALE</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Flatten</span><span class="p">())</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">())</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">relu</span><span class="sh">'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">BatchNormalization</span><span class="p">())</span>
<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Dense</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">softmax</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># optimizer
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">beta_1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">beta_2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>

<span class="c1"># define loss function
</span><span class="n">model</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="p">.</span><span class="n">categorical_crossentropy</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">acc</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># define optimization schedule with callbacks
</span><span class="n">lrate</span> <span class="o">=</span> <span class="nc">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">,</span>
                          <span class="n">factor</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                          <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="sh">"</span><span class="s">./Model_HSV_224</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./Model_HSV_224</span><span class="sh">"</span><span class="p">)</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./Model_HSV_224/weights.best_{epoch:02d}-{val_acc:.2f}.hdf5</span><span class="sh">"</span>
<span class="n">checkpoints</span> <span class="o">=</span> <span class="nc">ModelCheckpoint</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span>
                              <span class="n">monitor</span><span class="o">=</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">save_best_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                              <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">callbacks_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lrate</span><span class="p">,</span> <span class="n">checkpoints</span><span class="p">,</span> <span class="nc">TQDMNotebookCallback</span><span class="p">(</span><span class="n">leave_inner</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">leave_outer</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>

<span class="n">model</span><span class="p">.</span><span class="nf">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "sequential_2"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_9 (Conv2D)            (None, 220, 220, 32)      2432      
_________________________________________________________________
batch_normalization_11 (Batc (None, 220, 220, 32)      128       
_________________________________________________________________
conv2d_10 (Conv2D)           (None, 216, 216, 64)      51264     
_________________________________________________________________
max_pooling2d_5 (MaxPooling2 (None, 108, 108, 64)      0         
_________________________________________________________________
batch_normalization_12 (Batc (None, 108, 108, 64)      256       
_________________________________________________________________
dropout_7 (Dropout)          (None, 108, 108, 64)      0         
_________________________________________________________________
conv2d_11 (Conv2D)           (None, 104, 104, 64)      102464    
_________________________________________________________________
batch_normalization_13 (Batc (None, 104, 104, 64)      256       
_________________________________________________________________
conv2d_12 (Conv2D)           (None, 100, 100, 64)      102464    
_________________________________________________________________
max_pooling2d_6 (MaxPooling2 (None, 50, 50, 64)        0         
_________________________________________________________________
batch_normalization_14 (Batc (None, 50, 50, 64)        256       
_________________________________________________________________
dropout_8 (Dropout)          (None, 50, 50, 64)        0         
_________________________________________________________________
conv2d_13 (Conv2D)           (None, 46, 46, 128)       204928    
_________________________________________________________________
batch_normalization_15 (Batc (None, 46, 46, 128)       512       
_________________________________________________________________
conv2d_14 (Conv2D)           (None, 42, 42, 128)       409728    
_________________________________________________________________
max_pooling2d_7 (MaxPooling2 (None, 21, 21, 128)       0         
_________________________________________________________________
batch_normalization_16 (Batc (None, 21, 21, 128)       512       
_________________________________________________________________
dropout_9 (Dropout)          (None, 21, 21, 128)       0         
_________________________________________________________________
conv2d_15 (Conv2D)           (None, 17, 17, 256)       819456    
_________________________________________________________________
batch_normalization_17 (Batc (None, 17, 17, 256)       1024      
_________________________________________________________________
conv2d_16 (Conv2D)           (None, 13, 13, 256)       1638656   
_________________________________________________________________
max_pooling2d_8 (MaxPooling2 (None, 6, 6, 256)         0         
_________________________________________________________________
batch_normalization_18 (Batc (None, 6, 6, 256)         1024      
_________________________________________________________________
dropout_10 (Dropout)         (None, 6, 6, 256)         0         
_________________________________________________________________
flatten_2 (Flatten)          (None, 9216)              0         
_________________________________________________________________
dense_4 (Dense)              (None, 256)               2359552   
_________________________________________________________________
batch_normalization_19 (Batc (None, 256)               1024      
_________________________________________________________________
dropout_11 (Dropout)         (None, 256)               0         
_________________________________________________________________
dense_5 (Dense)              (None, 256)               65792     
_________________________________________________________________
batch_normalization_20 (Batc (None, 256)               1024      
_________________________________________________________________
dropout_12 (Dropout)         (None, 256)               0         
_________________________________________________________________
dense_6 (Dense)              (None, 12)                3084      
=================================================================
Total params: 5,765,836
Trainable params: 5,762,828
Non-trainable params: 3,008
_________________________________________________________________
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fit the model
</span><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">fit_generator</span><span class="p">(</span><span class="n">generator</span><span class="p">.</span><span class="nf">flow</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">),</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="n">X_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">),</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks_list</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Epoch</span> <span class="mi">1</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2341</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">2.2011</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.3446</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">7.5625</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.0776</span>  
<span class="n">Epoch</span> <span class="mi">00001</span><span class="p">:</span> <span class="n">saving</span> <span class="n">model</span> <span class="n">to</span> <span class="p">.</span><span class="o">/</span><span class="n">Model_HSV_224</span><span class="o">/</span><span class="n">weights</span><span class="p">.</span><span class="n">best_01</span><span class="o">-</span><span class="mf">0.08</span><span class="p">.</span><span class="n">hdf5</span>  
<span class="n">Epoch</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2088</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">1.4293</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.5153</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">4.6444</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.1498</span>  
<span class="n">Epoch</span> <span class="mi">00002</span><span class="p">:</span> <span class="n">saving</span> <span class="n">model</span> <span class="n">to</span> <span class="p">.</span><span class="o">/</span><span class="n">Model_HSV_224</span><span class="o">/</span><span class="n">weights</span><span class="p">.</span><span class="n">best_02</span><span class="o">-</span><span class="mf">0.15</span><span class="p">.</span><span class="n">hdf5</span>  
<span class="n">Epoch</span> <span class="mi">3</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">2077</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">1.1777</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.5972</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">4.0929</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.3159</span>  
<span class="n">Epoch</span> <span class="mi">00003</span><span class="p">:</span> <span class="n">saving</span> <span class="n">model</span> <span class="n">to</span> <span class="p">.</span><span class="o">/</span><span class="n">Model_HSV_224</span><span class="o">/</span><span class="n">weights</span><span class="p">.</span><span class="n">best_03</span><span class="o">-</span><span class="mf">0.32</span><span class="p">.</span><span class="n">hdf5</span>  
<span class="p">.</span>  
<span class="p">.</span>  
<span class="p">.</span>  
<span class="n">Epoch</span> <span class="mi">47</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">1931</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1805</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.9336</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.2560</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.9043</span>  
<span class="n">Epoch</span> <span class="mi">00047</span><span class="p">:</span> <span class="n">saving</span> <span class="n">model</span> <span class="n">to</span> <span class="p">.</span><span class="o">/</span><span class="n">Model_HSV_224</span><span class="o">/</span><span class="n">weights</span><span class="p">.</span><span class="n">best_47</span><span class="o">-</span><span class="mf">0.90</span><span class="p">.</span><span class="n">hdf5</span>  
<span class="n">Epoch</span> <span class="mi">48</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">1947</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1959</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.9316</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.2534</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.9043</span>  
<span class="n">Epoch</span> <span class="mi">00048</span><span class="p">:</span> <span class="n">saving</span> <span class="n">model</span> <span class="n">to</span> <span class="p">.</span><span class="o">/</span><span class="n">Model_HSV_224</span><span class="o">/</span><span class="n">weights</span><span class="p">.</span><span class="n">best_48</span><span class="o">-</span><span class="mf">0.90</span><span class="p">.</span><span class="n">hdf5</span>  
<span class="n">Epoch</span> <span class="mi">49</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">1947</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1805</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.9334</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.2516</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.9061</span>  
<span class="n">Epoch</span> <span class="mi">00049</span><span class="p">:</span> <span class="n">saving</span> <span class="n">model</span> <span class="n">to</span> <span class="p">.</span><span class="o">/</span><span class="n">Model_HSV_224</span><span class="o">/</span><span class="n">weights</span><span class="p">.</span><span class="n">best_49</span><span class="o">-</span><span class="mf">0.91</span><span class="p">.</span><span class="n">hdf5</span>  
<span class="n">Epoch</span> <span class="mi">50</span><span class="o">/</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">1947</span><span class="n">s</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">0.1810</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.9374</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.2566</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.9061</span>  
<span class="n">Epoch</span> <span class="mi">00050</span><span class="p">:</span> <span class="n">saving</span> <span class="n">model</span> <span class="n">to</span> <span class="p">.</span><span class="o">/</span><span class="n">Model_HSV_224</span><span class="o">/</span><span class="n">weights</span><span class="p">.</span><span class="n">best_50</span><span class="o">-</span><span class="mf">0.91</span><span class="p">.</span><span class="n">hdf5</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lr</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">lr_HSV.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">history_HSV.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">loss</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">training</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">dodgerblue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_loss</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">validation</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">crimson</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Loss function</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">epochs</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">acc</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">training</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">dodgerblue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">validation</span><span class="sh">'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">crimson</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Accuracy</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">epochs</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">accuracy</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="sh">'</span><span class="s">lr</span><span class="sh">'</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">dodgerblue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Learning Rate</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">epochs</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">learning rate</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.011</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">);</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_146_0.png" />
</figure>

<p><strong>Results</strong></p>

<p>The value of the loss functions is almost identical between the two sets once the training has stabilized. We can see that the model has reached a stable configuration as the loss function of the training set and test set both plateau after 30 epochs.</p>

<p>In addition, the accuracy of both models reach around 90%. Our initial model reached 92% accuracy on the test set. However, we saw that the model was using leakage by leverage information located in the periphery of the seedling.</p>

<h3 id="predictions-and-results-1">Predictions and Results</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Maximum accuray on validation step:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"> Epoch: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">])))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">        {:.2f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="sh">'</span><span class="s">val_acc</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Maximum accuray on validation step:
 Epoch: 34
        90.79%
</code></pre></div></div>

<p>We now load the model weights corresponding to the best accuracy on the test set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load best model
</span><span class="n">model</span><span class="p">.</span><span class="nf">load_weights</span><span class="p">(</span><span class="sh">"</span><span class="s">./Model_HSV_224/weights.best_34-0.91.hdf5</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>We now make predictions on the train and test sets.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4985/4985 [==============================] - 779s 156ms/step
554/554 [==============================] - 81s 146ms/step
</code></pre></div></div>

<p>Similar to the first model, we can plot the confusion matrices for both the training and test sets.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Training Data</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">TAD_tools_v01</span><span class="p">.</span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">y_train_pred</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">,</span>
                                    <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">Oranges</span><span class="p">,</span>
                                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mf">11.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Training Data
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_155_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Test Data</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">TAD_tools_v01</span><span class="p">.</span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">y_test_pred</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">,</span>
                                    <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">Greens</span><span class="p">,</span>
                                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mf">11.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test Data
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_156_1.png" />
</figure>

<p><strong>Observations</strong></p>

<p>From the above, we can clearly see that our model has lost some accuracy on the Black-grass class. The class accuracy is not only 0.51 and 0.39 for the training and test sets respectively. However, the model has improved its predictions on the other classes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Accurancy:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Train: {:.2f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_train_pred</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Test:  {:.2f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_test_pred</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">F1-score</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Train: {:.3f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_train_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="sh">'</span><span class="s">weighted</span><span class="sh">'</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   Test:  {:.3f}%</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="sh">'</span><span class="s">weighted</span><span class="sh">'</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Classification Report</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">classification_report</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_train_pred</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="nf">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_test_pred</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Accurancy:
   Train: 91.65%
   Test:  90.79%

F1-score
   Train: 91.536%
   Test:  90.790%

Classification Report
              precision    recall  f1-score   support

           0       0.57      0.51      0.54       278
           1       0.86      0.98      0.91       407
           2       1.00      0.78      0.87       301
           3       0.98      0.99      0.98       642
           4       0.91      0.98      0.94       228
           5       0.98      0.98      0.98       484
           6       0.82      0.85      0.84       686
           7       0.87      0.99      0.93       231
           8       0.99      0.93      0.96       546
           9       0.98      0.91      0.95       247
          10       1.00      0.99      0.99       518
          11       0.94      0.97      0.95       417

    accuracy                           0.92      4985
   macro avg       0.91      0.90      0.90      4985
weighted avg       0.92      0.92      0.92      4985

              precision    recall  f1-score   support

           0       0.40      0.39      0.39        31
           1       0.98      0.98      0.98        45
           2       1.00      0.97      0.99        34
           3       1.00      0.97      0.99        71
           4       0.88      0.92      0.90        25
           5       0.96      0.98      0.97        54
           6       0.80      0.80      0.80        76
           7       0.81      1.00      0.90        26
           8       1.00      0.92      0.96        61
           9       0.93      0.93      0.93        27
          10       1.00      1.00      1.00        58
          11       0.91      0.93      0.92        46

    accuracy                           0.91       554
   macro avg       0.89      0.90      0.89       554
weighted avg       0.91      0.91      0.91       554
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># isolate train and test indexes as dataframe
</span><span class="n">df_X_train</span><span class="p">,</span> <span class="n">df_X_test</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">resolution_df</span><span class="p">,</span>
                                                    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                    <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                                                    <span class="n">stratify</span><span class="o">=</span><span class="n">resolution_df</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># add predictions to dataframe
</span><span class="n">df_X_train</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="sh">'</span><span class="s">prediction_HSV</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">[</span><span class="n">y_train_pred</span><span class="p">]</span>
<span class="n">df_X_test</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="sh">'</span><span class="s">prediction_HSV</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">classes_</span><span class="p">[</span><span class="n">y_test_pred</span><span class="p">]</span>

<span class="c1"># define if prediction is correct
</span><span class="n">df_X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_X_train</span><span class="p">[</span><span class="sh">'</span><span class="s">prediction_HSV</span><span class="sh">'</span><span class="p">]</span>
<span class="n">df_X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_X_test</span><span class="p">[</span><span class="sh">'</span><span class="s">prediction_HSV</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># group predictions by growth-phase and species
</span><span class="n">df_X_train</span> <span class="o">=</span> <span class="n">df_X_train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">df_X_train</span> <span class="o">=</span> <span class="n">df_X_train</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="sh">"</span><span class="s">species</span><span class="sh">"</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">)</span>

<span class="n">df_X_test</span> <span class="o">=</span> <span class="n">df_X_test</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">species</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">df_X_test</span> <span class="o">=</span> <span class="n">df_X_test</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sh">'</span><span class="s">growth_lvl</span><span class="sh">'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="sh">"</span><span class="s">species</span><span class="sh">"</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="sh">'</span><span class="s">correct</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Training set:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">df_X_train</span><span class="p">.</span><span class="nf">reindex</span><span class="p">(</span><span class="n">CLUSTER_ORDER</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdYlGn</span><span class="sh">'</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">fontsize</span><span class="sh">"</span><span class="p">:</span><span class="mi">12</span><span class="p">},</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">"</span><span class="s">right</span><span class="sh">"</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="sh">"</span><span class="s">anchor</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Training set:
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_160_1.png" />
</figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Test set:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">df_X_test</span><span class="p">.</span><span class="nf">reindex</span><span class="p">(</span><span class="n">CLUSTER_ORDER</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdYlGn</span><span class="sh">'</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">fontsize</span><span class="sh">"</span><span class="p">:</span><span class="mi">12</span><span class="p">},</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">"</span><span class="s">right</span><span class="sh">"</span><span class="p">,</span><span class="n">rotation_mode</span><span class="o">=</span><span class="sh">"</span><span class="s">anchor</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test set:
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_161_1.png" />
</figure>

<h3 id="final-model-inspection">Final Model Inspection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>

<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>

        <span class="c1"># isolate species
</span>        <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">n_classes</span><span class="p">)[</span><span class="n">m</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># find examples of the species
</span>        <span class="n">idxes</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">spec</span>
        
        <span class="c1"># isolate image
</span>        <span class="n">filtered_images</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">idxes</span><span class="p">,...]</span>
        
        <span class="c1"># random image
</span>        <span class="n">image</span> <span class="o">=</span> <span class="n">filtered_images</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">filtered_images</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],...]</span>

        <span class="c1"># make prediction
</span>        <span class="n">test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">,...],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># generate explanations
</span>        <span class="n">explainer</span> <span class="o">=</span> <span class="n">lime_image</span><span class="p">.</span><span class="nc">LimeImageExplainer</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">.</span><span class="nf">explain_instance</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="n">model</span><span class="p">.</span><span class="n">predict_proba</span><span class="p">,</span>  <span class="c1"># classification function
</span>            <span class="n">top_labels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">hide_color</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="mi">286</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">explanation</span><span class="p">.</span><span class="nf">get_image_and_mask</span><span class="p">(</span><span class="n">explanation</span><span class="p">.</span><span class="n">top_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">positive_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                    <span class="n">num_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                    <span class="n">hide_rest</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">img_boundry1</span> <span class="o">=</span> <span class="nf">mark_boundaries</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                
        <span class="c1"># convert label to species name
</span>        <span class="n">predicted_species</span> <span class="o">=</span> <span class="n">id_class_mapping</span><span class="p">[</span><span class="n">test_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        
        <span class="c1"># plot results
</span>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">img_boundry1</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">true </span><span class="sh">"</span> <span class="o">+</span> <span class="n">id_class_mapping</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="s"> predicted: </span><span class="sh">"</span> <span class="o">+</span>
                           <span class="n">predicted_species</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<figure>
<img src="https://tdody.github.io/assets/img/2020-02-13-Seedlings-Classification/output_163_1.png" />
</figure>

<h3 id="conclusion">Conclusion</h3>

<p>In conclusion, we were able to produce a model relying only on the shape, size, and colors of the seedlings. This model is capable of making correct predictions more than 90% of the times on 12 different seedling species. If we were to improve this model and its data collection, the following recommendations would be proposed:</p>

<ol>
  <li>Standardize photographs by taking pictures from the same distance, same focus.</li>
  <li>Build a model to classify the Loose-Silky bent and Black-grass together then develop a model specifically to classify these two species.</li>
  <li>Collect information regarding the importance of misclassification of certain species. Weights can then be incorporated in the model.</li>
</ol>
